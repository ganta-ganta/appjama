<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jama - Complete Agricultural Management System</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2e7d32">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŒ±</text></svg>">
    
    <!-- External Dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* CSS Custom Properties with Dark Mode Support */
        :root {
            --primary: #2e7d32;
            --primary-light: #4caf50;
            --primary-dark: #1b5e20;
            --secondary: #ffa000;
            --secondary-light: #ffc107;
            --secondary-dark: #ff6f00;
            --accent: #00acc1;
            --accent-light: #26c6da;
            --success: #388e3c;
            --warning: #f57c00;
            --danger: #d32f2f;
            --info: #1976d2;
            --gray: #78909c;
            --gray-light: #b0bec5;
            --gray-dark: #455a64;
            
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-muted: #999999;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --border-color: #dee2e6;
            --border-radius: 12px;
            --border-radius-small: 8px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --box-shadow-large: 0 8px 24px rgba(0, 0, 0, 0.15);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Dark Mode Variables */
        [data-theme="dark"] {
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --text-muted: #808080;
            --bg-primary: #1e1e1e;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3d3d3d;
            --border-color: #404040;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            --box-shadow-large: 0 8px 24px rgba(0, 0, 0, 0.4);
            
            --primary: #4caf50;
            --primary-light: #66bb6a;
            --primary-dark: #2e7d32;
            --secondary: #ffc107;
            --secondary-light: #ffd54f;
            --gray: #90a4ae;
            --gray-light: #b0bec5;
        }

        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: var(--transition);
        }

        /* App Container */
        .app-container {
            width: 100%;
            max-width: 100vw;
            min-height: 100vh;
            position: relative;
            background: var(--bg-secondary);
        }

        /* Minimized Header */
        .mini-header {
            background: var(--primary);
            color: white;
            padding: 0.5rem 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--box-shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mini-header.hidden {
            display: none;
        }

        .logo-mini {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-mini i {
            font-size: 1.2rem;
        }

        .logo-mini h1 {
            font-weight: 700;
            font-size: 1.2rem;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .theme-toggle {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem;
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition);
        }

        .theme-toggle:hover {
            background: rgba(255,255,255,0.3);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        /* Notification Banner */
        .notification-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--warning), var(--secondary));
            color: white;
            padding: 12px;
            text-align: center;
            z-index: 2000;
            transform: translateY(-100%);
            transition: var(--transition);
            font-weight: 600;
            font-size: 0.9rem;
            box-shadow: var(--box-shadow);
        }

        .notification-banner.show {
            transform: translateY(0);
        }

        .close-notification {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px;
            border-radius: 50%;
            transition: var(--transition);
        }

        .close-notification:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Content Container */
        .content-container {
            padding: 0.5rem;
            padding-bottom: 90px;
            min-height: calc(100vh - 60px);
        }

        .content-container.no-nav {
            padding-bottom: 1rem;
            min-height: 100vh;
        }

        /* Authentication Styles */
        .auth-container {
            max-width: 400px;
            margin: 2rem auto;
            padding: 1rem;
        }

        .welcome-section {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem 1rem;
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .welcome-section .logo {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .welcome-section h1 {
            color: var(--primary-dark);
            margin-bottom: 0.5rem;
            font-size: 2rem;
            font-weight: 800;
        }

        .welcome-section p {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .auth-tabs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: 0.5rem;
            box-shadow: var(--box-shadow);
        }

        .auth-tab {
            padding: 1rem 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border-radius: var(--border-radius-small);
            font-weight: 600;
            font-size: 0.9rem;
            background: transparent;
            color: var(--text-secondary);
            border: 2px solid transparent;
        }

        .auth-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary-dark);
            transform: scale(1.05);
        }

        .auth-tab:hover:not(.active) {
            background: var(--bg-tertiary);
            transform: scale(1.02);
        }

        .auth-form {
            display: none;
            background: var(--bg-primary);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
        }

        .auth-form.active {
            display: block;
            animation: fadeInUp 0.4s ease-out;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: inherit;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
        }

        .form-control:invalid {
            border-color: var(--danger);
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .input-group .form-control {
            flex: 1;
        }

        /* Button Styles */
        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            font-family: inherit;
            position: relative;
            overflow: hidden;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--box-shadow-large);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-light));
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #4caf50);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #f44336);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), var(--secondary));
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info), #2196f3);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover:not(:disabled) {
            background: var(--primary);
            color: white;
        }

        .btn-full {
            width: 100%;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.8rem;
        }

        /* Message Styles */
        .message {
            padding: 16px 20px;
            border-radius: var(--border-radius);
            margin: 1rem 0;
            text-align: center;
            font-weight: 500;
            display: none;
            transition: var(--transition);
        }

        .error-message {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            color: var(--danger);
            border-left: 4px solid var(--danger);
        }

        .success-message {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            color: var(--success);
            border-left: 4px solid var(--success);
        }

        .warning-message {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            color: var(--warning);
            border-left: 4px solid var(--warning);
        }

        /* Dashboard Cards */
        .dashboard-card {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: var(--transition);
            border: 1px solid var(--border-color);
        }

        .dashboard-card:hover {
            box-shadow: var(--box-shadow-large);
            transform: translateY(-2px);
        }

        /* Financial Summary */
        .financial-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .financial-item {
            text-align: center;
            padding: 1.5rem 1rem;
            border-radius: var(--border-radius);
            background: var(--bg-primary);
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .financial-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--gray);
        }

        .financial-item.income::before {
            background: linear-gradient(90deg, var(--success), #4caf50);
        }

        .financial-item.expense::before {
            background: linear-gradient(90deg, var(--danger), #f44336);
        }

        .financial-item.profit::before {
            background: linear-gradient(90deg, var(--secondary), var(--secondary-light));
        }

        .financial-item.loan::before {
            background: linear-gradient(90deg, var(--info), #2196f3);
        }

        .financial-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--box-shadow-large);
        }

        .financial-value {
            font-size: 1.4rem;
            font-weight: 800;
            margin: 0.5rem 0;
            color: var(--text-primary);
        }

        .financial-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Crop Cards with Individual Tabs */
        .crop-container {
            margin-bottom: 1rem;
        }

        .crop-card {
            background: var(--bg-primary);
            border: 2px solid var(--primary);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
        }

        .crop-card.expanded {
            border-color: var(--primary-dark);
            box-shadow: var(--box-shadow-large);
        }

        .crop-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 1rem;
            cursor: pointer;
            position: relative;
        }

        .crop-header:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
        }

        .crop-basic-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .crop-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .crop-subtitle {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-top: 0.2rem;
        }

        .crop-status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            background: rgba(255,255,255,0.2);
        }

        .expand-icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            transition: var(--transition);
        }

        .crop-card.expanded .expand-icon {
            transform: translateY(-50%) rotate(180deg);
        }

        .crop-content {
            display: none;
            padding: 1.5rem;
            background: var(--bg-primary);
            border-top: 1px solid var(--border-color);
        }

        .crop-content.active {
            display: block;
            animation: fadeInDown 0.4s ease-out;
        }

        /* Progress Bar */
        .progress-container {
            margin: 1rem 0;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            transition: width 0.6s ease;
            border-radius: 4px;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        /* Crop Management Tabs */
        .crop-tabs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .crop-tab {
            padding: 0.75rem 0.5rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-small);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .crop-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary-dark);
        }

        .crop-tab:hover:not(.active) {
            background: var(--bg-tertiary);
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Weather Widget */
        .weather-widget {
            background: linear-gradient(135deg, #87CEEB, #4682B4);
            color: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1rem;
            position: relative;
            overflow: hidden;
        }

        .weather-widget::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 100px;
            height: 100px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }

        .weather-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            position: relative;
        }

        .weather-main {
            text-align: center;
        }

        .weather-temp {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .weather-desc {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .weather-details {
            font-size: 0.85rem;
        }

        .weather-details div {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        /* Insurance Cards */
        .insurance-card {
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
            transition: var(--transition);
        }

        .insurance-card.active {
            border-color: var(--success);
            background: rgba(56, 142, 60, 0.1);
        }

        .insurance-card.recommended {
            border-color: var(--warning);
            background: rgba(255, 160, 0, 0.1);
        }

        .insurance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .insurance-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .insurance-badge.government {
            background: var(--info);
            color: white;
        }

        .insurance-badge.private {
            background: var(--secondary);
            color: white;
        }

        .insurance-badge.secured {
            background: var(--success);
            color: white;
        }

        /* Innovation Cards */
        .innovation-card {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .innovation-card:hover {
            box-shadow: var(--box-shadow-large);
            transform: translateY(-2px);
        }

        .innovation-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .innovation-icon {
            width: 50px;
            height: 50px;
            border-radius: var(--border-radius-small);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .innovation-icon.crop-care {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
        }

        .innovation-icon.farming {
            background: linear-gradient(135deg, #ff9800, #ffb74d);
        }

        .innovation-icon.insurance {
            background: linear-gradient(135deg, #2196f3, #42a5f5);
        }

        .innovation-icon.machinery {
            background: linear-gradient(135deg, #9c27b0, #ba68c8);
        }

        .subsidy-info {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid var(--success);
            border-radius: var(--border-radius-small);
            padding: 0.75rem;
            margin-top: 1rem;
        }

        .subsidy-available {
            color: var(--success);
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* Mobile Navigation */
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            backdrop-filter: blur(10px);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            border-top: 1px solid var(--border-color);
            z-index: 1000;
        }

        .mobile-nav.hidden {
            display: none;
        }

        .nav-container {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.25rem;
            padding: 0.5rem;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.75rem 0.5rem;
            text-decoration: none;
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-weight: 600;
            transition: var(--transition);
            border-radius: var(--border-radius-small);
            position: relative;
        }

        .nav-item.active {
            color: var(--primary);
            background: rgba(46, 125, 50, 0.1);
        }

        .nav-item:hover:not(.active) {
            color: var(--primary-light);
            background: rgba(46, 125, 50, 0.05);
        }

        .nav-item i {
            font-size: 1.2rem;
            margin-bottom: 0.25rem;
        }

        .notification-dot {
            position: absolute;
            top: 0.25rem;
            right: 0.5rem;
            width: 8px;
            height: 8px;
            background: var(--danger);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        /* Quick Access Floating Button */
        .quick-access {
            position: fixed;
            bottom: 90px;
            right: 1rem;
            z-index: 1000;
        }

        .quick-access.hidden {
            display: none;
        }

        .fab-main {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary), var(--secondary-light));
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(255, 160, 0, 0.4);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab-main:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(255, 160, 0, 0.5);
        }

        .fab-menu {
            position: absolute;
            bottom: 70px;
            right: 0;
            display: none;
            flex-direction: column;
            gap: 0.5rem;
        }

        .fab-menu.active {
            display: flex;
            animation: fadeInUp 0.3s ease-out;
        }

        .fab-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: var(--bg-primary);
            padding: 0.75rem 1rem;
            border-radius: 25px;
            box-shadow: var(--box-shadow);
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--border-color);
        }

        .fab-item:hover {
            transform: translateX(-5px);
            box-shadow: var(--box-shadow-large);
        }

        .fab-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.9rem;
        }

        .fab-text {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            backdrop-filter: blur(3px);
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            background: var(--bg-primary);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            width: 95%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--box-shadow-large);
            border: 1px solid var(--border-color);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-header h3 {
            color: var(--text-primary);
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: var(--transition);
            padding: 5px;
            border-radius: 50%;
        }

        .modal-close:hover {
            color: var(--danger);
            background: rgba(211, 47, 47, 0.1);
        }

        /* Transaction Items */
        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-small);
            margin-bottom: 0.75rem;
            transition: var(--transition);
        }

        .transaction-item:hover {
            background: var(--bg-secondary);
            transform: translateX(5px);
            box-shadow: var(--box-shadow);
        }

        .transaction-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }

        .transaction-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .transaction-icon.income {
            background: rgba(56, 142, 60, 0.1);
            color: var(--success);
        }

        .transaction-icon.expense {
            background: rgba(211, 47, 47, 0.1);
            color: var(--danger);
        }

        .transaction-details {
            flex: 1;
        }

        .transaction-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .transaction-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .transaction-amount {
            text-align: right;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .transaction-amount.income {
            color: var(--success);
        }

        .transaction-amount.expense {
            color: var(--danger);
        }

        .transaction-amount.loan {
            color: var(--info);
        }

        /* Calendar Styles */
        .calendar-container {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 1rem;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--primary);
            color: white;
        }

        .calendar-nav {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem;
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition);
        }

        .calendar-nav:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .year-display {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .months-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
            padding: 1rem;
        }

        .month-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-small);
            padding: 1rem 0.75rem;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }

        .month-card:hover {
            border-color: var(--primary);
            background: var(--bg-primary);
            transform: translateY(-2px);
            box-shadow: var(--box-shadow);
        }

        .month-card.active {
            border-color: var(--primary);
            background: rgba(46, 125, 50, 0.1);
        }

        .month-card.has-activities {
            border-color: var(--success);
        }

        .month-name {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .month-activities {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .activity-indicators {
            display: flex;
            justify-content: center;
            gap: 4px;
            margin-top: 0.5rem;
        }

        .activity-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .activity-dot.crop { background: var(--success); }
        .activity-dot.transaction { background: var(--secondary); }
        .activity-dot.maintenance { background: var(--info); }
        .activity-dot.urgent { background: var(--danger); }

        /* Smart Suggestions */
        .suggestion-card {
            background: var(--bg-primary);
            border-left: 4px solid var(--warning);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
        }

        .suggestion-card:hover {
            transform: translateX(5px);
            box-shadow: var(--box-shadow-large);
        }

        .suggestion-card.urgent {
            border-left-color: var(--danger);
            background: rgba(211, 47, 47, 0.05);
        }

        .suggestion-card.high {
            border-left-color: var(--warning);
        }

        .suggestion-card.medium {
            border-left-color: var(--info);
        }

        .suggestion-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .suggestion-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .suggestion-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .suggestion-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .suggestion-action {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-style: italic;
        }

        .priority-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            padding: 0.25rem 0.5rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-badge.urgent {
            background: var(--danger);
            color: white;
        }

        .priority-badge.high {
            background: var(--warning);
            color: white;
        }

        .priority-badge.medium {
            background: var(--info);
            color: white;
        }

        /* Grid Layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.8rem;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.6rem;
        }

        /* OTP Styles */
        .otp-container {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin: 1.5rem 0;
        }

        .otp-input {
            width: 45px !important;
            height: 45px;
            text-align: center !important;
            font-size: 1.2rem !important;
            font-weight: 700;
            border-radius: var(--border-radius-small) !important;
        }

        .otp-input:focus {
            transform: scale(1.05);
        }

        /* Crop SVG Icons */
        .crop-svg {
            width: 40px;
            height: 40px;
            margin-right: 0.5rem;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        @keyframes fadeInDown {
            from { 
                opacity: 0; 
                transform: translateY(-20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(5deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .content-container {
                padding: 0.25rem;
                padding-bottom: 90px;
            }

            .financial-summary {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }

            .grid-3 {
                grid-template-columns: repeat(2, 1fr);
            }

            .grid-4 {
                grid-template-columns: repeat(3, 1fr);
            }

            .months-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .modal-content {
                width: 98%;
                margin: 1%;
                padding: 1rem;
            }

            .nav-container {
                grid-template-columns: repeat(4, 1fr);
            }

            .nav-item {
                font-size: 0.7rem;
                padding: 0.5rem 0.25rem;
            }

            .nav-item i {
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            .financial-summary {
                grid-template-columns: 1fr;
            }

            .grid-2 {
                grid-template-columns: 1fr;
            }

            .months-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .crop-tabs {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Print Styles */
        @media print {
            .mobile-nav,
            .quick-access,
            .modal,
            .notification-banner {
                display: none !important;
            }

            .content-container {
                padding-bottom: 0;
            }
        }

        /* Hide elements during auth */
        .auth-mode .mobile-nav,
        .auth-mode .quick-access {
            display: none !important;
        }

        /* Language Switching Styles */
        .language-content {
            display: none;
        }

        .language-content.active {
            display: block;
        }

        /* Dark mode specific fixes */
        [data-theme="dark"] .auth-form {
            background: var(--bg-secondary);
        }

        [data-theme="dark"] .auth-tabs {
            background: var(--bg-secondary);
        }

        [data-theme="dark"] .welcome-section {
            background: var(--bg-secondary);
        }

        [data-theme="dark"] .crop-content {
            background: var(--bg-secondary);
        }

        [data-theme="dark"] .modal-content {
            background: var(--bg-secondary);
        }

        [data-theme="dark"] .chart-container {
            background: var(--bg-secondary);
        }

        [data-theme="dark"] canvas {
            background: var(--bg-primary) !important;
        }
    </style>
</head>
<body data-theme="light">
    <!-- App Container with Auth Mode Class -->
    <div class="app-container auth-mode" id="appContainer">
        <!-- Minimized Header (Hidden during auth) -->
        <div class="mini-header hidden" id="miniHeader">
            <div class="logo-mini">
                <i class="fas fa-leaf"></i>
                <h1>Jama</h1>
            </div>
            <div class="header-controls">
                <button class="theme-toggle" id="themeToggle">
                    <i class="fas fa-moon"></i>
                </button>
                <div class="user-info" id="userInfo">
                    <i class="fas fa-user"></i>
                    <span id="headerUserName">Farmer</span>
                </div>
            </div>
        </div>

        <!-- Notification Banner -->
        <div class="notification-banner" id="notificationBanner">
            <span id="notificationText"></span>
            <button class="close-notification" onclick="closeNotification()">Ã—</button>
        </div>

        <!-- Status Messages -->
        <div class="error-message message" id="errorMessage"></div>
        <div class="success-message message" id="successMessage"></div>
        <div class="warning-message message" id="warningMessage"></div>

        <!-- Authentication Page -->
        <div id="authPage" class="content-container no-nav">
            <div class="auth-container">
                <div class="welcome-section">
                    <div class="logo">
                        <i class="fas fa-leaf"></i>
                    </div>
                    <h1>Jama</h1>
                    <p>Your complete agricultural management companion</p>
                </div>

                <div class="auth-tabs">
                    <div class="auth-tab active" data-auth="email">
                        <i class="fas fa-envelope"></i><br>Email
                    </div>
                    <div class="auth-tab" data-auth="phone">
                        <i class="fas fa-mobile-alt"></i><br>Phone
                    </div>
                    <div class="auth-tab" data-auth="google">
                        <i class="fab fa-google"></i><br>Google
                    </div>
                </div>

                <!-- Email Authentication -->
                <div class="auth-form active" id="emailAuth">
                    <div class="form-group">
                        <label><i class="fas fa-envelope"></i> Email Address</label>
                        <input type="email" class="form-control" id="email" placeholder="farmer@example.com" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-lock"></i> Password</label>
                        <input type="password" class="form-control" id="password" placeholder="Enter your password" required>
                    </div>
                    <button class="btn btn-primary btn-full" id="emailLoginBtn">
                        <i class="fas fa-sign-in-alt"></i> Login with Email
                    </button>
                    <button class="btn btn-outline btn-full" id="emailRegisterBtn" style="margin-top: 1rem;">
                        <i class="fas fa-user-plus"></i> Create New Account
                    </button>
                </div>

                <!-- Phone Authentication -->
                <div class="auth-form" id="phoneAuth">
                    <div class="form-group">
                        <label><i class="fas fa-mobile-alt"></i> Phone Number</label>
                        <div class="input-group">
                            <select class="form-control" id="countryCode" style="max-width: 100px;">
                                <option value="+91">ðŸ‡®ðŸ‡³ +91</option>
                                <option value="+1">ðŸ‡ºðŸ‡¸ +1</option>
                                <option value="+44">ðŸ‡¬ðŸ‡§ +44</option>
                            </select>
                            <input type="tel" class="form-control" id="phoneNumber" placeholder="9876543210" required>
                        </div>
                    </div>
                    <div id="recaptcha-container"></div>
                    <button class="btn btn-primary btn-full" id="sendOtpBtn">
                        <i class="fas fa-paper-plane"></i> Send OTP
                    </button>
                </div>

                <!-- Google Authentication -->
                <div class="auth-form" id="googleAuth">
                    <div style="text-align: center; padding: 2rem 0;">
                        <i class="fab fa-google" style="font-size: 3rem; color: #4285f4; margin-bottom: 1rem;"></i>
                        <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Quick Sign In</h3>
                        <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">Use your Google account for instant access</p>
                        <button class="btn btn-info btn-full" id="googleSignInBtn">
                            <i class="fab fa-google"></i> Continue with Google
                        </button>
                    </div>
                </div>

                <!-- OTP Verification -->
                <div class="auth-form" id="otpVerification">
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <i class="fas fa-mobile-alt" style="font-size: 2.5rem; color: var(--primary); margin-bottom: 1rem;"></i>
                        <h3 style="color: var(--text-primary); margin-bottom: 0.5rem;">Verify Phone Number</h3>
                        <p style="color: var(--text-secondary);">Enter OTP sent to <span id="phoneDisplay" style="font-weight: 600;"></span></p>
                    </div>
                    
                    <div class="otp-container">
                        <input type="text" class="form-control otp-input" maxlength="1" inputmode="numeric">
                        <input type="text" class="form-control otp-input" maxlength="1" inputmode="numeric">
                        <input type="text" class="form-control otp-input" maxlength="1" inputmode="numeric">
                        <input type="text" class="form-control otp-input" maxlength="1" inputmode="numeric">
                        <input type="text" class="form-control otp-input" maxlength="1" inputmode="numeric">
                        <input type="text" class="form-control otp-input" maxlength="1" inputmode="numeric">
                    </div>
                    
                    <div style="text-align: center; margin: 1rem 0;">
                        <span style="font-weight: 600; color: var(--primary); font-size: 1.1rem;" id="countdown">02:00</span><br>
                        <small style="color: var(--text-muted);">Time remaining</small>
                    </div>
                    
                    <button class="btn btn-primary btn-full" id="verifyOtpBtn">
                        <i class="fas fa-check-circle"></i> Verify OTP
                    </button>
                    <button class="btn btn-outline btn-full" id="backToPhoneBtn" style="margin-top: 1rem;">
                        <i class="fas fa-arrow-left"></i> Back to Phone
                    </button>
                </div>
            </div>
        </div>

        <!-- Registration Page -->
        <div id="registrationPage" class="content-container no-nav" style="display: none;">
            <div style="max-width: 500px; margin: 0 auto;">
                <div style="text-align: center; margin-bottom: 2rem; padding: 1.5rem; background: var(--bg-primary); border-radius: var(--border-radius); box-shadow: var(--box-shadow);">
                    <i class="fas fa-user-plus" style="font-size: 2.5rem; color: var(--primary); margin-bottom: 1rem;"></i>
                    <h2 style="color: var(--text-primary); margin-bottom: 0.5rem;">Complete Your Profile</h2>
                    <p style="color: var(--text-secondary);">Setup your farm management system</p>
                </div>

                <div class="dashboard-card">
                    <div class="form-group">
                        <label><i class="fas fa-user"></i> Full Name</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="regFirstName" placeholder="First Name" required>
                            <input type="text" class="form-control" id="regLastName" placeholder="Last Name" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-map-marker-alt"></i> Farm Location</label>
                        <input type="text" class="form-control" id="regFarmLocation" placeholder="Village, District, State" required>
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-expand-arrows-alt"></i> Total Farm Size</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="regFarmAcres" placeholder="Acres" min="0" step="0.1" required>
                            <input type="number" class="form-control" id="regFarmCents" placeholder="Cents" min="0" max="99">
                        </div>
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-seedling"></i> Primary Crops</label>
                        <div class="grid-3" id="primaryCropsGrid">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-phone"></i> Alternative Contact</label>
                        <input type="tel" class="form-control" id="regAltPhone" placeholder="Alternative phone number">
                    </div>

                    <button class="btn btn-primary btn-full" id="completeRegistrationBtn">
                        <i class="fas fa-check-circle"></i> Complete Registration
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div id="dashboardPage" class="content-container" style="display: none;">
            <!-- Home Tab -->
            <div class="tab-content active" id="home-tab">
                <!-- Quick Financial Overview -->
                <div class="financial-summary">
                    <div class="financial-item income">
                        <div class="financial-label">Total Income</div>
                        <div class="financial-value" id="totalIncome">â‚¹0</div>
                    </div>
                    <div class="financial-item expense">
                        <div class="financial-label">Total Expenses</div>
                        <div class="financial-value" id="totalExpenses">â‚¹0</div>
                    </div>
                    <div class="financial-item profit">
                        <div class="financial-label">Net Profit</div>
                        <div class="financial-value" id="netProfit">â‚¹0</div>
                    </div>
                    <div class="financial-item loan">
                        <div class="financial-label">Active Loans</div>
                        <div class="financial-value" id="activeLoans">â‚¹0</div>
                    </div>
                </div>

                <!-- Location Weather Widget -->
                <div class="weather-widget" id="weatherWidget">
                    <h3><i class="fas fa-cloud-sun"></i> <span id="weatherLocation">Farm Weather</span></h3>
                    <div class="weather-info">
                        <div class="weather-main">
                            <div class="weather-temp" id="weatherTemp">--Â°C</div>
                            <div class="weather-desc" id="weatherDesc">Loading...</div>
                        </div>
                        <div class="weather-details">
                            <div><span>Humidity:</span> <span id="weatherHumidity">--%</span></div>
                            <div><span>Wind:</span> <span id="weatherWind">-- km/h</span></div>
                            <div><span>Rainfall:</span> <span id="weatherRain">-- mm</span></div>
                        </div>
                    </div>
                </div>

                <!-- Smart Suggestions -->
                <div class="dashboard-card">
                    <h3><i class="fas fa-lightbulb"></i> Smart Farm Insights</h3>
                    <div id="smartSuggestions">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Monthly Mandates -->
                <div class="dashboard-card">
                    <h3><i class="fas fa-calendar-check"></i> This Month's Critical Tasks</h3>
                    <div id="monthlyMandates">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Quick Calendar Overview -->
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="calendar-nav" onclick="changeYear(-1)">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <div class="year-display" id="currentYear">2025</div>
                        <button class="calendar-nav" onclick="changeYear(1)">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    <div class="months-grid" id="monthsGrid">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Month Details -->
                <div class="dashboard-card" id="monthDetails" style="display: none;">
                    <h3><i class="fas fa-calendar-day"></i> <span id="selectedMonthName">Month</span> Activities</h3>
                    <div id="monthActivities">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Crops Tab -->
            <div class="tab-content" id="crops-tab">
                <div style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2 style="color: var(--text-primary);">
                            <i class="fas fa-seedling"></i> Crop Management
                        </h2>
                        <button class="btn btn-success btn-small" onclick="addNewCrop()">
                            <i class="fas fa-plus"></i> Add Crop
                        </button>
                    </div>
                    
                    <!-- Crop Summary -->
                    <div class="financial-summary">
                        <div class="financial-item">
                            <div class="financial-label">Active Crops</div>
                            <div class="financial-value" id="activeCropsCount">0</div>
                        </div>
                        <div class="financial-item">
                            <div class="financial-label">Total Area</div>
                            <div class="financial-value" id="totalCropArea">0 Acres</div>
                        </div>
                        <div class="financial-item">
                            <div class="financial-label">Expected Harvest</div>
                            <div class="financial-value" id="expectedHarvest">0 Qt</div>
                        </div>
                        <div class="financial-item">
                            <div class="financial-label">Projected Revenue</div>
                            <div class="financial-value" id="projectedRevenue">â‚¹0</div>
                        </div>
                    </div>
                </div>

                <!-- Individual Crop Cards -->
                <div id="cropsContainer">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Integrated Money & Loans Tab -->
            <div class="tab-content" id="money-tab">
                <!-- Financial Overview -->
                <div class="dashboard-card">
                    <h3><i class="fas fa-chart-line"></i> Financial Overview</h3>
                    <div class="chart-container" style="background: transparent; box-shadow: none; padding: 0;">
                        <canvas id="financialChart" style="background: var(--bg-primary); border-radius: 8px;"></canvas>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="grid-2" style="margin-bottom: 1.5rem;">
                    <div class="dashboard-card" style="text-align: center; padding: 1rem;">
                        <div style="font-size: 1.8rem; font-weight: 800; color: var(--success);" id="monthlyIncome">â‚¹0</div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">This Month Income</div>
                    </div>
                    <div class="dashboard-card" style="text-align: center; padding: 1rem;">
                        <div style="font-size: 1.8rem; font-weight: 800; color: var(--danger);" id="monthlyExpenses">â‚¹0</div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">This Month Expenses</div>
                    </div>
                </div>

                <!-- Transaction Management -->
                <div class="dashboard-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3><i class="fas fa-receipt"></i> Recent Transactions</h3>
                        <button class="btn btn-success btn-small" onclick="addTransaction()">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-outline btn-small filter-btn active" data-filter="all">All</button>
                        <button class="btn btn-outline btn-small filter-btn" data-filter="income">Income</button>
                        <button class="btn btn-outline btn-small filter-btn" data-filter="expense">Expenses</button>
                        <button class="btn btn-outline btn-small filter-btn" data-filter="loans">Loans</button>
                    </div>

                    <div id="transactionsList">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Loan Management -->
                <div class="dashboard-card">
                    <h3><i class="fas fa-handshake"></i> Loan Management</h3>
                    <div class="grid-2" style="margin-bottom: 1rem;">
                        <div style="text-align: center; padding: 1rem; background: rgba(25, 118, 210, 0.1); border-radius: 8px;">
                            <div style="font-weight: 700; color: var(--info); font-size: 1.2rem;" id="loansGiven">â‚¹0</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Money Lent</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: rgba(211, 47, 47, 0.1); border-radius: 8px;">
                            <div style="font-weight: 700; color: var(--danger); font-size: 1.2rem;" id="loansTaken">â‚¹0</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Money Borrowed</div>
                        </div>
                    </div>

                    <div id="loansList">
                        <!-- Populated by JS -->
                    </div>

                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn btn-info btn-small" onclick="addLoanGiven()">
                            <i class="fas fa-hand-holding-usd"></i> Lend Money
                        </button>
                        <button class="btn btn-warning btn-small" onclick="addLoanTaken()">
                            <i class="fas fa-handshake"></i> Borrow Money
                        </button>
                    </div>
                </div>
            </div>

            <!-- Assets Tab -->
            <div class="tab-content" id="assets-tab">
                <div style="margin-bottom: 1rem;">
                    <h2 style="color: var(--text-primary); margin-bottom: 1rem;">
                        <i class="fas fa-warehouse"></i> Farm Assets
                    </h2>
                    
                    <!-- Asset Overview -->
                    <div class="financial-summary">
                        <div class="financial-item">
                            <div class="financial-label">Equipment Value</div>
                            <div class="financial-value" id="equipmentValue">â‚¹0</div>
                        </div>
                        <div class="financial-item">
                            <div class="financial-label">Livestock Value</div>
                            <div class="financial-value" id="livestockValue">â‚¹0</div>
                        </div>
                        <div class="financial-item">
                            <div class="financial-label">Land Value</div>
                            <div class="financial-value" id="landValue">â‚¹0</div>
                        </div>
                        <div class="financial-item">
                            <div class="financial-label">Inventory Value</div>
                            <div class="financial-value" id="inventoryValue">â‚¹0</div>
                        </div>
                    </div>
                </div>

                <!-- Asset Categories -->
                <div class="dashboard-card">
                    <h3><i class="fas fa-tractor"></i> Farm Equipment</h3>
                    <div id="equipmentList">
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <i class="fas fa-tractor" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                            <p>No equipment added yet</p>
                            <button class="btn btn-primary btn-small" onclick="addEquipment()" style="margin-top: 1rem;">
                                <i class="fas fa-plus"></i> Add Equipment
                            </button>
                        </div>
                    </div>
                </div>

                <div class="dashboard-card">
                    <h3><i class="fas fa-cow"></i> Livestock</h3>
                    <div id="livestockList">
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <i class="fas fa-cow" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                            <p>No livestock added yet</p>
                            <button class="btn btn-primary btn-small" onclick="addLivestock()" style="margin-top: 1rem;">
                                <i class="fas fa-plus"></i> Add Animals
                            </button>
                        </div>
                    </div>
                </div>

                <div class="dashboard-card">
                    <h3><i class="fas fa-warehouse"></i> Inventory & Supplies</h3>
                    <div id="inventoryList">
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <i class="fas fa-warehouse" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                            <p>No inventory items yet</p>
                            <button class="btn btn-primary btn-small" onclick="addInventory()" style="margin-top: 1rem;">
                                <i class="fas fa-plus"></i> Add Items
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Innovations Tab -->
            <div class="tab-content" id="innovations-tab">
                <h2 style="color: var(--text-primary); margin-bottom: 1.5rem;">
                    <i class="fas fa-rocket"></i> Agricultural Innovations
                </h2>

                <!-- Crop Care -->
                <div class="innovation-card">
                    <div class="innovation-header">
                        <div class="innovation-icon crop-care">
                            <i class="fas fa-leaf"></i>
                        </div>
                        <div>
                            <h4>Crop Care & Disease Management</h4>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">AI-powered crop health monitoring</p>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div style="padding: 1rem; background: rgba(76, 175, 80, 0.1); border-radius: 8px;">
                            <h5 style="color: var(--success); margin-bottom: 0.5rem;">ðŸ“± Plantix Integration</h5>
                            <p style="font-size: 0.85rem; color: var(--text-secondary);">Use AI to identify crop diseases instantly with photo recognition</p>
                            <button class="btn btn-success btn-small" style="margin-top: 0.5rem;" onclick="openPlantixIntegration()">
                                <i class="fas fa-camera"></i> Try Now
                            </button>
                        </div>
                        <div style="padding: 1rem; background: rgba(25, 118, 210, 0.1); border-radius: 8px;">
                            <h5 style="color: var(--info); margin-bottom: 0.5rem;">ðŸŒ¡ï¸ Smart Sensors</h5>
                            <p style="font-size: 0.85rem; color: var(--text-secondary);">Monitor soil moisture, pH levels automatically</p>
                            <button class="btn btn-info btn-small" style="margin-top: 0.5rem;" onclick="showSensorInfo()">
                                <i class="fas fa-thermometer"></i> Learn More
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Modern Farming Practices -->
                <div class="innovation-card">
                    <div class="innovation-header">
                        <div class="innovation-icon farming">
                            <i class="fas fa-seedling"></i>
                        </div>
                        <div>
                            <h4>Modern Farming Practices</h4>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">Latest techniques and government subsidies</p>
                        </div>
                    </div>
                    <div id="farmingPractices">
                        <div style="padding: 1rem; margin-bottom: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                            <h5 style="color: var(--primary); margin-bottom: 0.5rem;">ðŸŒ± Organic Farming Transition</h5>
                            <p style="font-size: 0.85rem; margin-bottom: 0.5rem;">Switch to chemical-free farming with certification support</p>
                            <div class="subsidy-info">
                                <div class="subsidy-available">ðŸ’° Up to â‚¹50,000 subsidy available</div>
                                <div style="font-size: 0.8rem;">Through Paramparagat Krishi Vikas Yojana (PKVY)</div>
                            </div>
                        </div>
                        <div style="padding: 1rem; margin-bottom: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                            <h5 style="color: var(--primary); margin-bottom: 0.5rem;">ðŸ’§ Precision Irrigation</h5>
                            <p style="font-size: 0.85rem; margin-bottom: 0.5rem;">Drip and sprinkler irrigation systems</p>
                            <div class="subsidy-info">
                                <div class="subsidy-available">ðŸ’° Up to 80% subsidy available</div>
                                <div style="font-size: 0.8rem;">Through PMKSY - Per Drop More Crop</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Insurance Solutions -->
                <div class="innovation-card">
                    <div class="innovation-header">
                        <div class="innovation-icon insurance">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div>
                            <h4>Insurance & Risk Management</h4>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">Protect your crops and investments</p>
                        </div>
                    </div>
                    <div id="insuranceSchemes">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Machinery Innovations -->
                <div class="innovation-card">
                    <div class="innovation-header">
                        <div class="innovation-icon machinery">
                            <i class="fas fa-cogs"></i>
                        </div>
                        <div>
                            <h4>Machinery & Equipment</h4>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">Modern equipment with subsidies</p>
                        </div>
                    </div>
                    <div id="machineryInnovations">
                        <div style="padding: 1rem; margin-bottom: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                            <h5 style="color: var(--primary); margin-bottom: 0.5rem;">ðŸš Drone Technology</h5>
                            <p style="font-size: 0.85rem; margin-bottom: 0.5rem;">Crop monitoring and precision spraying</p>
                            <div class="subsidy-info">
                                <div class="subsidy-available">ðŸ’° Up to â‚¹10 lakh subsidy available</div>
                                <div style="font-size: 0.8rem;">Custom Hiring Centers under SMAM</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar & Planning Tab -->
            <div class="tab-content" id="calendar-tab">
                <h2 style="color: var(--text-primary); margin-bottom: 1.5rem;">
                    <i class="fas fa-calendar-alt"></i> Farm Calendar & Planning
                </h2>

                <!-- Enhanced Calendar -->
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="calendar-nav" onclick="changeCalendarYear(-1)">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <div class="year-display" id="calendarYear">2025</div>
                        <button class="calendar-nav" onclick="changeCalendarYear(1)">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    <div class="months-grid" id="calendarMonthsGrid">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Selected Month Details -->
                <div class="dashboard-card" id="calendarMonthDetails" style="display: none;">
                    <h3><i class="fas fa-calendar-day"></i> <span id="calendarSelectedMonth">Month</span> Planning</h3>
                    <div id="calendarActivities">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Seasonal Recommendations -->
                <div class="dashboard-card">
                    <h3><i class="fas fa-leaf"></i> Seasonal Farming Recommendations</h3>
                    <div id="seasonalRecommendations">
                        <p style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                            Select a month to view recommendations and best practices
                        </p>
                    </div>
                </div>
            </div>

            <!-- Profile Tab -->
            <div class="tab-content" id="profile-tab">
                <!-- User Profile -->
                <div class="dashboard-card">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="width: 80px; height: 80px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; font-weight: 700;" id="profileAvatar">
                            F
                        </div>
                        <div>
                            <h3 id="profileName" style="color: var(--text-primary); margin-bottom: 0.5rem;">Farmer Name</h3>
                            <p id="profileEmail" style="color: var(--text-secondary); margin: 0;">farmer@example.com</p>
                            <p id="profileLocation" style="color: var(--text-secondary); margin: 0;">Farm Location</p>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary btn-full" onclick="editProfile()">
                        <i class="fas fa-edit"></i> Edit Profile
                    </button>
                </div>

                <!-- App Settings -->
                <div class="dashboard-card">
                    <h3><i class="fas fa-cog"></i> Settings</h3>
                    <div class="form-group">
                        <label><i class="fas fa-palette"></i> Theme</label>
                        <select class="form-control" id="themeSelect" onchange="changeTheme(this.value)">
                            <option value="light">â˜€ï¸ Light Mode</option>
                            <option value="dark">ðŸŒ™ Dark Mode</option>
                            <option value="auto">ðŸ”„ Auto (System)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-language"></i> Language</label>
                        <select class="form-control" id="languageSelect" onchange="changeLanguage(this.value)">
                            <option value="en">ðŸ‡ºðŸ‡¸ English</option>
                            <option value="hi">ðŸ‡®ðŸ‡³ à¤¹à¤¿à¤‚à¤¦à¥€ (Hindi)</option>
                            <option value="te">ðŸ‡®ðŸ‡³ à°¤à±†à°²à±à°—à± (Telugu)</option>
                            <option value="ta">ðŸ‡®ðŸ‡³ à®¤à®®à®¿à®´à¯ (Tamil)</option>
                        </select>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1.5rem;">
                        <button class="btn btn-secondary" onclick="exportData()">
                            <i class="fas fa-download"></i> Export Data
                        </button>
                        <button class="btn btn-danger" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modals -->

        <!-- Add Crop Modal -->
        <div class="modal" id="cropModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-seedling"></i> <span id="cropModalTitle">Add New Crop</span></h3>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                
                <!-- Crop Selection with SVG Icons -->
                <div class="form-group">
                    <label>Select Crop Type</label>
                    <div class="grid-3" id="cropTypeSelection">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-tag"></i> Field Name (Optional)</label>
                    <input type="text" class="form-control" id="fieldName" placeholder="e.g., North Field, Plot A">
                </div>

                <div class="form-group">
                    <label><i class="fas fa-expand-arrows-alt"></i> Area</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="cropAcres" placeholder="Acres" min="0" step="0.1" required>
                        <input type="number" class="form-control" id="cropCents" placeholder="Cents" min="0" max="99">
                    </div>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-calendar"></i> Sowing Date</label>
                    <input type="date" class="form-control" id="sowingDate" required>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-clock"></i> Growth Duration (Days)</label>
                    <input type="number" class="form-control" id="cropDuration" placeholder="Days" min="30" max="365" required>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-target"></i> Expected Yield (Quintals)</label>
                    <input type="number" class="form-control" id="expectedYield" placeholder="Expected harvest" min="0" step="0.1">
                </div>

                <div class="form-group">
                    <label><i class="fas fa-rupee-sign"></i> Expected Price (â‚¹/Quintal)</label>
                    <input type="number" class="form-control" id="expectedPrice" placeholder="Market rate" min="0">
                </div>

                <div class="form-group">
                    <label><i class="fas fa-sticky-note"></i> Notes</label>
                    <textarea class="form-control" id="cropNotes" rows="2" placeholder="Variety, soil type, special notes..."></textarea>
                </div>

                <button class="btn btn-primary btn-full" onclick="saveCrop()">
                    <i class="fas fa-save"></i> <span id="saveCropText">Save Crop</span>
                </button>
            </div>
        </div>

        <!-- Transaction Modal -->
        <div class="modal" id="transactionModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-receipt"></i> Add Transaction</h3>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-exchange-alt"></i> Type</label>
                    <select class="form-control" id="transactionType" required onchange="updateTransactionCategories()">
                        <option value="">Select Type</option>
                        <option value="income">ðŸ’° Income</option>
                        <option value="expense">ðŸ’¸ Expense</option>
                        <option value="loan-given">ðŸ¤ Loan Given</option>
                        <option value="loan-taken">ðŸ“‹ Loan Taken</option>
                        <option value="loan-payment">ðŸ’³ Loan Payment</option>
                    </select>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-tag"></i> Category</label>
                    <select class="form-control" id="transactionCategory" required>
                        <option value="">First select type</option>
                    </select>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-edit"></i> Description</label>
                    <input type="text" class="form-control" id="transactionDescription" placeholder="Transaction details" required>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-rupee-sign"></i> Amount (â‚¹)</label>
                    <input type="number" class="form-control" id="transactionAmount" placeholder="0.00" min="0" step="0.01" required>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-calendar"></i> Date</label>
                    <input type="date" class="form-control" id="transactionDate" required>
                </div>

                <div class="form-group" id="relatedAssetGroup" style="display: none;">
                    <label><i class="fas fa-link"></i> Related To</label>
                    <select class="form-control" id="relatedAsset">
                        <option value="">Select related item</option>
                    </select>
                </div>

                <button class="btn btn-primary btn-full" onclick="saveTransaction()">
                    <i class="fas fa-save"></i> Save Transaction
                </button>
            </div>
        </div>

        <!-- Asset Modal -->
        <div class="modal" id="assetModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-plus"></i> <span id="assetModalTitle">Add Asset</span></h3>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-list"></i> Asset Type</label>
                    <select class="form-control" id="assetType" required onchange="updateAssetForm()">
                        <option value="">Select Type</option>
                        <option value="equipment">ðŸšœ Farm Equipment</option>
                        <option value="livestock">ðŸ„ Livestock</option>
                        <option value="inventory">ðŸ“¦ Inventory/Supplies</option>
                        <option value="land">ðŸ—ºï¸ Land Holdings</option>
                    </select>
                </div>

                <div id="assetFormFields">
                    <!-- Dynamic fields based on asset type -->
                </div>

                <button class="btn btn-primary btn-full" onclick="saveAsset()">
                    <i class="fas fa-save"></i> Save Asset
                </button>
            </div>
        </div>

        <!-- Profile Edit Modal -->
        <div class="modal" id="profileModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-user-edit"></i> Edit Profile</h3>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-user"></i> Name</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="editFirstName" placeholder="First Name" required>
                        <input type="text" class="form-control" id="editLastName" placeholder="Last Name" required>
                    </div>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-map-marker-alt"></i> Farm Location</label>
                    <input type="text" class="form-control" id="editFarmLocation" placeholder="Village, District, State" required>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-phone"></i> Alternative Contact</label>
                    <input type="tel" class="form-control" id="editAltPhone" placeholder="Alternative phone">
                </div>

                <button class="btn btn-primary btn-full" onclick="saveProfile()">
                    <i class="fas fa-save"></i> Update Profile
                </button>
            </div>
        </div>

        <!-- Mobile Navigation (Hidden during auth) -->
        <div class="mobile-nav hidden" id="mobileNav">
            <div class="nav-container">
                <a href="#" class="nav-item active" data-tab="home" onclick="switchTab('home')">
                    <i class="fas fa-home"></i>
                    <span class="language-content active" data-lang="en">Home</span>
                    <span class="language-content" data-lang="hi">à¤¹à¥‹à¤®</span>
                    <span class="language-content" data-lang="te">à°¹à±‹à°®à±</span>
                    <span class="language-content" data-lang="ta">à®µà¯€à®Ÿà¯</span>
                </a>
                <a href="#" class="nav-item" data-tab="crops" onclick="switchTab('crops')">
                    <i class="fas fa-seedling"></i>
                    <span class="language-content active" data-lang="en">Crops</span>
                    <span class="language-content" data-lang="hi">à¤«à¤¸à¤²</span>
                    <span class="language-content" data-lang="te">à°ªà°‚à°Ÿà°²à±</span>
                    <span class="language-content" data-lang="ta">à®ªà®¯à®¿à®°à¯à®•à®³à¯</span>
                </a>
                <a href="#" class="nav-item" data-tab="money" onclick="switchTab('money')">
                    <i class="fas fa-rupee-sign"></i>
                    <span class="language-content active" data-lang="en">Money</span>
                    <span class="language-content" data-lang="hi">à¤ªà¥ˆà¤¸à¤¾</span>
                    <span class="language-content" data-lang="te">à°¡à°¬à±à°¬à±</span>
                    <span class="language-content" data-lang="ta">à®ªà®£à®®à¯</span>
                    <div class="notification-dot" id="moneyNotification" style="display: none;"></div>
                </a>
                <a href="#" class="nav-item" data-tab="assets" onclick="switchTab('assets')">
                    <i class="fas fa-warehouse"></i>
                    <span class="language-content active" data-lang="en">Assets</span>
                    <span class="language-content" data-lang="hi">à¤¸à¤‚à¤ªà¤¤à¥à¤¤à¤¿</span>
                    <span class="language-content" data-lang="te">à°†à°¸à±à°¤à±à°²à±</span>
                    <span class="language-content" data-lang="ta">à®šà¯Šà®¤à¯à®¤à¯à®•à¯à®•à®³à¯</span>
                </a>
                <a href="#" class="nav-item" data-tab="innovations" onclick="switchTab('innovations')">
                    <i class="fas fa-rocket"></i>
                    <span class="language-content active" data-lang="en">Ideas</span>
                    <span class="language-content" data-lang="hi">à¤µà¤¿à¤šà¤¾à¤°</span>
                    <span class="language-content" data-lang="te">à°†à°²à±‹à°šà°¨à°²à±</span>
                    <span class="language-content" data-lang="ta">à®¯à¯‹à®šà®©à¯ˆà®•à®³à¯</span>
                </a>
                <a href="#" class="nav-item" data-tab="profile" onclick="switchTab('profile')">
                    <i class="fas fa-user"></i>
                    <span class="language-content active" data-lang="en">Profile</span>
                    <span class="language-content" data-lang="hi">à¤ªà¥à¤°à¥‹à¤«à¤¼à¤¾à¤‡à¤²</span>
                    <span class="language-content" data-lang="te">à°ªà±à°°à±Šà°«à±ˆà°²à±</span>
                    <span class="language-content" data-lang="ta">à®šà¯à®¯à®µà®¿à®µà®°à®®à¯</span>
                </a>
            </div>
        </div>

        <!-- Quick Access Menu (Hidden during auth) -->
        <div class="quick-access hidden" id="quickAccess">
            <div class="fab-menu" id="fabMenu">
                <div class="fab-item" onclick="addNewCrop(); closeFabMenu();">
                    <div class="fab-icon" style="background: var(--success);">
                        <i class="fas fa-seedling"></i>
                    </div>
                    <div class="fab-text">Add Crop</div>
                </div>
                <div class="fab-item" onclick="addTransaction(); closeFabMenu();">
                    <div class="fab-icon" style="background: var(--secondary);">
                        <i class="fas fa-receipt"></i>
                    </div>
                    <div class="fab-text">Add Transaction</div>
                </div>
                <div class="fab-item" onclick="addAsset(); closeFabMenu();">
                    <div class="fab-icon" style="background: var(--info);">
                        <i class="fas fa-plus"></i>
                    </div>
                    <div class="fab-text">Add Asset</div>
                </div>
            </div>
            <button class="fab-main" id="fabMain" onclick="toggleFabMenu()">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </div>

    <script>
        // Application State
        let currentUser = null;
        let currentPage = 'auth';
        let currentTab = 'home';
        let selectedCrop = null;
        let editingCrop = null;
        let editingTransaction = null;
        let currentYear = new Date().getFullYear();
        let selectedMonth = null;
        let currentLanguage = 'en';
        let currentTheme = localStorage.getItem('jama_theme') || 'light';
        let fabMenuOpen = false;

        let appData = {
            profile: null,
            crops: [],
            transactions: [],
            assets: { equipment: [], livestock: [], inventory: [], land: [] },
            settings: {
                language: 'en',
                theme: 'light',
                notifications: true
            }
        };

        // Crop Types with SVG Icons
        const cropTypes = [
            {
                name: 'paddy',
                label: 'Paddy/Rice',
                icon: 'fa-seedling',
                duration: 120,
                season: 'kharif',
                svg: `<svg class="crop-svg" viewBox="0 0 100 100"><rect fill="#8bc34a" x="20" y="60" width="60" height="30" rx="5"/><path fill="#4caf50" d="M30,60 Q50,40 70,60"/><circle fill="#ffc107" cx="50" cy="50" r="3"/></svg>`,
                tips: 'Monitor water levels regularly',
                optimalTemp: { min: 20, max: 35 },
                soilTypes: ['Clay', 'Loamy'],
                waterRequirement: 'High'
            },
            {
                name: 'wheat',
                label: 'Wheat',
                icon: 'fa-wheat-awn',
                duration: 150,
                season: 'rabi',
                svg: `<svg class="crop-svg" viewBox="0 0 100 100"><path fill="#ffc107" d="M45,20 Q50,10 55,20 L55,80 L45,80 Z"/><circle fill="#ff9800" cx="50" cy="25" r="8"/><path fill="#ff8f00" d="M42,30 Q50,20 58,30"/></svg>`,
                tips: 'Apply nitrogen at tillering stage',
                optimalTemp: { min: 10, max: 25 },
                soilTypes: ['Loamy', 'Sandy-loam'],
                waterRequirement: 'Medium'
            },
            {
                name: 'cotton',
                label: 'Cotton',
                icon: 'fa-leaf',
                duration: 180,
                season: 'kharif',
                svg: `<svg class="crop-svg" viewBox="0 0 100 100"><path fill="#4caf50" d="M45,80 L45,30 Q50,20 55,30 L55,80"/><circle fill="#f5f5f5" cx="40" cy="35" r="8"/><circle fill="#f5f5f5" cx="60" cy="40" r="8"/></svg>`,
                tips: 'Watch for bollworm infestations',
                optimalTemp: { min: 21, max: 30 },
                soilTypes: ['Black', 'Alluvial'],
                waterRequirement: 'Medium'
            },
            {
                name: 'maize',
                label: 'Maize/Corn',
                icon: 'fa-corn',
                duration: 100,
                season: 'kharif',
                svg: `<svg class="crop-svg" viewBox="0 0 100 100"><path fill="#4caf50" d="M45,80 L45,40 Q50,30 55,40 L55,80"/><ellipse fill="#ffc107" cx="50" cy="45" rx="12" ry="20"/></svg>`,
                tips: 'Ensure adequate spacing',
                optimalTemp: { min: 21, max: 27 },
                soilTypes: ['Well-drained', 'Fertile'],
                waterRequirement: 'Medium'
            },
            {
                name: 'tomato',
                label: 'Tomato',
                icon: 'fa-apple-alt',
                duration: 75,
                season: 'zaid',
                svg: `<svg class="crop-svg" viewBox="0 0 100 100"><circle fill="#f44336" cx="50" cy="50" r="20"/><path fill="#4caf50" d="M50,30 Q55,25 60,30 Q55,35 50,30"/></svg>`,
                tips: 'Provide support stakes',
                optimalTemp: { min: 20, max: 25 },
                soilTypes: ['Well-drained', 'Organic-rich'],
                waterRequirement: 'High'
            },
            {
                name: 'onion',
                label: 'Onion',
                icon: 'fa-circle',
                duration: 120,
                season: 'rabi',
                svg: `<svg class="crop-svg" viewBox="0 0 100 100"><circle fill="#e91e63" cx="50" cy="60" r="15"/><path fill="#4caf50" d="M50,45 L50,20 Q48,15 52,20"/></svg>`,
                tips: 'Control thrips and purple blotch',
                optimalTemp: { min: 13, max: 24 },
                soilTypes: ['Well-drained', 'Fertile'],
                waterRequirement: 'Medium'
            },
            {
                name: 'potato',
                label: 'Potato',
                icon: 'fa-circle',
                duration: 90,
                season: 'rabi',
                svg: `<svg class="crop-svg" viewBox="0 0 100 100"><ellipse fill="#8d6e63" cx="50" cy="55" rx="18" ry="12"/><path fill="#4caf50" d="M50,43 L50,25 Q48,20 52,25"/></svg>`,
                tips: 'Earthing up crucial for development',
                optimalTemp: { min: 15, max: 20 },
                soilTypes: ['Sandy-loam', 'Well-drained'],
                waterRequirement: 'Medium'
            },
            {
                name: 'sugarcane',
                label: 'Sugarcane',
                icon: 'fa-candy-cane',
                duration: 365,
                season: 'annual',
                svg: `<svg class="crop-svg" viewBox="0 0 100 100"><rect fill="#8bc34a" x="40" y="20" width="8" height="60"/><rect fill="#4caf50" x="52" y="25" width="8" height="55"/></svg>`,
                tips: 'Regular irrigation needed',
                optimalTemp: { min: 21, max: 27 },
                soilTypes: ['Deep', 'Well-drained'],
                waterRequirement: 'Very High'
            }
        ];

        // Enhanced transaction categories
        const transactionCategories = {
            income: [
                { value: 'crop-sale', label: 'ðŸŒ¾ Crop Sale' },
                { value: 'milk-sale', label: 'ðŸ¥› Milk Sale' },
                { value: 'egg-sale', label: 'ðŸ¥š Egg Sale' },
                { value: 'livestock-sale', label: 'ðŸ„ Livestock Sale' },
                { value: 'equipment-rental', label: 'ðŸšœ Equipment Rental' },
                { value: 'subsidy', label: 'ðŸ›ï¸ Government Subsidy' },
                { value: 'insurance-claim', label: 'ðŸ›¡ï¸ Insurance Claim' },
                { value: 'other-income', label: 'ðŸ’° Other Income' }
            ],
            expense: [
                { value: 'seeds', label: 'ðŸŒ± Seeds & Planting' },
                { value: 'fertilizer', label: 'ðŸ§ª Fertilizers' },
                { value: 'pesticide', label: 'ðŸ› Pesticides' },
                { value: 'labor', label: 'ðŸ‘· Labor Wages' },
                { value: 'fuel', label: 'â›½ Fuel & Diesel' },
                { value: 'equipment', label: 'ðŸšœ Equipment Purchase' },
                { value: 'maintenance', label: 'ðŸ”§ Maintenance' },
                { value: 'irrigation', label: 'ðŸ’§ Irrigation' },
                { value: 'feed', label: 'ðŸŒ¾ Animal Feed' },
                { value: 'insurance', label: 'ðŸ›¡ï¸ Insurance Premium' },
                { value: 'other-expense', label: 'ðŸ’¸ Other Expenses' }
            ]
        };

        // Monthly mandates for different crops
        const monthlyMandates = {
            1: [
                { crop: 'wheat', activity: 'irrigation', description: 'Crown root initiation - critical water requirement', priority: 'critical' },
                { crop: 'mustard', activity: 'harvest', description: 'Harvest when pods turn yellow', priority: 'important' },
                { crop: 'potato', activity: 'harvest', description: 'Harvest when foliage dies back', priority: 'important' }
            ],
            2: [
                { crop: 'wheat', activity: 'fertilizer', description: 'Second nitrogen application for grain filling', priority: 'critical' },
                { crop: 'sunflower', activity: 'sowing', description: 'Summer sunflower sowing window', priority: 'recommended' },
                { crop: 'fodder', activity: 'planning', description: 'Plan summer fodder crops', priority: 'important' }
            ],
            3: [
                { crop: 'wheat', activity: 'harvest', description: 'Harvest when moisture content is 12-14%', priority: 'critical' },
                { crop: 'cotton', activity: 'land-prep', description: 'Deep ploughing and soil preparation', priority: 'important' },
                { crop: 'summer-crops', activity: 'sowing', description: 'Sow heat-tolerant varieties', priority: 'recommended' }
            ],
            4: [
                { crop: 'paddy', activity: 'nursery', description: 'Prepare nursery beds for kharif season', priority: 'critical' },
                { crop: 'sugarcane', activity: 'planting', description: 'Plant spring sugarcane', priority: 'important' },
                { crop: 'cotton', activity: 'sowing', description: 'Sow after soil temperature reaches 18Â°C', priority: 'critical' }
            ],
            5: [
                { crop: 'paddy', activity: 'transplanting', description: 'Transplant paddy seedlings', priority: 'critical' },
                { crop: 'cotton', activity: 'monitoring', description: 'Monitor for early bollworm', priority: 'important' },
                { crop: 'maize', activity: 'sowing', description: 'Prepare for kharif maize sowing', priority: 'recommended' }
            ],
            6: [
                { crop: 'paddy', activity: 'transplanting', description: 'Complete kharif paddy transplanting', priority: 'critical' },
                { crop: 'maize', activity: 'sowing', description: 'Sow with onset of monsoon', priority: 'critical' },
                { crop: 'cotton', activity: 'fertilizer', description: 'First nitrogen top dressing', priority: 'important' }
            ],
            7: [
                { crop: 'paddy', activity: 'weeding', description: 'First weeding and fertilizer application', priority: 'critical' },
                { crop: 'soybean', activity: 'sowing', description: 'Sow with good monsoon rains', priority: 'critical' },
                { crop: 'cotton', activity: 'pest-control', description: 'Monitor sucking pests', priority: 'important' }
            ],
            8: [
                { crop: 'paddy', activity: 'pest-control', description: 'Monitor brown planthopper and stem borer', priority: 'critical' },
                { crop: 'cotton', activity: 'fertilizer', description: 'Second nitrogen for boll development', priority: 'important' },
                { crop: 'vegetables', activity: 'sowing', description: 'Sow monsoon vegetables', priority: 'recommended' }
            ],
            9: [
                { crop: 'paddy', activity: 'flowering', description: 'Flowering stage - ensure water availability', priority: 'critical' },
                { crop: 'cotton', activity: 'monitoring', description: 'Monitor American bollworm', priority: 'important' },
                { crop: 'wheat', activity: 'planning', description: 'Plan rabi crop sowing', priority: 'recommended' }
            ],
            10: [
                { crop: 'paddy', activity: 'harvest', description: 'Harvest when 80% grains golden', priority: 'critical' },
                { crop: 'wheat', activity: 'sowing', description: 'Sow after paddy harvest', priority: 'critical' },
                { crop: 'cotton', activity: 'harvest', description: 'Start picking mature bolls', priority: 'important' }
            ],
            11: [
                { crop: 'wheat', activity: 'irrigation', description: 'First irrigation 3-4 weeks after sowing', priority: 'critical' },
                { crop: 'mustard', activity: 'sowing', description: 'Sow mustard for oil', priority: 'important' },
                { crop: 'cotton', activity: 'harvest', description: 'Continue cotton picking', priority: 'important' }
            ],
            12: [
                { crop: 'wheat', activity: 'fertilizer', description: 'First nitrogen for tillering', priority: 'critical' },
                { crop: 'potato', activity: 'sowing', description: 'Plant potato tubers', priority: 'important' },
                { crop: 'cotton', activity: 'final-harvest', description: 'Complete cotton harvest', priority: 'important' }
            ]
        };

        // Insurance schemes data
        const insuranceSchemes = [
            {
                name: 'PM Fasal Bima Yojana',
                type: 'government',
                coverage: 'All major crops',
                premium: '2% for Kharif, 1.5% for Rabi',
                benefits: ['Weather-based losses', 'Pest attacks', 'Natural disasters'],
                documents: ['Aadhaar', 'Bank Account', 'Land Records'],
                website: 'pmfby.gov.in',
                secured: false
            },
            {
                name: 'Weather Based Crop Insurance',
                type: 'government',
                coverage: 'Weather sensitive crops',
                premium: '3-5% of sum insured',
                benefits: ['Drought', 'Excess rainfall', 'Temperature variations'],
                documents: ['Land ownership proof', 'Previous 3 years yield data'],
                website: 'agricoop.nic.in',
                secured: false
            },
            {
                name: 'HDFC ERGO Crop Insurance',
                type: 'private',
                coverage: 'Comprehensive coverage',
                premium: '4-8% of sum insured',
                benefits: ['Multi-peril coverage', 'Quick claim settlement', '24/7 support'],
                documents: ['KYC documents', 'Land papers', 'Previous insurance records'],
                website: 'hdfcergo.com',
                secured: false
            }
        ];

        // Application Initialization
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            console.log('ðŸŒ± Initializing Jama Agricultural Management System...');
            
            // Apply saved theme
            applyTheme(currentTheme);
            
            setupEventListeners();
            initializeDateInputs();
            populateCropSelections();
            loadSavedUser();
            setCurrentDate();
            
            showSuccess('Jama Agricultural System Ready! ðŸš€');
        }

        function setupEventListeners() {
            // Authentication listeners
            setupAuthListeners();
            
            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // Calendar navigation
            setupCalendarListeners();
            
            // Form submissions
            document.addEventListener('submit', e => e.preventDefault());
            
            // Modal close on outside click
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    closeModal();
                }
            });

            // Filter buttons
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-btn')) {
                    handleFilterClick(e.target);
                }
            });

            // Month card clicks
            document.addEventListener('click', (e) => {
                if (e.target.closest('.month-card')) {
                    const monthCard = e.target.closest('.month-card');
                    const monthIndex = parseInt(monthCard.dataset.month);
                    if (!isNaN(monthIndex)) {
                        selectMonth(monthIndex);
                    }
                }
            });

            // Crop card expand/collapse
            document.addEventListener('click', (e) => {
                if (e.target.closest('.crop-header')) {
                    const cropCard = e.target.closest('.crop-container').querySelector('.crop-card');
                    toggleCropCard(cropCard);
                }
            });
        }

        function setupAuthListeners() {
            // Auth tab switching
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.addEventListener('click', () => switchAuthTab(tab.dataset.auth));
            });

            // Auth buttons
            document.getElementById('emailLoginBtn').addEventListener('click', emailLogin);
            document.getElementById('emailRegisterBtn').addEventListener('click', emailRegister);
            document.getElementById('sendOtpBtn').addEventListener('click', sendOTP);
            document.getElementById('verifyOtpBtn').addEventListener('click', verifyOTP);
            document.getElementById('googleSignInBtn').addEventListener('click', googleSignIn);
            document.getElementById('backToPhoneBtn').addEventListener('click', () => switchAuthTab('phone'));
            document.getElementById('completeRegistrationBtn').addEventListener('click', completeRegistration);

            // OTP input handling
            setupOTPInputs();
        }

        function setupOTPInputs() {
            const otpInputs = document.querySelectorAll('.otp-input');
            otpInputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    if (e.target.value.length === 1) {
                        const nextInput = otpInputs[index + 1];
                        if (nextInput) nextInput.focus();
                    }
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && e.target.value === '') {
                        const prevInput = otpInputs[index - 1];
                        if (prevInput) prevInput.focus();
                    }
                });
            });
        }

        function setupCalendarListeners() {
            // Calendar navigation is handled by onclick in HTML
        }

        function initializeDateInputs() {
            const today = new Date().toISOString().split('T')[0];
            const dateInputs = ['sowingDate', 'transactionDate'];
            dateInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = today;
            });
        }

        function populateCropSelections() {
            const grid = document.getElementById('primaryCropsGrid');
            if (grid) {
                grid.innerHTML = cropTypes.map(crop => `
                    <div class="crop-option" data-crop="${crop.name}" onclick="toggleCropSelection(this)">
                        ${crop.svg}
                        <div style="font-size: 0.8rem; font-weight: 600; margin-top: 0.5rem;">${crop.label}</div>
                    </div>
                `).join('');
            }

            // Populate crop modal
            const cropSelection = document.getElementById('cropTypeSelection');
            if (cropSelection) {
                cropSelection.innerHTML = cropTypes.map(crop => `
                    <div class="crop-option" data-crop="${crop.name}" onclick="selectCrop(this)">
                        ${crop.svg}
                        <div style="font-size: 0.8rem; font-weight: 600; margin-top: 0.5rem;">${crop.label}</div>
                    </div>
                `).join('');
            }
        }

        function loadSavedUser() {
            const savedUser = localStorage.getItem('jama_current_user');
            const savedData = localStorage.getItem('jama_app_data');
            
            if (savedUser && savedData) {
                try {
                    currentUser = JSON.parse(savedUser);
                    appData = { ...appData, ...JSON.parse(savedData) };
                    
                    if (appData.profile) {
                        showDashboard();
                    } else {
                        showPage('registration');
                    }
                } catch (error) {
                    console.error('Error loading saved data:', error);
                    showPage('auth');
                }
            } else {
                showPage('auth');
            }
        }

        function setCurrentDate() {
            document.getElementById('currentYear').textContent = currentYear;
            document.getElementById('calendarYear').textContent = currentYear;
            loadCalendar();
        }

        // Authentication Functions
        async function emailLogin() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showError('Please fill in all fields');
                return;
            }

            try {
                showLoading('Logging in...');
                
                // Demo login
                currentUser = {
                    uid: `demo_${email.replace(/[^a-zA-Z0-9]/g, '_')}`,
                    email: email,
                    displayName: email.split('@')[0]
                };
                
                localStorage.setItem('jama_current_user', JSON.stringify(currentUser));
                await loadUserData();
                showSuccess('Welcome back! Login successful.');
            } catch (error) {
                showError('Login failed. Please check your credentials.');
            } finally {
                hideLoading();
            }
        }

        async function emailRegister() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showError('Please fill in all fields');
                return;
            }

            if (password.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }

            try {
                showLoading('Creating account...');
                
                currentUser = {
                    uid: `demo_${email.replace(/[^a-zA-Z0-9]/g, '_')}`,
                    email: email,
                    displayName: email.split('@')[0]
                };
                
                localStorage.setItem('jama_current_user', JSON.stringify(currentUser));
                showPage('registration');
                showSuccess('Account created! Complete your profile.');
            } catch (error) {
                showError('Registration failed. Please try again.');
            } finally {
                hideLoading();
            }
        }

        async function sendOTP() {
            const phone = document.getElementById('phoneNumber').value.trim();
            const countryCode = document.getElementById('countryCode').value;
            
            if (!phone) {
                showError('Please enter phone number');
                return;
            }

            const fullPhone = countryCode + phone;
            
            try {
                showLoading('Sending OTP...');
                
                document.getElementById('phoneDisplay').textContent = fullPhone;
                switchAuthTab('otp');
                startOTPCountdown();
                showSuccess('Demo OTP sent! Use 123456 to continue.');
            } catch (error) {
                showError('Failed to send OTP. Please try again.');
            } finally {
                hideLoading();
            }
        }

        async function verifyOTP() {
            const otpInputs = document.querySelectorAll('.otp-input');
            let otp = '';
            otpInputs.forEach(input => otp += input.value);
            
            if (otp.length !== 6) {
                showError('Please enter complete 6-digit OTP');
                return;
            }

            try {
                showLoading('Verifying OTP...');
                
                if (otp === '123456') {
                    const phoneNumber = document.getElementById('phoneDisplay').textContent;
                    currentUser = {
                        uid: `demo_${phoneNumber.replace(/[^0-9]/g, '')}`,
                        phoneNumber: phoneNumber,
                        displayName: `User ${phoneNumber.slice(-4)}`
                    };
                    
                    localStorage.setItem('jama_current_user', JSON.stringify(currentUser));
                    await loadUserData();
                    showSuccess('Phone verified successfully!');
                } else {
                    showError('Invalid OTP. Use 123456 for demo.');
                    return;
                }
            } catch (error) {
                showError('OTP verification failed.');
            } finally {
                hideLoading();
            }
        }

        async function googleSignIn() {
            try {
                showLoading('Signing in with Google...');
                
                // Demo Google login
                currentUser = {
                    uid: 'demo_google_user',
                    email: 'demo@gmail.com',
                    displayName: 'Demo Google User',
                    photoURL: 'https://images.pexels.com/photos/220453/pexels-photo-220453.jpeg?w=100'
                };
                
                localStorage.setItem('jama_current_user', JSON.stringify(currentUser));
                await loadUserData();
                showSuccess('Google sign-in successful!');
            } catch (error) {
                showError('Google sign-in failed.');
            } finally {
                hideLoading();
            }
        }

        function startOTPCountdown() {
            let timeLeft = 120;
            const countdownElement = document.getElementById('countdown');
            
            const timer = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                countdownElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    countdownElement.textContent = 'Expired';
                    showError('OTP expired. Please request a new one.');
                }
                timeLeft--;
            }, 1000);
        }

        // Registration Functions
        async function completeRegistration() {
            const firstName = document.getElementById('regFirstName').value.trim();
            const lastName = document.getElementById('regLastName').value.trim();
            const farmLocation = document.getElementById('regFarmLocation').value.trim();
            const farmAcres = parseFloat(document.getElementById('regFarmAcres').value);
            const farmCents = parseInt(document.getElementById('regFarmCents').value || '0');
            const altPhone = document.getElementById('regAltPhone').value.trim();
            
            if (!firstName || !lastName || !farmLocation || !farmAcres) {
                showError('Please fill in all required fields');
                return;
            }

            const selectedCrops = Array.from(document.querySelectorAll('#primaryCropsGrid .crop-option.selected'))
                .map(el => el.dataset.crop);

            try {
                showLoading('Setting up your profile...');

                appData.profile = {
                    firstName,
                    lastName,
                    farmLocation,
                    totalFarmSize: { acres: farmAcres, cents: farmCents },
                    primaryCrops: selectedCrops,
                    alternativePhone: altPhone,
                    email: currentUser.email,
                    phone: currentUser.phoneNumber,
                    registrationDate: new Date().toISOString()
                };

                await saveData();
                showDashboard();
                loadWeatherData(farmLocation);
                showSuccess('ðŸŽ‰ Welcome to Jama! Your farm management system is ready.');
            } catch (error) {
                showError('Failed to complete registration.');
            } finally {
                hideLoading();
            }
        }

        // Data Management
        async function loadUserData() {
            if (appData.profile) {
                showDashboard();
                loadWeatherData(appData.profile.farmLocation);
            } else {
                showPage('registration');
            }
        }

        async function saveData() {
            appData.lastUpdated = new Date().toISOString();
            localStorage.setItem('jama_app_data', JSON.stringify(appData));
            return true;
        }

        // Dashboard Functions
        function showDashboard() {
            showPage('dashboard');
            
            // Remove auth mode
            document.getElementById('appContainer').classList.remove('auth-mode');
            
            // Show navigation elements
            document.getElementById('miniHeader').classList.remove('hidden');
            document.getElementById('mobileNav').classList.remove('hidden');
            document.getElementById('quickAccess').classList.remove('hidden');
            
            loadDashboardData();
        }

        function loadDashboardData() {
            updateUserInfo();
            updateFinancialSummary();
            loadCalendar();
            generateSmartSuggestions();
            loadMonthlyMandates();
            loadCropsDisplay();
            loadTransactions();
            loadAssets();
            loadInsuranceData();
        }

        function updateUserInfo() {
            if (!appData.profile) return;
            
            const fullName = `${appData.profile.firstName} ${appData.profile.lastName}`;
            document.getElementById('headerUserName').textContent = appData.profile.firstName;
            document.getElementById('profileName').textContent = fullName;
            document.getElementById('profileEmail').textContent = appData.profile.email || currentUser?.email || 'Not provided';
            document.getElementById('profileLocation').textContent = appData.profile.farmLocation;
            
            // Set avatar
            const avatar = document.getElementById('profileAvatar');
            avatar.textContent = appData.profile.firstName.charAt(0).toUpperCase();
        }

        function updateFinancialSummary() {
            const transactions = appData.transactions || [];
            
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const netProfit = totalIncome - totalExpenses;
            
            // Calculate loans
            const loansGivenAmount = transactions.filter(t => t.type === 'loan-given').reduce((sum, t) => sum + t.amount, 0);
            const loansTakenAmount = transactions.filter(t => t.type === 'loan-taken').reduce((sum, t) => sum + t.amount, 0);
            const activeLoans = Math.abs(loansTakenAmount - loansGivenAmount);

            // Update main summary
            document.getElementById('totalIncome').textContent = `â‚¹${formatCurrency(totalIncome)}`;
            document.getElementById('totalExpenses').textContent = `â‚¹${formatCurrency(totalExpenses)}`;
            document.getElementById('netProfit').textContent = `â‚¹${formatCurrency(netProfit)}`;
            document.getElementById('netProfit').style.color = netProfit >= 0 ? 'var(--success)' : 'var(--danger)';
            document.getElementById('activeLoans').textContent = `â‚¹${formatCurrency(activeLoans)}`;

            // Update monthly figures
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const monthlyIncome = transactions.filter(t => {
                const date = new Date(t.date);
                return t.type === 'income' && date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            }).reduce((sum, t) => sum + t.amount, 0);

            const monthlyExpenses = transactions.filter(t => {
                const date = new Date(t.date);
                return t.type === 'expense' && date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            }).reduce((sum, t) => sum + t.amount, 0);

            document.getElementById('monthlyIncome').textContent = `â‚¹${formatCurrency(monthlyIncome)}`;
            document.getElementById('monthlyExpenses').textContent = `â‚¹${formatCurrency(monthlyExpenses)}`;

            // Update loan summary
            document.getElementById('loansGiven').textContent = `â‚¹${formatCurrency(loansGivenAmount)}`;
            document.getElementById('loansTaken').textContent = `â‚¹${formatCurrency(loansTakenAmount)}`;
        }

        function loadCalendar() {
            const grids = ['monthsGrid', 'calendarMonthsGrid'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            const monthlyActivities = calculateMonthlyActivities();
            
            const monthHTML = months.map((month, index) => {
                const activities = monthlyActivities[index] || [];
                const hasActivities = activities.length > 0;
                const hasCritical = activities.some(a => a.priority === 'critical');
                const hasUrgent = activities.some(a => a.priority === 'urgent');
                
                return `
                    <div class="month-card ${hasActivities ? 'has-activities' : ''}" data-month="${index}">
                        <div class="month-name">${month}</div>
                        <div class="month-activities">${activities.length} tasks</div>
                        <div class="activity-indicators">
                            ${hasActivities ? '<div class="activity-dot crop"></div>' : ''}
                            ${hasCritical ? '<div class="activity-dot urgent"></div>' : ''}
                            ${hasUrgent ? '<div class="activity-dot transaction"></div>' : ''}
                        </div>
                    </div>
                `;
            }).join('');

            grids.forEach(gridId => {
                const grid = document.getElementById(gridId);
                if (grid) grid.innerHTML = monthHTML;
            });
        }

        function calculateMonthlyActivities() {
            const activities = {};
            
            // Add crop activities
            (appData.crops || []).forEach(crop => {
                const sowingDate = new Date(crop.sowingDate);
                const sowingMonth = sowingDate.getMonth();
                const harvestMonth = new Date(sowingDate.getTime() + crop.duration * 24 * 60 * 60 * 1000).getMonth();
                
                if (!activities[sowingMonth]) activities[sowingMonth] = [];
                activities[sowingMonth].push({
                    type: 'sowing',
                    crop: crop.type,
                    fieldName: crop.fieldName || 'Main Field',
                    description: `Sow ${crop.type}`,
                    priority: 'important'
                });
                
                if (harvestMonth !== sowingMonth) {
                    if (!activities[harvestMonth]) activities[harvestMonth] = [];
                    activities[harvestMonth].push({
                        type: 'harvest',
                        crop: crop.type,
                        fieldName: crop.fieldName || 'Main Field',
                        description: `Harvest ${crop.type}`,
                        priority: 'critical'
                    });
                }
            });

            // Add monthly mandates
            Object.keys(monthlyMandates).forEach(month => {
                const monthIndex = parseInt(month) - 1;
                if (!activities[monthIndex]) activities[monthIndex] = [];
                
                monthlyMandates[month].forEach(mandate => {
                    activities[monthIndex].push({
                        type: 'mandate',
                        crop: mandate.crop,
                        description: mandate.description,
                        activity: mandate.activity,
                        priority: mandate.priority
                    });
                });
            });

            return activities;
        }

        function generateSmartSuggestions() {
            const suggestions = [];
            const today = new Date();
            
            // Crop-based suggestions
            (appData.crops || []).forEach(crop => {
                const sowingDate = new Date(crop.sowingDate);
                const daysSinceSowing = Math.floor((today - sowingDate) / (1000 * 60 * 60 * 24));
                const harvestDate = new Date(sowingDate.getTime() + crop.duration * 24 * 60 * 60 * 1000);
                const daysToHarvest = Math.floor((harvestDate - today) / (1000 * 60 * 60 * 24));
                
                if (crop.status === 'active') {
                    if (daysSinceSowing >= 0 && daysSinceSowing <= 7) {
                        suggestions.push({
                            icon: 'fa-eye',
                            title: `Monitor ${crop.type} germination`,
                            description: `Check ${crop.fieldName || 'field'} for uniform sprouting`,
                            priority: 'high',
                            type: 'crop'
                        });
                    } else if (daysToHarvest <= 10 && daysToHarvest > 0) {
                        suggestions.push({
                            icon: 'fa-clock',
                            title: `${crop.type} harvest in ${daysToHarvest} days`,
                            description: `Prepare equipment for ${crop.fieldName || 'field'}`,
                            priority: 'urgent',
                            type: 'crop'
                        });
                    }
                }
            });

            // Insurance suggestions
            const crops = appData.crops || [];
            if (crops.length > 0) {
                const hasInsurance = crops.some(crop => crop.insured);
                if (!hasInsurance) {
                    suggestions.push({
                        icon: 'fa-shield-alt',
                        title: 'Consider Crop Insurance',
                        description: 'Protect your crops with PM Fasal Bima Yojana',
                        priority: 'medium',
                        type: 'insurance'
                    });
                }
            }

            displaySuggestions(suggestions);
        }

        function displaySuggestions(suggestions) {
            const container = document.getElementById('smartSuggestions');
            if (!container) return;

            if (!suggestions.length) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <i class="fas fa-check-circle" style="font-size: 2rem; color: var(--success); margin-bottom: 1rem; display: block;"></i>
                        All caught up! No urgent recommendations.
                    </div>
                `;
                return;
            }

            container.innerHTML = suggestions.map(suggestion => `
                <div class="suggestion-card ${suggestion.priority}">
                    <div class="suggestion-header">
                        <div class="suggestion-icon" style="background: ${getPriorityColor(suggestion.priority)}15; color: ${getPriorityColor(suggestion.priority)};">
                            <i class="fas ${suggestion.icon}"></i>
                        </div>
                        <div class="suggestion-title">${suggestion.title}</div>
                    </div>
                    <div class="suggestion-desc">${suggestion.description}</div>
                    <div class="priority-badge ${suggestion.priority}">${suggestion.priority}</div>
                </div>
            `).join('');
        }

        function loadMonthlyMandates() {
            const currentMonth = new Date().getMonth() + 1;
            const mandates = monthlyMandates[currentMonth] || [];
            const container = document.getElementById('monthlyMandates');
            
            if (!container) return;

            if (!mandates.length) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <i class="fas fa-calendar-check" style="font-size: 2rem; color: var(--success); margin-bottom: 1rem; display: block;"></i>
                        No critical tasks for this month
                    </div>
                `;
                return;
            }

            container.innerHTML = mandates.map(mandate => `
                <div class="suggestion-card ${mandate.priority}">
                    <div class="suggestion-header">
                        <div class="suggestion-icon" style="background: ${getPriorityColor(mandate.priority)}15; color: ${getPriorityColor(mandate.priority)};">
                            <i class="fas fa-${getActivityIcon(mandate.activity)}"></i>
                        </div>
                        <div class="suggestion-title">${mandate.crop.charAt(0).toUpperCase() + mandate.crop.slice(1)} - ${mandate.activity}</div>
                    </div>
                    <div class="suggestion-desc">${mandate.description}</div>
                    <div class="priority-badge ${mandate.priority}">${mandate.priority}</div>
                </div>
            `).join('');
        }

        // Crop Management Functions
        function loadCropsDisplay() {
            const container = document.getElementById('cropsContainer');
            if (!container) return;

            const crops = appData.crops || [];
            
            if (!crops.length) {
                container.innerHTML = `
                    <div class="dashboard-card" style="text-align: center; padding: 3rem 1rem;">
                        <i class="fas fa-seedling" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 1rem;"></i>
                        <h3 style="color: var(--text-primary); margin-bottom: 1rem;">No Crops Added Yet</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Start managing your farm by adding your first crop</p>
                        <button class="btn btn-primary" onclick="addNewCrop()">
                            <i class="fas fa-plus"></i> Add Your First Crop
                        </button>
                    </div>
                `;
                return;
            }

            // Update crop summary
            const activeCrops = crops.filter(c => c.status === 'active').length;
            const totalArea = crops.reduce((sum, c) => sum + c.acres + (c.cents || 0)/100, 0);
            const expectedHarvest = crops.filter(c => c.status === 'active').reduce((sum, c) => sum + (c.expectedYield || 0), 0);
            const projectedRevenue = crops.filter(c => c.status === 'active').reduce((sum, c) => sum + ((c.expectedYield || 0) * (c.expectedPrice || 0)), 0);

            document.getElementById('activeCropsCount').textContent = activeCrops;
            document.getElementById('totalCropArea').textContent = `${totalArea.toFixed(1)} Acres`;
            document.getElementById('expectedHarvest').textContent = `${expectedHarvest} Qt`;
            document.getElementById('projectedRevenue').textContent = `â‚¹${formatCurrency(projectedRevenue)}`;

            // Display individual crops
            container.innerHTML = crops.map(crop => createCropCard(crop)).join('');
        }

        function createCropCard(crop) {
            const transactions = appData.transactions.filter(t => t.relatedTo === crop.id) || [];
            const revenue = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const profit = revenue - expenses;

            const sowingDate = new Date(crop.sowingDate);
            const harvestDate = new Date(sowingDate.getTime() + crop.duration * 24 * 60 * 60 * 1000);
            const today = new Date();
            const daysElapsed = Math.max(0, Math.floor((today - sowingDate) / (1000 * 60 * 60 * 24)));
            const progress = Math.min((daysElapsed / crop.duration) * 100, 100);

            const cropInfo = cropTypes.find(c => c.name === crop.type) || {};

            return `
                <div class="crop-container">
                    <div class="crop-card" id="crop-${crop.id}">
                        <div class="crop-header" onclick="toggleCropDetails('${crop.id}')">
                            <div class="crop-basic-info">
                                <div>
                                    <div class="crop-title">
                                        ${cropInfo.svg || 'ðŸŒ±'}
                                        <span>${crop.type.charAt(0).toUpperCase() + crop.type.slice(1)}</span>
                                    </div>
                                    <div class="crop-subtitle">
                                        ${crop.fieldName || 'Main Field'} â€¢ ${crop.acres + (crop.cents || 0)/100} acres
                                    </div>
                                </div>
                                <div>
                                    <div class="crop-status-badge">${crop.status}</div>
                                    <div style="font-size: 0.8rem; margin-top: 0.25rem;">
                                        ${profit >= 0 ? '+' : ''}â‚¹${formatCurrency(profit)}
                                    </div>
                                </div>
                            </div>
                            <div class="expand-icon">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                        
                        <div class="crop-content" id="crop-content-${crop.id}">
                            <!-- Growth Progress -->
                            <div class="progress-container">
                                <div class="progress-label">
                                    <span>Growth Progress</span>
                                    <span>${Math.round(progress)}%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${progress}%;"></div>
                                </div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary); text-align: center;">
                                    Expected harvest: ${harvestDate.toLocaleDateString()}
                                </div>
                            </div>

                            <!-- Crop Management Tabs -->
                            <div class="crop-tabs">
                                <div class="crop-tab active" onclick="showCropTab('${crop.id}', 'overview')">Overview</div>
                                <div class="crop-tab" onclick="showCropTab('${crop.id}', 'transactions')">Money</div>
                                <div class="crop-tab" onclick="showCropTab('${crop.id}', 'tips')">Tips</div>
                                <div class="crop-tab" onclick="showCropTab('${crop.id}', 'insurance')">Insurance</div>
                                <div class="crop-tab" onclick="showCropTab('${crop.id}', 'weather')">Weather</div>
                            </div>

                            <!-- Tab Content -->
                            <div id="crop-tab-${crop.id}">
                                ${createCropOverview(crop, revenue, expenses, profit)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createCropOverview(crop, revenue, expenses, profit) {
            return `
                <div class="crop-overview">
                    <!-- Financial Summary -->
                    <div class="grid-3" style="margin-bottom: 1rem;">
                        <div style="text-align: center; padding: 1rem; background: rgba(76, 175, 80, 0.1); border-radius: 8px;">
                            <div style="font-weight: 700; color: var(--success);">â‚¹${formatCurrency(revenue)}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Revenue</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: rgba(244, 67, 54, 0.1); border-radius: 8px;">
                            <div style="font-weight: 700; color: var(--danger);">â‚¹${formatCurrency(expenses)}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Expenses</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: rgba(255, 152, 0, 0.1); border-radius: 8px;">
                            <div style="font-weight: 700; color: ${profit >= 0 ? 'var(--success)' : 'var(--danger)'};">â‚¹${formatCurrency(Math.abs(profit))}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">${profit >= 0 ? 'Profit' : 'Loss'}</div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn btn-success btn-small" onclick="addCropTransaction('${crop.id}')">
                            <i class="fas fa-plus"></i> Add Transaction
                        </button>
                        <button class="btn btn-info btn-small" onclick="editCrop('${crop.id}')">
                            <i class="fas fa-edit"></i> Edit Crop
                        </button>
                        ${crop.status === 'active' ? `
                            <button class="btn btn-warning btn-small" onclick="harvestCrop('${crop.id}')">
                                <i class="fas fa-cut"></i> Mark Harvested
                            </button>
                        ` : ''}
                        <button class="btn btn-secondary btn-small" onclick="viewCropReport('${crop.id}')">
                            <i class="fas fa-chart-line"></i> Report
                        </button>
                    </div>
                </div>
            `;
        }

        // Weather Integration
        async function loadWeatherData(location) {
            try {
                // Mock weather data - in real app, integrate with weather API
                const weatherData = {
                    temperature: 28,
                    description: 'Partly Cloudy',
                    humidity: 65,
                    windSpeed: 12,
                    rainfall: 2.5,
                    recommendation: 'Good conditions for irrigation'
                };

                document.getElementById('weatherLocation').textContent = location;
                document.getElementById('weatherTemp').textContent = `${weatherData.temperature}Â°C`;
                document.getElementById('weatherDesc').textContent = weatherData.description;
                document.getElementById('weatherHumidity').textContent = `${weatherData.humidity}%`;
                document.getElementById('weatherWind').textContent = `${weatherData.windSpeed} km/h`;
                document.getElementById('weatherRain').textContent = `${weatherData.rainfall} mm`;
                
                showSuccess('Weather data updated for your location');
            } catch (error) {
                console.error('Weather loading failed:', error);
            }
        }

        // Transaction Management
        function loadTransactions() {
            const container = document.getElementById('transactionsList');
            if (!container) return;

            const transactions = appData.transactions || [];
            
            if (!transactions.length) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <i class="fas fa-receipt" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                        No transactions recorded yet
                    </div>
                `;
                return;
            }

            // Sort by date (newest first)
            const sortedTransactions = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            container.innerHTML = sortedTransactions.slice(0, 10).map(transaction => {
                const relatedItem = getRelatedItemName(transaction.relatedTo, transaction.relatedType);
                
                return `
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <div class="transaction-icon ${transaction.type}">
                                <i class="fas ${getTransactionIcon(transaction.type)}"></i>
                            </div>
                            <div class="transaction-details">
                                <div class="transaction-title">${transaction.description}</div>
                                <div class="transaction-meta">
                                    ${new Date(transaction.date).toLocaleDateString()} 
                                    ${relatedItem ? `â€¢ ${relatedItem}` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="transaction-amount ${transaction.type}">
                            ${transaction.type === 'income' ? '+' : '-'}â‚¹${formatCurrency(transaction.amount)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Asset Management
        function loadAssets() {
            updateAssetSummary();
            loadEquipmentList();
            loadLivestockList();
            loadInventoryList();
        }

        function updateAssetSummary() {
            const assets = appData.assets || {};
            
            const equipmentValue = (assets.equipment || []).reduce((sum, eq) => sum + eq.currentValue, 0);
            const livestockValue = (assets.livestock || []).reduce((sum, ls) => sum + ls.totalValue, 0);
            const landValue = (assets.land || []).reduce((sum, land) => sum + land.totalValue, 0);
            const inventoryValue = (assets.inventory || []).reduce((sum, inv) => sum + inv.totalValue, 0);

            document.getElementById('equipmentValue').textContent = `â‚¹${formatCurrency(equipmentValue)}`;
            document.getElementById('livestockValue').textContent = `â‚¹${formatCurrency(livestockValue)}`;
            document.getElementById('landValue').textContent = `â‚¹${formatCurrency(landValue)}`;
            document.getElementById('inventoryValue').textContent = `â‚¹${formatCurrency(inventoryValue)}`;
        }

        function loadEquipmentList() {
            const container = document.getElementById('equipmentList');
            const equipment = appData.assets.equipment || [];
            
            if (!equipment.length) return;

            container.innerHTML = equipment.map(eq => `
                <div class="transaction-item">
                    <div class="transaction-info">
                        <div class="transaction-icon" style="background: rgba(156, 39, 176, 0.1); color: #9c27b0;">
                            <i class="fas fa-${getEquipmentIcon(eq.type)}"></i>
                        </div>
                        <div class="transaction-details">
                            <div class="transaction-title">${eq.name}</div>
                            <div class="transaction-meta">${eq.type} â€¢ ${eq.condition}</div>
                        </div>
                    </div>
                    <div style="text-align: right; color: var(--text-primary); font-weight: 600;">
                        â‚¹${formatCurrency(eq.currentValue)}
                    </div>
                </div>
            `).join('');
        }

        function loadLivestockList() {
            const container = document.getElementById('livestockList');
            const livestock = appData.assets.livestock || [];
            
            if (!livestock.length) return;

            container.innerHTML = livestock.map(animal => `
                <div class="transaction-item">
                    <div class="transaction-info">
                        <div class="transaction-icon" style="background: rgba(76, 175, 80, 0.1); color: var(--success);">
                            <i class="fas fa-${getLivestockIcon(animal.type)}"></i>
                        </div>
                        <div class="transaction-details">
                            <div class="transaction-title">${animal.type} (${animal.quantity})</div>
                            <div class="transaction-meta">${animal.health} health â€¢ ${animal.dailyProduction || 0} ${animal.productionUnit}/day</div>
                        </div>
                    </div>
                    <div style="text-align: right; color: var(--text-primary); font-weight: 600;">
                        â‚¹${formatCurrency(animal.totalValue)}
                    </div>
                </div>
            `).join('');
        }

        function loadInventoryList() {
            const container = document.getElementById('inventoryList');
            const inventory = appData.assets.inventory || [];
            
            if (!inventory.length) return;

            container.innerHTML = inventory.map(item => `
                <div class="transaction-item">
                    <div class="transaction-info">
                        <div class="transaction-icon" style="background: rgba(255, 160, 0, 0.1); color: var(--secondary);">
                            <i class="fas fa-${getCategoryIcon(item.category)}"></i>
                        </div>
                        <div class="transaction-details">
                            <div class="transaction-title">${item.name}</div>
                            <div class="transaction-meta">${item.quantity} ${item.unit} â€¢ ${item.category}</div>
                        </div>
                    </div>
                    <div style="text-align: right; color: var(--text-primary); font-weight: 600;">
                        â‚¹${formatCurrency(item.totalValue)}
                    </div>
                </div>
            `).join('');
        }

        // Insurance Management
        function loadInsuranceData() {
            const container = document.getElementById('insuranceSchemes');
            if (!container) return;

            container.innerHTML = insuranceSchemes.map(scheme => `
                <div class="insurance-card ${scheme.secured ? 'active' : ''}" onclick="toggleInsurance('${scheme.name}')">
                    <div class="insurance-header">
                        <div>
                            <h5 style="color: var(--text-primary); margin-bottom: 0.5rem;">
                                <i class="fas fa-shield-alt"></i> ${scheme.name}
                            </h5>
                            <div class="insurance-badge ${scheme.type}">
                                ${scheme.type === 'government' ? 'ðŸ›ï¸ Government' : 'ðŸ¢ Private'}
                            </div>
                        </div>
                        ${scheme.secured ? `
                            <div class="insurance-badge secured">
                                <i class="fas fa-check"></i> Secured
                            </div>
                        ` : ''}
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <div style="font-size: 0.9rem; margin-bottom: 0.5rem;"><strong>Coverage:</strong> ${scheme.coverage}</div>
                        <div style="font-size: 0.9rem; margin-bottom: 0.5rem;"><strong>Premium:</strong> ${scheme.premium}</div>
                    </div>

                    <div style="display: flex; gap: 0.5rem;">
                        ${!scheme.secured ? `
                            <button class="btn btn-primary btn-small" onclick="applyInsurance('${scheme.name}'); event.stopPropagation();">
                                <i class="fas fa-shield-alt"></i> Apply
                            </button>
                        ` : ''}
                        <button class="btn btn-info btn-small" onclick="viewInsuranceDetails('${scheme.name}'); event.stopPropagation();">
                            <i class="fas fa-info"></i> Details
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Modal Functions
        function addNewCrop() {
            editingCrop = null;
            document.getElementById('cropModalTitle').textContent = 'Add New Crop';
            document.getElementById('saveCropText').textContent = 'Save Crop';
            resetCropForm();
            openModal('cropModal');
        }

        function addTransaction() {
            editingTransaction = null;
            resetTransactionForm();
            openModal('transactionModal');
        }

        function addAsset() {
            openModal('assetModal');
        }

        function addCropTransaction(cropId) {
            const crop = appData.crops.find(c => c.id === cropId);
            if (!crop) return;

            // Pre-fill transaction with crop info
            document.getElementById('transactionDescription').value = `Transaction for ${crop.type} - ${crop.fieldName || 'Main Field'}`;
            document.getElementById('relatedAsset').innerHTML = `
                <option value="${cropId}|crop" selected>ðŸŒ± ${crop.type} (${crop.fieldName || 'Main Field'})</option>
            `;
            
            openModal('transactionModal');
        }

        function editCrop(cropId) {
            const crop = appData.crops.find(c => c.id === cropId);
            if (!crop) return;

            editingCrop = crop;
            selectedCrop = crop.type;
            
            // Populate form
            document.getElementById('fieldName').value = crop.fieldName || '';
            document.getElementById('cropAcres').value = crop.acres;
            document.getElementById('cropCents').value = crop.cents || 0;
            document.getElementById('sowingDate').value = crop.sowingDate;
            document.getElementById('cropDuration').value = crop.duration;
            document.getElementById('expectedYield').value = crop.expectedYield || '';
            document.getElementById('expectedPrice').value = crop.expectedPrice || '';
            document.getElementById('cropNotes').value = crop.notes || '';

            document.getElementById('cropModalTitle').textContent = 'Edit Crop';
            document.getElementById('saveCropText').textContent = 'Update Crop';
            
            openModal('cropModal');
            
            // Select crop type
            setTimeout(() => {
                const cropOption = document.querySelector(`[data-crop="${crop.type}"]`);
                if (cropOption) selectCrop(cropOption);
            }, 100);
        }

        function editProfile() {
            if (!appData.profile) return;
            
            document.getElementById('editFirstName').value = appData.profile.firstName;
            document.getElementById('editLastName').value = appData.profile.lastName;
            document.getElementById('editFarmLocation').value = appData.profile.farmLocation;
            document.getElementById('editAltPhone').value = appData.profile.alternativePhone || '';
            
            openModal('profileModal');
        }

        // Save Functions
        async function saveCrop() {
            if (!selectedCrop) {
                showError('Please select a crop type');
                return;
            }

            const fieldName = document.getElementById('fieldName').value.trim();
            const acres = parseFloat(document.getElementById('cropAcres').value);
            const cents = parseInt(document.getElementById('cropCents').value || '0');
            const sowingDate = document.getElementById('sowingDate').value;
            const duration = parseInt(document.getElementById('cropDuration').value);
            const expectedYield = parseFloat(document.getElementById('expectedYield').value || '0');
            const expectedPrice = parseFloat(document.getElementById('expectedPrice').value || '0');
            const notes = document.getElementById('cropNotes').value.trim();

            if (!acres || acres <= 0) {
                showError('Please enter valid area');
                return;
            }

            if (!sowingDate || !duration) {
                showError('Please fill all required fields');
                return;
            }

            try {
                const cropData = {
                    id: editingCrop ? editingCrop.id : generateId(),
                    type: selectedCrop,
                    fieldName: fieldName || 'Main Field',
                    acres: acres,
                    cents: cents,
                    sowingDate: sowingDate,
                    duration: duration,
                    expectedYield: expectedYield,
                    expectedPrice: expectedPrice,
                    notes: notes,
                    status: 'active',
                    createdAt: editingCrop ? editingCrop.createdAt : new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                if (!appData.crops) appData.crops = [];

                if (editingCrop) {
                    const index = appData.crops.findIndex(c => c.id === editingCrop.id);
                    if (index !== -1) appData.crops[index] = cropData;
                    showSuccess('Crop updated successfully!');
                } else {
                    appData.crops.push(cropData);
                    showSuccess('New crop added successfully!');
                }

                await saveData();
                closeModal();
                loadCropsDisplay();
                updateFinancialSummary();
                loadCalendar();
                generateSmartSuggestions();
            } catch (error) {
                showError('Failed to save crop');
            }
        }

        async function saveTransaction() {
            const type = document.getElementById('transactionType').value;
            const category = document.getElementById('transactionCategory').value;
            const description = document.getElementById('transactionDescription').value.trim();
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            const date = document.getElementById('transactionDate').value;
            const relatedTo = document.getElementById('relatedAsset').value;

            if (!type || !category || !description || !amount || !date) {
                showError('Please fill all required fields');
                return;
            }

            try {
                const [relatedId, relatedType] = relatedTo ? relatedTo.split('|') : [null, null];
                
                const transactionData = {
                    id: generateId(),
                    type: type,
                    category: category,
                    description: description,
                    amount: amount,
                    date: date,
                    relatedTo: relatedId,
                    relatedType: relatedType,
                    createdAt: new Date().toISOString()
                };

                if (!appData.transactions) appData.transactions = [];
                appData.transactions.push(transactionData);

                await saveData();
                closeModal();
                loadTransactions();
                updateFinancialSummary();
                showSuccess('Transaction saved successfully!');
            } catch (error) {
                showError('Failed to save transaction');
            }
        }

        async function saveAsset() {
            const type = document.getElementById('assetType').value;
            if (!type) {
                showError('Please select asset type');
                return;
            }

            try {
                let assetData = { id: generateId(), type: type, createdAt: new Date().toISOString() };

                // Get type-specific data based on form fields
                const formData = new FormData(document.querySelector('#assetModal form') || document.createElement('form'));
                
                // This is a simplified version - in real implementation, 
                // you'd have specific forms for each asset type
                assetData.name = 'Sample Asset';
                assetData.value = 10000;
                assetData.status = 'active';

                if (!appData.assets[type]) appData.assets[type] = [];
                appData.assets[type].push(assetData);

                await saveData();
                closeModal();
                loadAssets();
                showSuccess('Asset added successfully!');
            } catch (error) {
                showError('Failed to save asset');
            }
        }

        async function saveProfile() {
            const firstName = document.getElementById('editFirstName').value.trim();
            const lastName = document.getElementById('editLastName').value.trim();
            const farmLocation = document.getElementById('editFarmLocation').value.trim();
            const altPhone = document.getElementById('editAltPhone').value.trim();

            if (!firstName || !lastName || !farmLocation) {
                showError('Please fill required fields');
                return;
            }

            try {
                appData.profile.firstName = firstName;
                appData.profile.lastName = lastName;
                appData.profile.farmLocation = farmLocation;
                appData.profile.alternativePhone = altPhone;
                appData.profile.updatedAt = new Date().toISOString();

                await saveData();
                closeModal();
                updateUserInfo();
                showSuccess('Profile updated successfully!');
            } catch (error) {
                showError('Failed to update profile');
            }
        }

        // UI Functions
        function showPage(pageName) {
            currentPage = pageName;
            
            const pages = ['authPage', 'registrationPage', 'dashboardPage'];
            pages.forEach(pageId => {
                const page = document.getElementById(pageId);
                if (page) page.style.display = pageId === `${pageName}Page` ? 'block' : 'none';
            });
        }

        function switchAuthTab(tabName) {
            document.querySelectorAll('.auth-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
            
            if (tabName === 'otp') {
                document.getElementById('otpVerification').classList.add('active');
            } else {
                const tab = document.querySelector(`[data-auth="${tabName}"]`);
                const form = document.getElementById(`${tabName}Auth`);
                
                if (tab) tab.classList.add('active');
                if (form) form.classList.add('active');
            }
        }

        function switchTab(tabName) {
            if (currentTab === tabName) return;
            
            currentTab = tabName;
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            const targetTab = document.getElementById(`${tabName}-tab`);
            if (targetTab) targetTab.classList.add('active');
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const activeNavItem = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeNavItem) activeNavItem.classList.add('active');

            // Load tab-specific data
            loadTabData();
        }

        function loadTabData() {
            switch (currentTab) {
                case 'crops':
                    loadCropsDisplay();
                    break;
                case 'money':
                    loadTransactions();
                    loadFinancialChart();
                    break;
                case 'assets':
                    loadAssets();
                    break;
                case 'innovations':
                    loadInsuranceData();
                    break;
            }
        }

        function toggleCropCard(cropCard) {
            const isExpanded = cropCard.classList.contains('expanded');
            
            // Collapse all crop cards
            document.querySelectorAll('.crop-card').forEach(card => {
                card.classList.remove('expanded');
                const content = card.querySelector('.crop-content');
                if (content) content.classList.remove('active');
            });
            
            // Expand clicked card if it wasn't already expanded
            if (!isExpanded) {
                cropCard.classList.add('expanded');
                const content = cropCard.querySelector('.crop-content');
                if (content) content.classList.add('active');
            }
        }

        function toggleCropDetails(cropId) {
            const cropCard = document.getElementById(`crop-${cropId}`);
            if (cropCard) toggleCropCard(cropCard);
        }

        function showCropTab(cropId, tabName) {
            const crop = appData.crops.find(c => c.id === cropId);
            if (!crop) return;

            const container = document.getElementById(`crop-tab-${cropId}`);
            if (!container) return;

            // Update tab buttons
            const cropContainer = document.getElementById(`crop-${cropId}`).parentElement;
            cropContainer.querySelectorAll('.crop-tab').forEach(tab => tab.classList.remove('active'));
            cropContainer.querySelector(`.crop-tab:nth-child(${getTabIndex(tabName)})`).classList.add('active');

            // Load tab content
            switch (tabName) {
                case 'overview':
                    const transactions = appData.transactions.filter(t => t.relatedTo === cropId) || [];
                    const revenue = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                    const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                    const profit = revenue - expenses;
                    container.innerHTML = createCropOverview(crop, revenue, expenses, profit);
                    break;
                case 'transactions':
                    container.innerHTML = createCropTransactions(cropId);
                    break;
                case 'tips':
                    container.innerHTML = createCropTips(crop);
                    break;
                case 'insurance':
                    container.innerHTML = createCropInsurance(crop);
                    break;
                case 'weather':
                    container.innerHTML = createCropWeather(crop);
                    break;
            }
        }

        function createCropTransactions(cropId) {
            const transactions = appData.transactions.filter(t => t.relatedTo === cropId) || [];
            
            if (!transactions.length) {
                return `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <i class="fas fa-receipt" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                        No transactions recorded for this crop
                        <br><button class="btn btn-primary btn-small" onclick="addCropTransaction('${cropId}')" style="margin-top: 1rem;">
                            <i class="fas fa-plus"></i> Add Transaction
                        </button>
                    </div>
                `;
            }

            return `
                <div style="margin-bottom: 1rem;">
                    <button class="btn btn-success btn-small" onclick="addCropTransaction('${cropId}')">
                        <i class="fas fa-plus"></i> Add Transaction
                    </button>
                </div>
                ${transactions.map(transaction => `
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <div class="transaction-icon ${transaction.type}">
                                <i class="fas ${getTransactionIcon(transaction.type)}"></i>
                            </div>
                            <div class="transaction-details">
                                <div class="transaction-title">${transaction.description}</div>
                                <div class="transaction-meta">${new Date(transaction.date).toLocaleDateString()}</div>
                            </div>
                        </div>
                        <div class="transaction-amount ${transaction.type}">
                            ${transaction.type === 'income' ? '+' : '-'}â‚¹${formatCurrency(transaction.amount)}
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function createCropTips(crop) {
            const cropInfo = cropTypes.find(c => c.name === crop.type) || {};
            
            return `
                <div class="crop-tips">
                    <h4 style="color: var(--text-primary); margin-bottom: 1rem;">
                        <i class="fas fa-lightbulb"></i> Management Tips for ${crop.type}
                    </h4>
                    
                    <div style="margin-bottom: 1rem;">
                        <div style="padding: 1rem; background: rgba(76, 175, 80, 0.1); border-radius: 8px; border-left: 4px solid var(--success);">
                            <h5><i class="fas fa-mountain"></i> Soil Requirements</h5>
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">
                                Best in ${cropInfo.soilTypes?.join(', ') || 'well-drained soil'}. Ensure proper pH levels and organic content.
                            </p>
                        </div>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <div style="padding: 1rem; background: rgba(33, 150, 243, 0.1); border-radius: 8px; border-left: 4px solid var(--info);">
                            <h5><i class="fas fa-tint"></i> Water Management</h5>
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">
                                ${cropInfo.waterRequirement || 'Moderate'} water requirement. Monitor soil moisture regularly.
                            </p>
                        </div>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <div style="padding: 1rem; background: rgba(255, 152, 0, 0.1); border-radius: 8px; border-left: 4px solid var(--warning);">
                            <h5><i class="fas fa-thermometer-half"></i> Weather Conditions</h5>
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">
                                Optimal temperature: ${cropInfo.optimalTemp?.min || 20}Â°C - ${cropInfo.optimalTemp?.max || 30}Â°C
                            </p>
                        </div>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <div style="padding: 1rem; background: rgba(244, 67, 54, 0.1); border-radius: 8px; border-left: 4px solid var(--danger);">
                            <h5><i class="fas fa-bug"></i> Pest Control</h5>
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">
                                ${cropInfo.tips || 'Regular monitoring for pests and diseases recommended.'}
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function createCropInsurance(crop) {
            const relevantSchemes = insuranceSchemes.filter(scheme => 
                scheme.coverage.includes('All') || scheme.coverage.toLowerCase().includes(crop.type)
            );

            return `
                <div class="crop-insurance">
                    <h4 style="color: var(--text-primary); margin-bottom: 1rem;">
                        <i class="fas fa-shield-alt"></i> Insurance for ${crop.type}
                    </h4>
                    
                    ${relevantSchemes.map(scheme => `
                        <div class="insurance-card ${scheme.secured ? 'active' : 'recommended'}">
                            <div class="insurance-header">
                                <div>
                                    <h5 style="margin-bottom: 0.5rem;">${scheme.name}</h5>
                                    <div class="insurance-badge ${scheme.type}">
                                        ${scheme.type === 'government' ? 'ðŸ›ï¸ Government' : 'ðŸ¢ Private'}
                                    </div>
                                </div>
                                ${scheme.secured ? '<div class="insurance-badge secured">âœ“ Secured</div>' : ''}
                            </div>
                            <div style="font-size: 0.9rem; margin-bottom: 1rem;">Premium: ${scheme.premium}</div>
                            ${!scheme.secured ? `
                                <button class="btn btn-primary btn-small" onclick="applyInsurance('${scheme.name}')">
                                    Apply Now
                                </button>
                            ` : ''}
                        </div>
                    `).join('')}

                    <div style="margin-top: 1rem; padding: 1rem; background: rgba(25, 118, 210, 0.1); border-radius: 8px;">
                        <h5 style="color: var(--info);">ðŸ“‹ PM Kisan Yojana Information</h5>
                        <p style="font-size: 0.9rem; margin: 0.5rem 0;">
                            Get â‚¹6000 annual financial support for farming families
                        </p>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">
                            <strong>Documents needed:</strong> Aadhaar, Land records, Bank account
                        </div>
                        <button class="btn btn-info btn-small" style="margin-top: 0.5rem;" onclick="showPMKisanInfo()">
                            <i class="fas fa-info-circle"></i> Learn More
                        </button>
                    </div>
                </div>
            `;
        }

        function createCropWeather(crop) {
            return `
                <div class="crop-weather">
                    <h4 style="color: var(--text-primary); margin-bottom: 1rem;">
                        <i class="fas fa-cloud-sun"></i> Weather Impact on ${crop.type}
                    </h4>
                    
                    <div style="margin-bottom: 1rem;">
                        <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span>Current Temperature</span>
                                <span style="font-weight: 700;">28Â°C</span>
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">
                                Optimal for ${crop.type} growth
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <div style="padding: 1rem; background: rgba(76, 175, 80, 0.1); border-radius: 8px;">
                            <h5 style="color: var(--success);">â˜€ï¸ Today's Recommendation</h5>
                            <p style="font-size: 0.9rem; margin: 0.5rem 0 0 0;">
                                Good weather for irrigation. Check soil moisture in ${crop.fieldName || 'field'}.
                            </p>
                        </div>
                    </div>

                    <div>
                        <div style="padding: 1rem; background: rgba(255, 152, 0, 0.1); border-radius: 8px;">
                            <h5 style="color: var(--warning);">ðŸŒ§ï¸ 7-Day Forecast Alert</h5>
                            <p style="font-size: 0.9rem; margin: 0.5rem 0 0 0;">
                                Rain expected in 3 days. Consider completing any pending spraying activities.
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Utility Functions
        function toggleCropSelection(element) {
            element.classList.toggle('selected');
        }

        function selectCrop(element) {
            document.querySelectorAll('#cropTypeSelection .crop-option').forEach(el => 
                el.classList.remove('selected')
            );
            element.classList.add('selected');
            selectedCrop = element.dataset.crop;

            // Auto-fill duration
            const cropInfo = cropTypes.find(c => c.name === selectedCrop);
            if (cropInfo) {
                document.getElementById('cropDuration').value = cropInfo.duration;
            }
        }

        function updateTransactionCategories() {
            const type = document.getElementById('transactionType').value;
            const categorySelect = document.getElementById('transactionCategory');
            const relatedGroup = document.getElementById('relatedAssetGroup');

            if (!type) {
                categorySelect.innerHTML = '<option value="">First select type</option>';
                relatedGroup.style.display = 'none';
                return;
            }

            const categories = transactionCategories[type] || transactionCategories[type.includes('income') ? 'income' : 'expense'] || [];
            categorySelect.innerHTML = categories.map(cat => 
                `<option value="${cat.value}">${cat.label}</option>`
            ).join('');

            // Show related asset selection
            relatedGroup.style.display = 'block';
            updateRelatedAssets();
        }

        function updateRelatedAssets() {
            const relatedSelect = document.getElementById('relatedAsset');
            let options = '<option value="">Select related item (optional)</option>';

            // Add crops
            (appData.crops || []).forEach(crop => {
                options += `<option value="${crop.id}|crop">ðŸŒ± ${crop.type} (${crop.fieldName || 'Main Field'})</option>`;
            });

            // Add equipment
            (appData.assets.equipment || []).forEach(eq => {
                options += `<option value="${eq.id}|equipment">ðŸšœ ${eq.name}</option>`;
            });

            // Add livestock
            (appData.assets.livestock || []).forEach(animal => {
                options += `<option value="${animal.id}|livestock">ðŸ„ ${animal.type} (${animal.quantity})</option>`;
            });

            relatedSelect.innerHTML = options;
        }

        function updateAssetForm() {
            const type = document.getElementById('assetType').value;
            const fieldsContainer = document.getElementById('assetFormFields');
            
            if (!type || !fieldsContainer) return;

            // Simplified asset form - in real app, you'd have full forms for each type
            fieldsContainer.innerHTML = `
                <div class="form-group">
                    <label>Asset Name</label>
                    <input type="text" class="form-control" placeholder="Enter asset name" required>
                </div>
                <div class="form-group">
                    <label>Value (â‚¹)</label>
                    <input type="number" class="form-control" placeholder="Current value" min="0" required>
                </div>
            `;
        }

        function selectMonth(monthIndex) {
            selectedMonth = monthIndex;
            const months = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];
            
            // Update calendar
            document.querySelectorAll('.month-card').forEach((card, index) => {
                card.classList.toggle('active', index === monthIndex);
            });

            // Show month details
            const monthDetailsContainers = ['monthDetails', 'calendarMonthDetails'];
            monthDetailsContainers.forEach(id => {
                const container = document.getElementById(id);
                if (container) {
                    container.style.display = 'block';
                    const nameSpan = container.querySelector('#selectedMonthName, #calendarSelectedMonth');
                    if (nameSpan) nameSpan.textContent = months[monthIndex];
                }
            });

            // Load month activities
            const activities = calculateMonthlyActivities()[monthIndex] || [];
            const activitiesHTML = activities.map(activity => `
                <div class="suggestion-card ${activity.priority}">
                    <div class="suggestion-header">
                        <div class="suggestion-icon" style="background: ${getPriorityColor(activity.priority)}15; color: ${getPriorityColor(activity.priority)};">
                            <i class="fas fa-${getActivityIcon(activity.activity || activity.type)}"></i>
                        </div>
                        <div class="suggestion-title">${activity.description}</div>
                    </div>
                    <div class="suggestion-desc">Crop: ${activity.crop} ${activity.fieldName ? `â€¢ Field: ${activity.fieldName}` : ''}</div>
                </div>
            `).join('');

            const activityContainers = ['monthActivities', 'calendarActivities'];
            activityContainers.forEach(id => {
                const container = document.getElementById(id);
                if (container) container.innerHTML = activitiesHTML || '<p style="text-align: center; color: var(--text-secondary);">No activities for this month</p>';
            });
        }

        function changeYear(delta) {
            currentYear += delta;
            setCurrentDate();
        }

        function changeCalendarYear(delta) {
            currentYear += delta;
            document.getElementById('calendarYear').textContent = currentYear;
            loadCalendar();
        }

        // Theme and Language Functions
        function toggleTheme() {
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            changeTheme(newTheme);
        }

        function changeTheme(theme) {
            currentTheme = theme;
            applyTheme(theme);
            localStorage.setItem('jama_theme', theme);
            
            // Update theme selector
            const themeSelect = document.getElementById('themeSelect');
            if (themeSelect) themeSelect.value = theme;
            
            // Update toggle icon
            const toggleIcon = document.querySelector('#themeToggle i');
            if (toggleIcon) {
                toggleIcon.className = theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
            }
        }

        function applyTheme(theme) {
            document.body.setAttribute('data-theme', theme);
        }

        function changeLanguage(lang) {
            currentLanguage = lang;
            
            // Hide all language content
            document.querySelectorAll('.language-content').forEach(el => {
                el.classList.remove('active');
            });
            
            // Show selected language content
            document.querySelectorAll(`[data-lang="${lang}"]`).forEach(el => {
                el.classList.add('active');
            });

            // Save language preference
            if (appData.settings) {
                appData.settings.language = lang;
                saveData();
            }

            showSuccess('Language updated successfully!');
        }

        // Floating Action Button
        function toggleFabMenu() {
            fabMenuOpen = !fabMenuOpen;
            const menu = document.getElementById('fabMenu');
            const mainBtn = document.getElementById('fabMain');
            
            if (fabMenuOpen) {
                menu.classList.add('active');
                mainBtn.innerHTML = '<i class="fas fa-times"></i>';
            } else {
                menu.classList.remove('active');
                mainBtn.innerHTML = '<i class="fas fa-plus"></i>';
            }
        }

        function closeFabMenu() {
            fabMenuOpen = false;
            document.getElementById('fabMenu').classList.remove('active');
            document.getElementById('fabMain').innerHTML = '<i class="fas fa-plus"></i>';
        }

        // Modal Functions
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
                
                // Initialize modal content
                switch (modalId) {
                    case 'cropModal':
                        populateCropSelections();
                        break;
                    case 'transactionModal':
                        updateTransactionCategories();
                        break;
                    case 'assetModal':
                        updateAssetForm();
                        break;
                }
            }
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
            document.body.style.overflow = 'auto';
            resetForms();
        }

        function resetForms() {
            // Reset form inputs
            document.querySelectorAll('.modal input, .modal textarea, .modal select').forEach(input => {
                if (input.type === 'checkbox') {
                    input.checked = false;
                } else if (input.type === 'date') {
                    input.value = new Date().toISOString().split('T')[0];
                } else {
                    input.value = '';
                }
            });

            // Reset selections
            document.querySelectorAll('.crop-option').forEach(option => {
                option.classList.remove('selected');
            });

            selectedCrop = null;
            editingCrop = null;
        }

        function resetCropForm() {
            resetForms();
        }

        function resetTransactionForm() {
            resetForms();
            updateTransactionCategories();
        }

        // Filter Functions
        function handleFilterClick(button) {
            // Remove active from all filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            const filter = button.dataset.filter;
            filterTransactionsByType(filter);
        }

        function filterTransactionsByType(filter) {
            let transactions = appData.transactions || [];
            
            if (filter !== 'all') {
                if (filter === 'loans') {
                    transactions = transactions.filter(t => 
                        ['loan-given', 'loan-taken', 'loan-payment'].includes(t.type)
                    );
                } else {
                    transactions = transactions.filter(t => t.type === filter);
                }
            }

            displayFilteredTransactions(transactions);
        }

        function displayFilteredTransactions(transactions) {
            const container = document.getElementById('transactionsList');
            if (!container) return;

            if (!transactions.length) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        No transactions found for selected filter
                    </div>
                `;
                return;
            }

            container.innerHTML = transactions.slice(0, 20).map(transaction => {
                const relatedItem = getRelatedItemName(transaction.relatedTo, transaction.relatedType);
                
                return `
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <div class="transaction-icon ${transaction.type}">
                                <i class="fas ${getTransactionIcon(transaction.type)}"></i>
                            </div>
                            <div class="transaction-details">
                                <div class="transaction-title">${transaction.description}</div>
                                <div class="transaction-meta">
                                    ${new Date(transaction.date).toLocaleDateString()} 
                                    ${relatedItem ? `â€¢ ${relatedItem}` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="transaction-amount ${transaction.type}">
                            ${transaction.type === 'income' ? '+' : '-'}â‚¹${formatCurrency(transaction.amount)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Crop Action Functions
        function harvestCrop(cropId) {
            const crop = appData.crops.find(c => c.id === cropId);
            if (!crop) return;

            if (confirm(`Mark ${crop.type} in ${crop.fieldName || 'Main Field'} as harvested?`)) {
                crop.status = 'harvested';
                crop.harvestDate = new Date().toISOString().split('T')[0];
                crop.updatedAt = new Date().toISOString();
                
                saveData();
                loadCropsDisplay();
                showSuccess(`${crop.type} marked as harvested!`);
            }
        }

        function viewCropReport(cropId) {
            const crop = appData.crops.find(c => c.id === cropId);
            if (!crop) return;

            const transactions = appData.transactions.filter(t => t.relatedTo === cropId) || [];
            const revenue = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const profit = revenue - expenses;
            const roi = expenses > 0 ? ((profit / expenses) * 100) : 0;

            const report = `
CROP PERFORMANCE REPORT

ðŸŒ¾ ${crop.type.toUpperCase()} - ${crop.fieldName || 'MAIN FIELD'}
ðŸ“ Area: ${crop.acres + (crop.cents || 0)/100} acres
ðŸ“… Sown: ${new Date(crop.sowingDate).toLocaleDateString()}
ðŸ“Š Status: ${crop.status.toUpperCase()}

ðŸ’° FINANCIAL SUMMARY:
â€¢ Total Revenue: â‚¹${formatCurrency(revenue)}
â€¢ Total Expenses: â‚¹${formatCurrency(expenses)}
â€¢ Net Profit/Loss: â‚¹${formatCurrency(profit)}
â€¢ ROI: ${roi.toFixed(1)}%

ðŸ“ˆ TRANSACTIONS (${transactions.length}):
${transactions.map(t => 
    `â€¢ ${new Date(t.date).toLocaleDateString()} - ${t.description}: ${t.type === 'income' ? '+' : '-'}â‚¹${formatCurrency(t.amount)}`
).join('\n')}

${crop.notes ? `\nðŸ“ NOTES: ${crop.notes}` : ''}
            `;
            
            alert(report);
        }

        // Chart Functions
        function loadFinancialChart() {
            const ctx = document.getElementById('financialChart');
            if (!ctx) return;

            const transactions = appData.transactions || [];
            const last6Months = [];
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                
                const monthTransactions = transactions.filter(t => {
                    const tDate = new Date(t.date);
                    return tDate.getMonth() === date.getMonth() && tDate.getFullYear() === date.getFullYear();
                });
                
                const income = monthTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const expenses = monthTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                
                last6Months.push({
                    month: date.toLocaleDateString('en-US', { month: 'short' }),
                    income,
                    expenses,
                    profit: income - expenses
                });
            }

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last6Months.map(m => m.month),
                    datasets: [
                        {
                            label: 'Income',
                            data: last6Months.map(m => m.income),
                            borderColor: '#4caf50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Expenses',
                            data: last6Months.map(m => m.expenses),
                            borderColor: '#f44336',
                            backgroundColor: 'rgba(244, 67, 54, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => 'â‚¹' + formatCurrency(value)
                            }
                        }
                    }
                }
            });
        }

        // Loan Functions
        function addLoanGiven() {
            document.getElementById('transactionType').value = 'loan-given';
            updateTransactionCategories();
            openModal('transactionModal');
        }

        function addLoanTaken() {
            document.getElementById('transactionType').value = 'loan-taken';
            updateTransactionCategories();
            openModal('transactionModal');
        }

        // Insurance Functions
        function applyInsurance(schemeName) {
            const scheme = insuranceSchemes.find(s => s.name === schemeName);
            if (!scheme) return;

            scheme.secured = true;
            showSuccess(`Applied for ${schemeName} successfully!`);
            loadInsuranceData();
        }

        function viewInsuranceDetails(schemeName) {
            const scheme = insuranceSchemes.find(s => s.name === schemeName);
            if (!scheme) return;

            const details = `
INSURANCE SCHEME DETAILS

ðŸ“‹ ${scheme.name}
ðŸ›ï¸ Type: ${scheme.type}
ðŸŒ¾ Coverage: ${scheme.coverage}
ðŸ’° Premium: ${scheme.premium}

âœ… Benefits:
${scheme.benefits.map(benefit => `â€¢ ${benefit}`).join('\n')}

ðŸ“„ Required Documents:
${scheme.documents.map(doc => `â€¢ ${doc}`).join('\n')}

ðŸŒ Website: ${scheme.website}
            `;
            
            alert(details);
        }

        function showPMKisanInfo() {
            const info = `
PM KISAN YOJANA INFORMATION

ðŸ’° Financial Support: â‚¹6000 per year
ðŸ‘¨â€ðŸŒ¾ Eligibility: Small & marginal farmers
ðŸ“‹ Payment: â‚¹2000 in 3 installments

ðŸ“„ Required Documents:
â€¢ Aadhaar Card
â€¢ Bank Account Details
â€¢ Land Ownership Records
â€¢ Mobile Number

ðŸ›ï¸ How to Apply:
1. Visit pmkisan.gov.in
2. Click on 'Farmer Corner'
3. Select 'New Farmer Registration'
4. Fill required details
5. Submit application

ðŸ“ž Helpline: 155261
            `;
            
            alert(info);
        }

        // Innovation Functions
        function openPlantixIntegration() {
            showSuccess('Plantix integration coming soon! ðŸ“±');
        }

        function showSensorInfo() {
            const info = `
SMART SENSOR TECHNOLOGY

ðŸ“¡ IoT Soil Sensors:
â€¢ Monitor soil moisture, pH, nutrients
â€¢ Real-time alerts to your phone
â€¢ Optimize irrigation automatically

ðŸ’° Cost: â‚¹15,000 - â‚¹50,000 per set
ðŸŽ¯ Subsidy: Up to 50% under MIDH scheme

ðŸ“‹ Benefits:
â€¢ 30% water savings
â€¢ 20% fertilizer optimization
â€¢ 15% yield improvement

ðŸ“ž Contact dealer for installation
            `;
            
            alert(info);
        }

        // Data Export
        async function exportData() {
            try {
                const exportData = {
                    profile: appData.profile,
                    crops: appData.crops,
                    transactions: appData.transactions,
                    assets: appData.assets,
                    exportDate: new Date().toISOString()
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `Jama_Farm_Data_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                showSuccess('Farm data exported successfully!');
            } catch (error) {
                showError('Export failed. Please try again.');
            }
        }

        // Logout
        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await saveData();
                    
                    localStorage.removeItem('jama_current_user');
                    localStorage.removeItem('jama_app_data');
                    
                    // Reset state
                    currentUser = null;
                    appData = {
                        profile: null,
                        crops: [],
                        transactions: [],
                        assets: { equipment: [], livestock: [], inventory: [], land: [] },
                        settings: { language: 'en', theme: 'light' }
                    };
                    
                    // Show auth page and hide navigation
                    showPage('auth');
                    document.getElementById('appContainer').classList.add('auth-mode');
                    document.getElementById('miniHeader').classList.add('hidden');
                    document.getElementById('mobileNav').classList.add('hidden');
                    document.getElementById('quickAccess').classList.add('hidden');
                    
                    showSuccess('Logged out successfully!');
                } catch (error) {
                    showError('Logout failed');
                }
            }
        }

        // Utility Functions
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        function formatCurrency(amount) {
            if (amount >= 10000000) return (amount / 10000000).toFixed(1) + 'Cr';
            if (amount >= 100000) return (amount / 100000).toFixed(1) + 'L';
            if (amount >= 1000) return (amount / 1000).toFixed(1) + 'K';
            return amount.toLocaleString('en-IN');
        }

        function getPriorityColor(priority) {
            const colors = {
                urgent: 'var(--danger)',
                critical: 'var(--danger)',
                high: 'var(--warning)',
                important: 'var(--warning)',
                medium: 'var(--info)',
                recommended: 'var(--info)',
                low: 'var(--gray)'
            };
            return colors[priority] || 'var(--gray)';
        }

        function getActivityIcon(activity) {
            const icons = {
                irrigation: 'tint',
                harvest: 'cut',
                sowing: 'seedling',
                fertilizer: 'flask',
                'pest-control': 'bug',
                weeding: 'leaf',
                monitoring: 'eye',
                'land-prep': 'tools',
                planning: 'calendar'
            };
            return icons[activity] || 'calendar-check';
        }

        function getTransactionIcon(type) {
            const icons = {
                income: 'arrow-up',
                expense: 'arrow-down',
                'loan-given': 'hand-holding-usd',
                'loan-taken': 'handshake',
                'loan-payment': 'credit-card'
            };
            return icons[type] || 'receipt';
        }

        function getEquipmentIcon(type) {
            const icons = {
                tractor: 'tractor',
                harvester: 'cut',
                pump: 'tint',
                sprayer: 'spray-can',
                other: 'cog'
            };
            return icons[type] || 'cog';
        }

        function getLivestockIcon(type) {
            const icons = {
                cow: 'cow',
                buffalo: 'hippo',
                goat: 'horse-head',
                sheep: 'sheep',
                chicken: 'kiwi-bird',
                other: 'paw'
            };
            return icons[type] || 'paw';
        }

        function getCategoryIcon(category) {
            const icons = {
                seeds: 'seedling',
                fertilizer: 'flask',
                pesticide: 'bug',
                tools: 'tools',
                feed: 'bone',
                fuel: 'gas-pump',
                other: 'box'
            };
            return icons[category] || 'box';
        }

        function getRelatedItemName(relatedId, relatedType) {
            if (!relatedId || !relatedType) return null;

            switch (relatedType) {
                case 'crop':
                    const crop = appData.crops.find(c => c.id === relatedId);
                    return crop ? `${crop.type} (${crop.fieldName || 'Main Field'})` : null;
                case 'equipment':
                    const equipment = appData.assets.equipment.find(eq => eq.id === relatedId);
                    return equipment ? equipment.name : null;
                case 'livestock':
                    const animal = appData.assets.livestock.find(ls => ls.id === relatedId);
                    return animal ? `${animal.type} (${animal.quantity})` : null;
                default:
                    return null;
            }
        }

        function getTabIndex(tabName) {
            const tabOrder = ['overview', 'transactions', 'tips', 'insurance', 'weather'];
            return tabOrder.indexOf(tabName) + 1;
        }

        // Message Functions
        function showError(message) { showMessage('error', message); }
        function showSuccess(message) { showMessage('success', message); }
        function showWarning(message) { showMessage('warning', message); }

        function showMessage(type, message) {
            hideAllMessages();
            const messageElement = document.getElementById(`${type}Message`);
            if (messageElement) {
                messageElement.textContent = message;
                messageElement.style.display = 'block';
                setTimeout(() => messageElement.style.display = 'none', 5000);
            }
        }

        function hideAllMessages() {
            ['errorMessage', 'successMessage', 'warningMessage'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.style.display = 'none';
            });
        }

        function showLoading(message) { console.log('Loading:', message); }
        function hideLoading() { console.log('Loading complete'); }

        function showNotificationBanner(message) {
            const banner = document.getElementById('notificationBanner');
            const text = document.getElementById('notificationText');
            
            if (banner && text) {
                text.textContent = message;
                banner.classList.add('show');
                setTimeout(() => banner.classList.remove('show'), 8000);
            }
        }

        function closeNotification() {
            document.getElementById('notificationBanner').classList.remove('show');
        }

        // Add CSS for crop options
        const additionalCSS = `
            .crop-option {
                border: 2px solid var(--border-color);
                border-radius: var(--border-radius);
                padding: 1rem 0.5rem;
                text-align: center;
                cursor: pointer;
                transition: var(--transition);
                background: var(--bg-primary);
                position: relative;
            }

            .crop-option:hover {
                border-color: var(--primary);
                transform: translateY(-2px);
                box-shadow: var(--box-shadow);
            }

            .crop-option.selected {
                border-color: var(--primary);
                background: rgba(46, 125, 50, 0.1);
            }

            .crop-option.selected::after {
                content: 'âœ“';
                position: absolute;
                top: 5px;
                right: 5px;
                background: var(--primary);
                color: white;
                border-radius: 50%;
                width: 20px;
                height: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 0.7rem;
                font-weight: 700;
            }

            .chart-container {
                background: var(--bg-primary);
                border-radius: var(--border-radius);
                padding: 1rem;
                margin-bottom: 1rem;
                box-shadow: var(--box-shadow);
                border: 1px solid var(--border-color);
            }
        `;

        // Add the CSS to the document
        const styleElement = document.createElement('style');
        styleElement.textContent = additionalCSS;
        document.head.appendChild(styleElement);

        // Apply saved theme on load
        document.addEventListener('DOMContentLoaded', function() {
            applyTheme(currentTheme);
        });
    </script>
</body>
</html>
