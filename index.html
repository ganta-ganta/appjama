<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JamaApp - Smart Farm Management System</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+Devanagari:wght@300;400;500;600;700&family=Noto+Sans+Telugu:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2E7D32;
            --secondary-color: #4CAF50;
            --accent-color: #FF6B35;
            --background-light: #F8FAFC;
            --background-dark: #0F172A;
            --text-primary: #1E293B;
            --text-secondary: #64748B;
            --card-bg: #FFFFFF;
            --border-color: #E2E8F0;
            --success-color: #10B981;
            --warning-color: #F59E0B;
            --error-color: #EF4444;
            --info-color: #3B82F6;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --border-radius: 16px;
            --border-radius-lg: 20px;
            --gradient-primary: linear-gradient(135deg, #2E7D32, #4CAF50);
            --gradient-accent: linear-gradient(135deg, #FF6B35, #FF8A65);
            --gradient-success: linear-gradient(135deg, #10B981, #34D399);
            --gradient-info: linear-gradient(135deg, #3B82F6, #60A5FA);
            --gradient-card: linear-gradient(145deg, #ffffff, #f8fafc);
        }

        [data-theme="dark"] {
            --background-light: #0F172A;
            --background-dark: #1E293B;
            --card-bg: #1E293B;
            --text-primary: #F1F5F9;
            --text-secondary: #94A3B8;
            --border-color: #334155;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            --gradient-card: linear-gradient(145deg, #1e293b, #0f172a);
        }

        body {
            font-family: 'Inter', 'Noto Sans Devanagari', 'Noto Sans Telugu', sans-serif;
            background: var(--background-light);
            color: var(--text-primary);
            line-height: 1.6;
            transition: all 0.3s ease;
            overflow-x: hidden;
        }

        /* Enhanced Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient-primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            color: white;
        }

        .loading-logo {
            font-size: 4rem;
            font-weight: bold;
            margin-bottom: 2rem;
            animation: pulse 2s infinite;
            display: flex;
            align-items: center;
            gap: 1rem;
            text-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .loading-logo i {
            font-size: 5rem;
            animation: rotate 3s linear infinite;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
        }

        .loading-progress {
            width: 320px;
            height: 12px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            overflow: hidden;
            margin-top: 2rem;
            backdrop-filter: blur(10px);
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #fff, #a5d6a7, #4caf50);
            border-radius: 8px;
            animation: loading 3s ease-in-out forwards;
            box-shadow: 0 0 20px rgba(255,255,255,0.5);
        }

        @keyframes loading {
            from { width: 0%; }
            to { width: 100%; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.9; transform: scale(1.05); }
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        /* Enhanced Authentication */
        .auth-container {
            min-height: 100vh;
            background: var(--gradient-primary);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            position: relative;
            overflow: hidden;
        }

        .auth-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: url('https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?w=1200&h=800&fit=crop&auto=format&q=60') center/cover;
            opacity: 0.1;
            z-index: 0;
        }

        .auth-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 3rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            width: 100%;
            max-width: 520px;
            text-align: center;
            position: relative;
            z-index: 1;
            animation: bounceIn 0.8s ease-out;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .auth-logo {
            font-size: 3.2rem;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            text-shadow: 0 2px 10px rgba(46, 125, 50, 0.2);
        }

        /* Enhanced Main App */
        .app-container {
            display: none;
            min-height: 100vh;
        }

        .app-header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        [data-theme="dark"] .app-header {
            background: rgba(30,41,59,0.95);
        }

        .app-logo {
            font-size: 2.5rem;
            font-weight: bold;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            filter: drop-shadow(0 2px 4px rgba(46, 125, 50, 0.2));
        }

        .header-actions {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .weather-display {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));
            padding: 0.75rem 1.5rem;
            border-radius: 30px;
            color: var(--info-color);
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s ease;
            border: 1px solid rgba(59, 130, 246, 0.2);
            backdrop-filter: blur(10px);
        }

        .weather-display:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1));
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2);
        }

        /* Enhanced Sidebar */
        .main-content {
            display: flex;
            min-height: calc(100vh - 92px);
        }

        .sidebar {
            width: 300px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--border-color);
            padding: 2rem 0;
            overflow-y: auto;
            box-shadow: var(--shadow);
        }

        [data-theme="dark"] .sidebar {
            background: rgba(30,41,59,0.95);
        }

        .sidebar-nav {
            list-style: none;
            padding: 0 1.5rem;
        }

        .sidebar-nav li {
            margin: 0.75rem 0;
        }

        .sidebar-nav a {
            display: flex;
            align-items: center;
            padding: 1.25rem 2rem;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.4s ease;
            border-radius: var(--border-radius);
            font-weight: 500;
            font-size: 1.1rem;
            position: relative;
            overflow: hidden;
        }

        .sidebar-nav a::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--gradient-primary);
            transition: left 0.4s ease;
            z-index: -1;
        }

        .sidebar-nav a:hover::before,
        .sidebar-nav a.active::before {
            left: 0;
        }

        .sidebar-nav a:hover,
        .sidebar-nav a.active {
            color: white;
            transform: translateX(8px);
            box-shadow: 0 8px 25px rgba(46, 125, 50, 0.3);
        }

        .sidebar-nav i {
            margin-right: 1rem;
            width: 28px;
            text-align: center;
            font-size: 1.3rem;
            transition: transform 0.3s ease;
        }

        .sidebar-nav a:hover i {
            transform: scale(1.1);
        }

        /* Enhanced Content Area */
        .content-area {
            flex: 1;
            padding: 2.5rem;
            overflow-y: auto;
            background: var(--background-light);
        }

        /* Enhanced Cards */
        .card {
            background: var(--gradient-card);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            transform: scaleX(0);
            transition: transform 0.4s ease;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .card:hover::before {
            transform: scaleX(1);
        }

        /* Enhanced Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            text-align: center;
            padding: 2.5rem;
            position: relative;
            overflow: hidden;
            background: var(--gradient-card);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: all 0.4s ease;
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(46, 125, 50, 0.05), transparent);
            transform: scale(0);
            transition: transform 0.6s ease;
        }

        .stat-card:hover::after {
            transform: scale(1.5);
        }

        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-xl);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 1.5rem 0;
            text-shadow: 0 2px 10px rgba(46, 125, 50, 0.2);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-change {
            font-size: 0.9rem;
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-weight: 600;
            display: inline-block;
        }

        .stat-change.positive {
            color: var(--success-color);
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .stat-change.negative {
            color: var(--error-color);
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        /* Enhanced Weather Widget */
        .weather-widget {
            background: var(--gradient-primary);
            color: white;
            text-align: center;
            position: relative;
            overflow: hidden;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
        }

        .weather-widget::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1), transparent);
            animation: float 6s ease-in-out infinite;
        }

        .weather-temp {
            font-size: 3rem;
            font-weight: 700;
            margin: 2rem 0;
            text-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .weather-desc {
            font-size: 1.2rem;
            opacity: 0.95;
            margin-bottom: 1.5rem;
            font-weight: 500;
        }

        .weather-icon {
            font-size: 4rem;
            margin-bottom: 2rem;
            filter: drop-shadow(0 4px 15px rgba(0,0,0,0.2));
            animation: float 4s ease-in-out infinite;
        }

        /* Enhanced Quick Links */
        .quick-links {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin: 3rem 0;
        }

        .quick-link {
            background: var(--gradient-card);
            padding: 2rem;
            border-radius: var(--border-radius);
            text-align: center;
            text-decoration: none;
            color: var(--text-primary);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .quick-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(46, 125, 50, 0.1), transparent);
            transition: left 0.6s ease;
        }

        .quick-link:hover::before {
            left: 100%;
        }

        .quick-link:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-xl);
            color: var(--primary-color);
        }

        .quick-link i {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: var(--primary-color);
            transition: transform 0.4s ease;
        }

        .quick-link:hover i {
            transform: scale(1.1) rotate(5deg);
        }

        .quick-link h4 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .quick-link p {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Enhanced Crop Cards */
        .crop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 2rem;
        }

        .crop-card {
            position: relative;
            overflow: hidden;
            background: var(--gradient-card);
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .crop-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: var(--gradient-success);
            transform: scaleX(0);
            transition: transform 0.4s ease;
        }

        .crop-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-xl);
        }

        .crop-card:hover::before {
            transform: scaleX(1);
        }

        .crop-header {
            padding: 2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            transition: all 0.4s ease;
            background: linear-gradient(135deg, rgba(255,255,255,0.02), rgba(46, 125, 50, 0.02));
        }

        .crop-header:hover {
            background: linear-gradient(135deg, rgba(46, 125, 50, 0.05), rgba(76, 175, 80, 0.03));
        }

        .crop-image {
            width: 100px;
            height: 100px;
            border-radius: var(--border-radius);
            object-fit: cover;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.4s ease;
        }

        .crop-header:hover .crop-image {
            transform: scale(1.05);
        }

        .crop-info {
            flex: 1;
        }

        .crop-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(46, 125, 50, 0.1);
        }

        .crop-details {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .crop-status {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .crop-status.active {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .crop-status.harvested {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .crop-status.planned {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info-color);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .crop-collapse {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .crop-collapse.active {
            max-height: 2000px;
        }

        .crop-content {
            padding: 2rem;
            border-top: 1px solid var(--border-color);
            background: linear-gradient(135deg, rgba(248, 250, 252, 0.5), rgba(255, 255, 255, 0.2));
        }

        /* Enhanced Buttons */
        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 15px rgba(46, 125, 50, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(46, 125, 50, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--text-secondary), #94A3B8);
            color: white;
            box-shadow: 0 4px 15px rgba(100, 116, 139, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #FBBF24);
            color: white;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }

        .btn-info {
            background: var(--gradient-info);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .btn-success {
            background: var(--gradient-success);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--error-color), #F87171);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-sm {
            padding: 0.75rem 1.5rem;
            font-size: 0.9rem;
        }

        .btn:hover {
            transform: translateY(-3px);
        }

        /* Enhanced Form Controls */
        .form-group {
            margin-bottom: 2rem;
            position: relative;
        }

        .form-group label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-control-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .form-control {
            width: 100%;
            padding: 1rem 1.25rem;
            padding-left: 3rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.4s ease;
            background: var(--card-bg);
            color: var(--text-primary);
            backdrop-filter: blur(10px);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(46, 125, 50, 0.1);
            transform: translateY(-2px);
        }

        .form-icon {
            position: absolute;
            left: 1rem;
            color: var(--text-secondary);
            font-size: 1.1rem;
            z-index: 2;
            transition: color 0.3s ease;
        }

        .form-control:focus + .form-icon,
        .form-control:not(:placeholder-shown) + .form-icon {
            color: var(--primary-color);
        }

        /* Enhanced Form with Icons */
        .input-group {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            padding-left: 3.5rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            transition: all 0.3s ease;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
        }

        .input-group .input-icon {
            position: absolute;
            left: 1.25rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 1.1rem;
            z-index: 2;
            transition: all 0.3s ease;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(46, 125, 50, 0.1);
        }

        .input-group input:focus ~ .input-icon,
        .input-group select:focus ~ .input-icon,
        .input-group textarea:focus ~ .input-icon {
            color: var(--primary-color);
            transform: translateY(-50%) scale(1.1);
        }

        .slider-container {
            margin: 1.5rem 0;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--border-color);
            outline: none;
            -webkit-appearance: none;
            transition: all 0.3s ease;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--gradient-primary);
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(46, 125, 50, 0.3);
            transition: transform 0.3s ease;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--gradient-primary);
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 10px rgba(46, 125, 50, 0.3);
        }

        /* Enhanced Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(12px);
            z-index: 2000;
            animation: fadeIn 0.4s ease;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .modal-content {
            background: var(--gradient-card);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius-lg);
            padding: 3rem;
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            animation: bounceIn 0.6s ease;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-shadow: 0 2px 4px rgba(46, 125, 50, 0.1);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 2.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0.75rem;
            border-radius: 50%;
            transition: all 0.3s ease;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            background: var(--error-color);
            color: white;
            transform: scale(1.1);
        }

        /* Enhanced Notifications */
        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            padding: 1.5rem 2rem;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 3000;
            animation: slideInRight 0.6s ease;
            max-width: 450px;
            box-shadow: var(--shadow-xl);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .notification.success {
            background: linear-gradient(135deg, var(--success-color), #34D399);
        }

        .notification.error {
            background: linear-gradient(135deg, var(--error-color), #F87171);
        }

        .notification.warning {
            background: linear-gradient(135deg, var(--warning-color), #FBBF24);
        }

        .notification.info {
            background: linear-gradient(135deg, var(--info-color), #60A5FA);
        }

        /* Enhanced Mobile Navigation */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-color);
            padding: 1rem;
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
        }

        .mobile-nav-items {
            display: flex;
            justify-content: space-around;
        }

        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.4s ease;
            border-radius: 12px;
            min-width: 80px;
            position: relative;
        }

        .mobile-nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-primary);
            border-radius: 12px;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.3s ease;
        }

        .mobile-nav-item.active::before,
        .mobile-nav-item:hover::before {
            opacity: 1;
            transform: scale(1);
        }

        .mobile-nav-item.active,
        .mobile-nav-item:hover {
            color: white;
        }

        .mobile-nav-item i {
            font-size: 1.4rem;
            margin-bottom: 0.5rem;
            z-index: 1;
            position: relative;
        }

        .mobile-nav-item span {
            z-index: 1;
            position: relative;
        }

        /* Enhanced Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
            background: var(--gradient-card);
            border-radius: var(--border-radius);
            border: 2px dashed var(--border-color);
        }

        .empty-state i {
            font-size: 5rem;
            margin-bottom: 2rem;
            opacity: 0.6;
            color: var(--primary-color);
            animation: float 3s ease-in-out infinite;
        }

        .empty-state h3 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .empty-state p {
            font-size: 1.1rem;
            line-height: 1.8;
            margin-bottom: 2rem;
        }

        /* Enhanced Crop Image Selection */
        .crop-image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .crop-image-option {
            text-align: center;
            padding: 1.5rem;
            border: 3px solid var(--border-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--gradient-card);
            position: relative;
            overflow: hidden;
        }

        .crop-image-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(46, 125, 50, 0.05), rgba(76, 175, 80, 0.05));
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .crop-image-option:hover::before,
        .crop-image-option.selected::before {
            opacity: 1;
        }

        .crop-image-option:hover,
        .crop-image-option.selected {
            border-color: var(--primary-color);
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(46, 125, 50, 0.2);
        }

        .crop-image-option img {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            object-fit: cover;
            margin-bottom: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.4s ease;
        }

        .crop-image-option:hover img,
        .crop-image-option.selected img {
            transform: scale(1.1);
        }

        .crop-image-option span {
            display: block;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            z-index: 1;
            position: relative;
        }

        /* Enhanced Progress Bars */
        .progress {
            width: 100%;
            height: 12px;
            background: var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            margin: 1rem 0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-bar {
            height: 100%;
            background: var(--gradient-success);
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 8px;
            position: relative;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Enhanced Forecast Cards */
        .forecast-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .forecast-card {
            background: rgba(255, 255, 255, 0.15);
            padding: 1.5rem;
            border-radius: 16px;
            text-align: center;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }

        .forecast-card:hover {
            transform: translateY(-4px);
        }

        .forecast-day {
            font-size: 0.9rem;
            margin-bottom: 1rem;
            opacity: 0.9;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .forecast-icon {
            font-size: 2rem;
            margin: 1rem 0;
        }

        .forecast-temp {
            font-weight: 700;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .forecast-rain {
            font-size: 0.8rem;
            color: #60A5FA;
            font-weight: 600;
        }

        /* Enhanced Weather Alert */
        .weather-alert {
            background: rgba(239, 68, 68, 0.1);
            border-left: 6px solid var(--error-color);
            padding: 1.5rem;
            border-radius: 12px;
            margin: 1.5rem 0;
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease;
        }

        .weather-alert:hover {
            transform: translateX(4px);
        }

        .weather-alert.warning {
            background: rgba(245, 158, 11, 0.1);
            border-left-color: var(--warning-color);
        }

        .weather-alert.info {
            background: rgba(59, 130, 246, 0.1);
            border-left-color: var(--info-color);
        }

        .weather-alert h4 {
            margin: 0 0 1rem 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .weather-alert p {
            margin: 0;
            line-height: 1.6;
        }

        /* Enhanced Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }

            .mobile-nav {
                display: block;
            }

            .content-area {
                padding: 1.5rem;
                padding-bottom: 120px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .crop-grid {
                grid-template-columns: 1fr;
            }

            .quick-links {
                grid-template-columns: repeat(2, 1fr);
                gap: 1.5rem;
            }

            .modal-content {
                margin: 1rem;
                padding: 2rem;
            }

            .auth-card {
                padding: 2.5rem;
                margin: 1rem;
            }

            .app-header {
                padding: 1.5rem;
            }

            .stat-value {
                font-size: 2rem;
            }

            .weather-temp {
                font-size: 2.5rem;
            }

            .crop-image-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 1rem;
            }

            .forecast-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .app-logo {
                font-size: 2rem;
            }

            .loading-logo {
                font-size: 3rem;
            }

            .loading-logo i {
                font-size: 4rem;
            }
        }

        /* Enhanced Utility Classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .mb-4 { margin-bottom: 2rem; }
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .mt-4 { margin-top: 2rem; }
        .flex { display: flex; }
        .flex-center { display: flex; justify-content: center; align-items: center; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .flex-column { display: flex; flex-direction: column; }
        .gap-1 { gap: 0.5rem; }
        .gap-2 { gap: 1rem; }
        .gap-3 { gap: 1.5rem; }
        .w-full { width: 100%; }
        .hidden { display: none !important; }
        .grid { display: grid; }
        .grid-2 { grid-template-columns: 1fr 1fr; }
        .grid-3 { grid-template-columns: 1fr 1fr 1fr; }

        /* Enhanced Theme Toggle */
        .theme-toggle {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: 1rem;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.4s ease;
            backdrop-filter: blur(10px);
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            transform: scale(1.1) rotate(180deg);
            box-shadow: 0 4px 15px rgba(46, 125, 50, 0.2);
        }

        /* Enhanced Language Selector */
        .language-selector {
            display: flex;
            gap: 1rem;
            margin: 2rem 0;
        }

        .language-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-primary);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.4s ease;
            backdrop-filter: blur(10px);
        }

        .language-btn.active {
            border-color: var(--primary-color);
            background: var(--gradient-primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(46, 125, 50, 0.3);
        }

        .language-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--background-light);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-logo">
            <i class="fas fa-seedling"></i>
            JamaApp
        </div>
        <div class="loading-progress">
            <div class="loading-progress-bar"></div>
        </div>
        <p id="loadingText">Smart Farm Dashboard is starting...</p>
    </div>

    <!-- Authentication Container -->
    <div id="authContainer" class="auth-container">
        <div class="auth-card">
            <div class="auth-logo">
                <i class="fas fa-seedling"></i>
                JamaApp
            </div>
            <p style="margin-bottom: 2rem; color: #666; font-size: 1.1rem; font-weight: 500;">Smart Farm Management System</p>
            
            <!-- Login Form -->
            <div id="loginForm">
                <form id="emailLoginForm">
                    <div class="form-group">
                        <label for="loginEmail">
                            <i class="fas fa-envelope"></i>
                            Email Address
                        </label>
                        <div class="form-control-wrapper">
                            <input type="email" id="loginEmail" class="form-control" required placeholder="Enter your email">
                            <i class="form-icon fas fa-envelope"></i>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">
                            <i class="fas fa-lock"></i>
                            Password
                        </label>
                        <div class="form-control-wrapper">
                            <input type="password" id="loginPassword" class="form-control" required placeholder="Enter your password">
                            <i class="form-icon fas fa-lock"></i>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-full">
                        <i class="fas fa-sign-in-alt"></i> Sign In
                    </button>
                </form>
                
                <div style="margin: 2rem 0; text-align: center; color: #666;">Or continue with</div>
                
                <button id="googleSignIn" class="btn w-full" style="background: linear-gradient(135deg, #DB4437, #C23321); color: white; margin: 0.5rem 0;">
                    <i class="fab fa-google"></i> Sign in with Google
                </button>
                
                <p style="margin-top: 2rem; text-align: center;">
                    Don't have an account?
                    <a href="#" id="showRegister" style="color: var(--primary-color); font-weight: 600;">Register here</a>
                </p>
            </div>

            <!-- Registration Form -->
            <div id="registerForm" style="display: none;">
                <form id="emailRegisterForm">
                    <div class="grid grid-2 gap-2">
                        <div class="form-group">
                            <label for="regFirstName">
                                <i class="fas fa-user"></i>
                                First Name
                            </label>
                            <div class="form-control-wrapper">
                                <input type="text" id="regFirstName" class="form-control" required placeholder="First name">
                                <i class="form-icon fas fa-user"></i>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="regLastName">
                                <i class="fas fa-user"></i>
                                Last Name
                            </label>
                            <div class="form-control-wrapper">
                                <input type="text" id="regLastName" class="form-control" required placeholder="Last name">
                                <i class="form-icon fas fa-user"></i>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="regEmail">
                            <i class="fas fa-envelope"></i>
                            Email Address
                        </label>
                        <div class="form-control-wrapper">
                            <input type="email" id="regEmail" class="form-control" required placeholder="Enter your email">
                            <i class="form-icon fas fa-envelope"></i>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="regPassword">
                            <i class="fas fa-lock"></i>
                            Password
                        </label>
                        <div class="form-control-wrapper">
                            <input type="password" id="regPassword" class="form-control" required placeholder="Create password">
                            <i class="form-icon fas fa-lock"></i>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="regLocation">
                            <i class="fas fa-map-marker-alt"></i>
                            Location
                        </label>
                        <div class="form-control-wrapper">
                            <input type="text" id="regLocation" class="form-control" required placeholder="Your location">
                            <i class="form-icon fas fa-map-marker-alt"></i>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="regFarmSize">
                            <i class="fas fa-seedling"></i>
                            Farm Size (acres)
                        </label>
                        <div class="form-control-wrapper">
                            <input type="number" id="regFarmSize" class="form-control" step="0.1" required placeholder="0.0">
                            <i class="form-icon fas fa-seedling"></i>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-full">
                        <i class="fas fa-user-plus"></i> Create Account
                    </button>
                </form>
                
                <p style="margin-top: 2rem; text-align: center;">
                    Already have an account?
                    <a href="#" id="showLogin" style="color: var(--primary-color); font-weight: 600;">Sign in here</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="appContainer" class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="app-logo">
                <i class="fas fa-seedling"></i>
                JamaApp
            </div>
            <div class="header-actions">
                <div class="weather-display" id="headerWeather" onclick="refreshWeather()">
                    <i class="fas fa-sun" id="headerWeatherIcon"></i>
                    <span id="headerTemp">--C</span>
                    <span id="headerLocation">Loading...</span>
                </div>
                <button class="theme-toggle" id="themeToggle" title="Toggle theme">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </header>

        <div class="main-content">
            <!-- Sidebar Navigation -->
            <nav class="sidebar">
                <ul class="sidebar-nav">
                    <li><a href="#" onclick="showSection('dashboard')" class="active">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a></li>
                    <li><a href="#" onclick="showSection('crops')">
                        <i class="fas fa-seedling"></i> Crop Management
                    </a></li>
                    <li><a href="#" onclick="showSection('assets')">
                        <i class="fas fa-tractor"></i> Asset Management
                    </a></li>
                    <li><a href="#" onclick="showSection('suggestions')">
                        <i class="fas fa-lightbulb"></i> Smart Suggestions
                    </a></li>
                    <li><a href="#" onclick="showSection('profile')">
                        <i class="fas fa-user-cog"></i> Profile
                    </a></li>
                </ul>
            </nav>

            <!-- Content Area -->
            <main class="content-area">
                <!-- Dashboard Section -->
                <div id="dashboard" class="section">
                    <!-- Welcome Message -->
                    <div class="card mb-3">
                        <h1 style="color: var(--primary-color); font-size: 2.5rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 1rem;">
                            <i class="fas fa-hand-paper" style="font-size: 2rem;"></i>
                            Welcome back, <span id="userNameDisplay">Farmer</span>!
                        </h1>
                        <p style="color: var(--text-secondary); font-size: 1.1rem;">Here's your farm overview for today</p>
                    </div>

                    <!-- Weather Widget -->
                    <div class="card weather-widget mb-3">
                        <div class="flex-between" style="align-items: flex-start;">
                            <div>
                                <div class="weather-icon" id="weatherIcon">
                                    <i class="fas fa-cloud-sun"></i>
                                </div>
                                <div class="weather-temp" id="weatherTemp">--C</div>
                                <div class="weather-desc" id="weatherDesc">Loading weather...</div>
                                <div style="font-size: 1rem; opacity: 0.95; margin-top: 1rem;">
                                    <i class="fas fa-map-marker-alt"></i> <span id="weatherLocation">Loading location...</span>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="background: rgba(255,255,255,0.2); padding: 1.5rem; border-radius: 16px; backdrop-filter: blur(15px);">
                                    <div style="font-size: 2.5rem; font-weight: bold;" id="rainPercentage">--%</div>
                                    <div style="font-size: 0.9rem; opacity: 0.95; font-weight: 600;">Rain Chance</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Weather Details -->
                        <div style="margin-top: 3rem;">
                            <div class="grid grid-3 gap-3">
                                <div style="background: rgba(255,255,255,0.15); padding: 1.5rem; border-radius: 16px; text-align: center; backdrop-filter: blur(10px);">
                                    <div style="font-size: 0.9rem; opacity: 0.95; margin-bottom: 0.5rem; font-weight: 600;">
                                        <i class="fas fa-tint"></i> Humidity
                                    </div>
                                    <div style="font-size: 1.8rem; font-weight: bold;" id="humidity">--%</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.15); padding: 1.5rem; border-radius: 16px; text-align: center; backdrop-filter: blur(10px);">
                                    <div style="font-size: 0.9rem; opacity: 0.95; margin-bottom: 0.5rem; font-weight: 600;">
                                        <i class="fas fa-wind"></i> Wind Speed
                                    </div>
                                    <div style="font-size: 1.8rem; font-weight: bold;" id="windSpeed">-- km/h</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.15); padding: 1.5rem; border-radius: 16px; text-align: center; backdrop-filter: blur(10px);">
                                    <div style="font-size: 0.9rem; opacity: 0.95; margin-bottom: 0.5rem; font-weight: 600;">
                                        <i class="fas fa-thermometer-half"></i> Feels Like
                                    </div>
                                    <div style="font-size: 1.8rem; font-weight: bold;" id="feelsLike">--C</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 5-Day Forecast -->
                        <div style="margin-top: 3rem;">
                            <h4 style="margin-bottom: 2rem; opacity: 0.95; font-size: 1.3rem; font-weight: 600;">
                                <i class="fas fa-calendar-alt"></i> 5-Day Forecast
                            </h4>
                            <div class="forecast-grid" id="forecastGrid">
                                <!-- Forecast cards will be loaded here -->
                            </div>
                        </div>

                        <!-- Weather Search -->
                        <div style="margin-top: 2rem;">
                            <div class="flex gap-2">
                                <div style="position: relative; flex: 1;">
                                    <input type="text" id="weatherSearch" class="form-control" placeholder="Search location..." style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding-left: 3rem;">
                                    <i class="form-icon fas fa-map-marker-alt" style="color: rgba(255,255,255,0.7);"></i>
                                </div>
                                <button class="btn" onclick="searchWeather()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 1rem 1.5rem;">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Weather Alerts -->
                    <div id="weatherAlerts" class="mb-3">
                        <!-- Weather alerts will be displayed here -->
                    </div>

                    <!-- Quick Links -->
                    <div class="quick-links">
                        <a href="#" onclick="showAddCropModal()" class="quick-link">
                            <i class="fas fa-plus-circle"></i>
                            <h4>Add Crop</h4>
                            <p>Start tracking new crop</p>
                        </a>
                        <a href="#" onclick="showAddAssetModal()" class="quick-link">
                            <i class="fas fa-tractor"></i>
                            <h4>Add Asset</h4>
                            <p>Register farm equipment</p>
                        </a>
                        <a href="#" onclick="showAddLoanModal()" class="quick-link">
                            <i class="fas fa-handshake"></i>
                            <h4>Add Loan</h4>
                            <p>Track loans & credits</p>
                        </a>
                        <a href="#" onclick="exportAllData()" class="quick-link">
                            <i class="fas fa-download"></i>
                            <h4>Export Data</h4>
                            <p>Download farm report</p>
                        </a>
                    </div>

                    <!-- Financial Overview -->
                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <i class="fas fa-coins" style="font-size: 3rem; color: var(--success-color); margin-bottom: 1.5rem;"></i>
                            <div class="stat-value" id="totalIncome">0</div>
                            <div class="stat-label">Total Income</div>
                            <div class="stat-change positive" id="incomeChange">+0% this month</div>
                        </div>

                        <div class="stat-card">
                            <i class="fas fa-credit-card" style="font-size: 3rem; color: var(--error-color); margin-bottom: 1.5rem;"></i>
                            <div class="stat-value" id="totalExpenses" style="color: var(--error-color);">0</div>
                            <div class="stat-label">Total Expenses</div>
                            <div class="stat-change negative" id="expenseChange">+0% this month</div>
                        </div>

                        <div class="stat-card">
                            <i class="fas fa-chart-line" style="font-size: 3rem; color: var(--primary-color); margin-bottom: 1.5rem;"></i>
                            <div class="stat-value" id="netProfit">0</div>
                            <div class="stat-label">Net Profit</div>
                            <div class="stat-change positive" id="profitChange">+0% this month</div>
                        </div>

                        <div class="stat-card">
                            <i class="fas fa-seedling" style="font-size: 3rem; color: var(--primary-color); margin-bottom: 1.5rem;"></i>
                            <div class="stat-value" id="activeCrops">0</div>
                            <div class="stat-label">Active Crops</div>
                            <div class="stat-change" id="cropsChange">0 Total Crops</div>
                        </div>
                    </div>
                </div>

                <!-- Crop Management Section -->
                <div id="crops" class="section hidden">
                    <div class="flex-between mb-4">
                        <h1 style="color: var(--primary-color); font-size: 2.5rem; display: flex; align-items: center; gap: 1rem;">
                            <i class="fas fa-seedling"></i> Crop Management
                        </h1>
                        <button class="btn btn-primary" onclick="showAddCropModal()">
                            <i class="fas fa-plus"></i> Add Crop
                        </button>
                    </div>

                    <!-- Crop Filters -->
                    <div class="card mb-4" style="padding: 2rem;">
                        <h3 style="margin-bottom: 1.5rem; color: var(--primary-color); display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-filter"></i> Filter Crops
                        </h3>
                        <div class="grid grid-3 gap-3">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>
                                    <i class="fas fa-seedling"></i>
                                    Crop Type
                                </label>
                                <div class="form-control-wrapper">
                                    <select id="cropTypeFilter" class="form-control" onchange="filterCrops()">
                                        <option value="">All Crops</option>
                                        <option value="rice"> Rice</option>
                                        <option value="wheat"> Wheat</option>
                                        <option value="corn"> Corn</option>
                                        <option value="cotton"> Cotton</option>
                                        <option value="sugarcane"> Sugarcane</option>
                                        <option value="pulses"> Pulses</option>
                                        <option value="vegetables"> Vegetables</option>
                                        <option value="fruits"> Fruits</option>
                                    </select>
                                    <i class="form-icon fas fa-seedling"></i>
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>
                                    <i class="fas fa-info-circle"></i>
                                    Status
                                </label>
                                <div class="form-control-wrapper">
                                    <select id="cropStatusFilter" class="form-control" onchange="filterCrops()">
                                        <option value="">All Status</option>
                                        <option value="active"> Active</option>
                                        <option value="harvested"> Harvested</option>
                                        <option value="planned"> Planned</option>
                                    </select>
                                    <i class="form-icon fas fa-info-circle"></i>
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>
                                    <i class="fas fa-calendar"></i>
                                    Year
                                </label>
                                <div class="form-control-wrapper">
                                    <select id="cropYearFilter" class="form-control" onchange="filterCrops()">
                                        <option value="">All Years</option>
                                        <option value="2024">2024</option>
                                        <option value="2023">2023</option>
                                        <option value="2022">2022</option>
                                    </select>
                                    <i class="form-icon fas fa-calendar"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Crop Grid -->
                    <div id="cropGrid" class="crop-grid">
                        <!-- Crops will be loaded here -->
                    </div>
                </div>

                <!-- Asset Management Section -->
                <div id="assets" class="section hidden">
                    <div class="flex-between mb-4">
                        <h1 style="color: var(--primary-color); font-size: 2.5rem; display: flex; align-items: center; gap: 1rem;">
                            <i class="fas fa-tractor"></i> Asset Management
                        </h1>
                        <button class="btn btn-primary" onclick="showAddAssetModal()">
                            <i class="fas fa-plus"></i> Add Asset
                        </button>
                    </div>

                    <!-- Asset List -->
                    <div id="assetsList" class="crop-grid">
                        <!-- Assets will be loaded here -->
                    </div>
                </div>

                <!-- Smart Suggestions Section -->
                <div id="suggestions" class="section hidden">
                    <h1 style="color: var(--primary-color); font-size: 2.5rem; margin-bottom: 3rem; display: flex; align-items: center; gap: 1rem;">
                        <i class="fas fa-lightbulb"></i> Smart Farming Suggestions
                    </h1>
                    
                    <div id="suggestionsGrid" class="crop-grid">
                        <!-- Suggestions will be loaded here -->
                    </div>
                </div>

                <!-- Profile & Settings Section -->
                <div id="profile" class="section hidden">
                    <h1 style="color: var(--primary-color); font-size: 2.5rem; margin-bottom: 3rem; display: flex; align-items: center; gap: 1rem;">
                        <i class="fas fa-user-cog"></i> Profile & Settings
                    </h1>
                    
                    <div class="dashboard-grid">
                        <!-- Profile Information -->
                        <div class="card">
                            <h3 style="margin-bottom: 2rem; display: flex; align-items: center; gap: 0.75rem;">
                                <i class="fas fa-user"></i> Profile Information
                            </h3>
                            <form id="profileForm">
                                <div class="form-group">
                                    <label for="profileName">
                                        <i class="fas fa-user"></i>
                                        Full Name
                                    </label>
                                    <div class="form-control-wrapper">
                                        <input type="text" id="profileName" class="form-control">
                                        <i class="form-icon fas fa-user"></i>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="profileEmail">
                                        <i class="fas fa-envelope"></i>
                                        Email
                                    </label>
                                    <div class="form-control-wrapper">
                                        <input type="email" id="profileEmail" class="form-control" readonly>
                                        <i class="form-icon fas fa-envelope"></i>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="profileLocation">
                                        <i class="fas fa-map-marker-alt"></i>
                                        Location
                                    </label>
                                    <div class="form-control-wrapper">
                                        <input type="text" id="profileLocation" class="form-control">
                                        <i class="form-icon fas fa-map-marker-alt"></i>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="profileFarmSize">
                                        <i class="fas fa-seedling"></i>
                                        Farm Size (acres)
                                    </label>
                                    <div class="form-control-wrapper">
                                        <input type="number" id="profileFarmSize" class="form-control" step="0.1">
                                        <i class="form-icon fas fa-seedling"></i>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Update Profile
                                </button>
                            </form>
                        </div>

                        <!-- App Settings -->
                        <div class="card">
                            <h3 style="margin-bottom: 2rem; display: flex; align-items: center; gap: 0.75rem;">
                                <i class="fas fa-cog"></i> App Settings
                            </h3>
                            
                            <!-- Theme Settings -->
                            <div class="form-group">
                                <label>
                                    <i class="fas fa-palette"></i>
                                    Theme
                                </label>
                                <div class="flex gap-3">
                                    <button class="btn btn-secondary" onclick="setTheme('light')" id="lightThemeBtn">
                                        <i class="fas fa-sun"></i> Light
                                    </button>
                                    <button class="btn btn-secondary" onclick="setTheme('dark')" id="darkThemeBtn">
                                        <i class="fas fa-moon"></i> Dark
                                    </button>
                                </div>
                            </div>

                            <div class="form-group">
                                <button class="btn btn-danger" onclick="signOut()">
                                    <i class="fas fa-sign-out-alt"></i> Sign Out
                                </button>
                            </div>
                        </div>

                        <!-- Data Management -->
                        <div class="card">
                            <h3 style="margin-bottom: 2rem; display: flex; align-items: center; gap: 0.75rem;">
                                <i class="fas fa-database"></i> Data Management
                            </h3>
                            <div class="flex-column gap-3">
                                <button class="btn btn-info" onclick="exportAllData()">
                                    <i class="fas fa-download"></i> Export All Data (PDF)
                                </button>
                                <button class="btn btn-success" onclick="backupData()">
                                    <i class="fas fa-cloud-upload-alt"></i> Backup to Cloud
                                </button>
                                <button class="btn btn-danger" onclick="clearAllData()">
                                    <i class="fas fa-trash"></i> Clear All Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Mobile Navigation -->
        <nav class="mobile-nav">
            <div class="mobile-nav-items">
                <a href="#" onclick="showSection('dashboard')" class="mobile-nav-item active">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" onclick="showSection('crops')" class="mobile-nav-item">
                    <i class="fas fa-seedling"></i>
                    <span>Crops</span>
                </a>
                <a href="#" onclick="showSection('assets')" class="mobile-nav-item">
                    <i class="fas fa-tractor"></i>
                    <span>Assets</span>
                </a>
                <a href="#" onclick="showSection('suggestions')" class="mobile-nav-item">
                    <i class="fas fa-lightbulb"></i>
                    <span>Ideas</span>
                </a>
                <a href="#" onclick="showSection('profile')" class="mobile-nav-item">
                    <i class="fas fa-user"></i>
                    <span>Profile</span>
                </a>
            </div>
        </nav>
    </div>

    <!-- Add Crop Modal -->
    <div id="addCropModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-seedling"></i> Add New Crop
                </h2>
                <button class="close-modal" onclick="closeModal('addCropModal')">&times;</button>
            </div>
            <form id="addCropForm">
                <!-- Crop Image Selection -->
                <div class="form-group">
                    <label style="font-size: 1.2rem; margin-bottom: 1rem;">
                        <i class="fas fa-seedling"></i>
                        Select Crop Type
                    </label>
                    <div class="crop-image-grid" id="cropImageGrid">
                        <!-- Crop options will be loaded here -->
                    </div>
                    <input type="hidden" id="selectedCropType" required>
                </div>

                <div class="grid grid-2 gap-3">
                    <div class="form-group">
                        <label for="cropVariety">
                            <i class="fas fa-leaf"></i>
                            Variety
                        </label>
                        <div class="form-control-wrapper">
                            <select id="cropVariety" class="form-control">
                                <option value="">Select Variety</option>
                            </select>
                            <i class="form-icon fas fa-leaf"></i>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="cropLocation">
                            <i class="fas fa-map-marker-alt"></i>
                            Location
                        </label>
                        <div class="form-control-wrapper">
                            <input type="text" id="cropLocation" class="form-control" required placeholder="Field location">
                            <i class="form-icon fas fa-map-marker-alt"></i>
                        </div>
                    </div>
                </div>

                <!-- Area Input -->
                <div class="form-group">
                    <label for="cropArea">
                        <i class="fas fa-expand-arrows-alt"></i>
                        Area (acres)
                    </label>
                    <div class="form-control-wrapper">
                        <input type="number" id="cropArea" class="form-control" step="0.1" min="0.1" required placeholder="0.0">
                        <i class="form-icon fas fa-expand-arrows-alt"></i>
                    </div>
                </div>

                <!-- Duration Input -->
                <div class="form-group">
                    <label for="cropDuration">
                        <i class="fas fa-clock"></i>
                        Duration (months)
                    </label>
                    <div class="form-control-wrapper">
                        <input type="number" id="cropDuration" class="form-control" min="1" max="24" required placeholder="3">
                        <i class="form-icon fas fa-clock"></i>
                    </div>
                </div>

                <div class="grid grid-2 gap-3">
                    <div class="form-group">
                        <label for="sowingDate">
                            <i class="fas fa-calendar-plus"></i>
                            Sowing Date
                        </label>
                        <div class="form-control-wrapper">
                            <input type="date" id="sowingDate" class="form-control" required onchange="updateExpectedHarvest()">
                            <i class="form-icon fas fa-calendar-plus"></i>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="expectedHarvest">
                            <i class="fas fa-calendar-check"></i>
                            Expected Harvest
                        </label>
                        <div class="form-control-wrapper">
                            <input type="date" id="expectedHarvest" class="form-control" readonly>
                            <i class="form-icon fas fa-calendar-check"></i>
                        </div>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Add Crop
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addCropModal')">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Asset Modal -->
    <div id="addAssetModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-plus-square"></i> Add Asset
                </h2>
                <button class="close-modal" onclick="closeModal('addAssetModal')">&times;</button>
            </div>
            <form id="addAssetForm">
                <div class="grid grid-2 gap-3">
                    <div class="form-group">
                        <label for="assetType">
                            <i class="fas fa-tags"></i>
                            Asset Type
                        </label>
                        <div class="form-control-wrapper">
                            <select id="assetType" class="form-control" required>
                                <option value="">Select Type</option>
                                <option value="equipment"> Equipment</option>
                                <option value="livestock"> Livestock</option>
                                <option value="land"> Land</option>
                                <option value="inventory"> Inventory</option>
                            </select>
                            <i class="form-icon fas fa-tags"></i>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="assetName">
                            <i class="fas fa-signature"></i>
                            Name
                        </label>
                        <div class="form-control-wrapper">
                            <input type="text" id="assetName" class="form-control" required placeholder="Asset name">
                            <i class="form-icon fas fa-signature"></i>
                        </div>
                    </div>
                </div>
                <div class="grid grid-2 gap-3">
                    <div class="form-group">
                        <label for="assetPurchaseDate">
                            <i class="fas fa-calendar"></i>
                            Purchase Date
                        </label>
                        <div class="form-control-wrapper">
                            <input type="date" id="assetPurchaseDate" class="form-control">
                            <i class="form-icon fas fa-calendar"></i>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="assetPurchasePrice">
                            <i class="fas fa-rupee-sign"></i>
                            Purchase Price ()
                        </label>
                        <div class="form-control-wrapper">
                            <input type="number" id="assetPurchasePrice" class="form-control" step="0.01" placeholder="0.00">
                            <i class="form-icon fas fa-rupee-sign"></i>
                        </div>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Add Asset
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addAssetModal')">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Loan Modal -->
    <div id="addLoanModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-handshake"></i> Add Loan
                </h2>
                <button class="close-modal" onclick="closeModal('addLoanModal')">&times;</button>
            </div>
            <form id="addLoanForm">
                <div class="grid grid-2 gap-3">
                    <div class="form-group">
                        <label for="loanType">
                            <i class="fas fa-exchange-alt"></i>
                            Loan Type
                        </label>
                        <div class="form-control-wrapper">
                            <select id="loanType" class="form-control" required>
                                <option value="">Select Type</option>
                                <option value="taken"> Taken</option>
                                <option value="given"> Given</option>
                            </select>
                            <i class="form-icon fas fa-exchange-alt"></i>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="loanSource">
                            <i class="fas fa-building"></i>
                            Source/Person
                        </label>
                        <div class="form-control-wrapper">
                            <input type="text" id="loanSource" class="form-control" required placeholder="Bank or person name">
                            <i class="form-icon fas fa-building"></i>
                        </div>
                    </div>
                </div>
                <div class="grid grid-2 gap-3">
                    <div class="form-group">
                        <label for="loanAmount">
                            <i class="fas fa-rupee-sign"></i>
                            Loan Amount ()
                        </label>
                        <div class="form-control-wrapper">
                            <input type="number" id="loanAmount" class="form-control" step="0.01" required placeholder="0.00" onchange="calculateLoanDetails()">
                            <i class="form-icon fas fa-rupee-sign"></i>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="loanInterestRate">
                            <i class="fas fa-percent"></i>
                            Interest Rate (%)
                        </label>
                        <div class="form-control-wrapper">
                            <input type="number" id="loanInterestRate" class="form-control" step="0.01" required placeholder="0.00" onchange="calculateLoanDetails()">
                            <i class="form-icon fas fa-percent"></i>
                        </div>
                    </div>
                </div>
                <div class="grid grid-2 gap-3">
                    <div class="form-group">
                        <label for="loanStartDate">
                            <i class="fas fa-calendar-alt"></i>
                            Start Date
                        </label>
                        <div class="form-control-wrapper">
                            <input type="date" id="loanStartDate" class="form-control" required onchange="calculateLoanDetails()">
                            <i class="form-icon fas fa-calendar-alt"></i>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="loanDuration">
                            <i class="fas fa-hourglass-half"></i>
                            Duration (months)
                        </label>
                        <div class="form-control-wrapper">
                            <input type="number" id="loanDuration" class="form-control" required placeholder="12" onchange="calculateLoanDetails()">
                            <i class="form-icon fas fa-hourglass-half"></i>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="totalLoanAmount">
                        <i class="fas fa-calculator"></i>
                        Total Repayment Amount ()
                    </label>
                    <div class="form-control-wrapper">
                        <input type="number" id="totalLoanAmount" class="form-control" readonly style="background: rgba(46, 125, 50, 0.1); font-weight: bold; color: var(--primary-color);">
                        <i class="form-icon fas fa-calculator"></i>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Add Loan
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addLoanModal')">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCdfgtj1gvZ-bkomW1V40h-4tyUPHy_peo",
            authDomain: "jama-3f427.firebaseapp.com",
            projectId: "jama-3f427",
            storageBucket: "jama-3f427.firebasestorage.app",
            messagingSenderId: "897112470741",
            appId: "1:897112470741:web:ee6388f0faae459fcb1e5c",
            measurementId: "G-NN1BRV0QKS"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Tomorrow.io Weather API Configuration
        const TOMORROW_API_KEY = '1G7YyF7MlPU3v0bx8oAL36JWwDziEgH5'; // Replace with your actual API key
        const TOMORROW_API_BASE = 'https://api.tomorrow.io/v4';

        // Global Variables
        let currentUser = null;
        let currentSection = 'dashboard';
        let currentTheme = 'light';
        let userLocation = { lat: 28.6139, lon: 77.2090, name: 'Delhi' }; // Default location
        let weatherData = null;

        // Storage Keys
        const STORAGE_KEYS = {
            USER_DATA: 'jama_user_data',
            CROPS: 'jama_crops',
            ASSETS: 'jama_assets',
            ASSET_TRANSACTIONS: 'jama_asset_transactions',
            LOANS: 'jama_loans',
            SETTINGS: 'jama_settings',
            WEATHER_CACHE: 'jama_weather_cache',
            USER_LOCATION: 'jama_user_location'
        };

        // Enhanced Crop data with images and varieties
        const cropData = {
            rice: {
                name: 'Rice',
                emoji: '',
                image: 'https://images.unsplash.com/photo-1586201375761-83865001e31c?w=400&h=300&fit=crop&auto=format&q=60',
                varieties: ['Basmati', 'Jasmine', 'Arborio', 'Brown Rice', 'Wild Rice', 'Sona Masuri', 'IR64'],
                optimalTemp: [20, 35],
                optimalHumidity: [60, 80],
                waterRequirement: 'high',
                season: 'Kharif/Rabi',
                duration: [3, 6]
            },
            wheat: {
                name: 'Wheat',
                emoji: '',
                image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?w=400&h=300&fit=crop&auto=format&q=60',
                varieties: ['Hard Red Winter', 'Hard Red Spring', 'Soft Red Winter', 'Durum', 'Hard White', 'Sharbati', 'Lok 1'],
                optimalTemp: [15, 25],
                optimalHumidity: [50, 70],
                waterRequirement: 'medium',
                season: 'Rabi',
                duration: [4, 6]
            },
            corn: {
                name: 'Corn',
                emoji: '',
                image: 'https://images.unsplash.com/photo-1551754655-cd27e38d2076?w=400&h=300&fit=crop&auto=format&q=60',
                varieties: ['Sweet Corn', 'Field Corn', 'Popcorn', 'Flint Corn', 'Dent Corn', 'Baby Corn'],
                optimalTemp: [18, 32],
                optimalHumidity: [55, 75],
                waterRequirement: 'medium',
                season: 'Kharif',
                duration: [3, 5]
            },
            cotton: {
                name: 'Cotton',
                emoji: '',
                image: 'https://images.unsplash.com/photo-1445346366695-5bf62de05412?w=400&h=300&fit=crop&auto=format&q=60',
                varieties: ['Upland Cotton', 'Pima Cotton', 'Organic Cotton', 'Colored Cotton', 'Bt Cotton'],
                optimalTemp: [20, 35],
                optimalHumidity: [45, 65],
                waterRequirement: 'medium',
                season: 'Kharif',
                duration: [5, 7]
            },
            sugarcane: {
                name: 'Sugarcane',
                emoji: '',
                image: 'https://images.unsplash.com/photo-1571115764595-644a1f56a55c?w=400&h=300&fit=crop&auto=format&q=60',
                varieties: ['Noble Cane', 'Thin Cane', 'Thick Cane', 'Red Cane', 'Co 86032', 'Co 0238'],
                optimalTemp: [25, 35],
                optimalHumidity: [70, 90],
                waterRequirement: 'high',
                season: 'Year-round',
                duration: [10, 18]
            },
            pulses: {
                name: 'Pulses',
                emoji: '',
                image: 'https://images.unsplash.com/photo-1559827260-dc66d52bef19?w=400&h=300&fit=crop&auto=format&q=60',
                varieties: ['Lentils', 'Chickpeas', 'Black Beans', 'Kidney Beans', 'Pinto Beans', 'Arhar Dal', 'Moong Dal'],
                optimalTemp: [18, 30],
                optimalHumidity: [50, 70],
                waterRequirement: 'low',
                season: 'Kharif/Rabi',
                duration: [2, 4]
            },
            vegetables: {
                name: 'Vegetables',
                emoji: '',
                image: 'https://images.unsplash.com/photo-1566385101042-1a0aa0c1268c?w=400&h=300&fit=crop&auto=format&q=60',
                varieties: ['Tomatoes', 'Carrots', 'Onions', 'Potatoes', 'Cabbage', 'Cauliflower', 'Brinjal'],
                optimalTemp: [15, 28],
                optimalHumidity: [60, 80],
                waterRequirement: 'medium',
                season: 'Year-round',
                duration: [2, 6]
            },
            fruits: {
                name: 'Fruits',
                emoji: '',
                image: 'https://images.unsplash.com/photo-1610832958506-aa56368176cf?w=400&h=300&fit=crop&auto=format&q=60',
                varieties: ['Apples', 'Oranges', 'Bananas', 'Grapes', 'Mangoes', 'Papaya', 'Watermelon'],
                optimalTemp: [20, 30],
                optimalHumidity: [55, 75],
                waterRequirement: 'medium',
                season: 'Seasonal',
                duration: [3, 12]
            }
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // Show loading screen
            setTimeout(() => {
                document.getElementById('loadingScreen').style.display = 'none';
                checkAuthState();
            }, 3500);

            // Initialize event listeners
            initializeEventListeners();
            
            // Load settings
            loadSettings();
            
            // Initialize crop image grid
            initializeCropImageGrid();
            
            // Set default dates
            setDefaultDates();

            // Load user location
            loadUserLocation();
        }

        function initializeEventListeners() {
            // Authentication form handlers
            document.getElementById('emailLoginForm').addEventListener('submit', handleEmailLogin);
            document.getElementById('emailRegisterForm').addEventListener('submit', handleEmailRegister);
            document.getElementById('googleSignIn').addEventListener('click', handleGoogleSignIn);
            
            // Form toggle handlers
            document.getElementById('showRegister').addEventListener('click', (e) => {
                e.preventDefault();
                toggleAuthForm('register');
            });
            document.getElementById('showLogin').addEventListener('click', (e) => {
                e.preventDefault();
                toggleAuthForm('login');
            });

            // Theme handler
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            // Form handlers
            document.getElementById('addCropForm').addEventListener('submit', handleAddCrop);
            document.getElementById('addAssetForm').addEventListener('submit', handleAddAsset);
            document.getElementById('addLoanForm').addEventListener('submit', handleAddLoan);
            document.getElementById('profileForm').addEventListener('submit', handleUpdateProfile);

            // Close modals when clicking outside
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    closeModal(e.target.id);
                }
            });

            // Weather search enter key
            document.getElementById('weatherSearch').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchWeather();
                }
            });
        }

        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('sowingDate').value = today;
            document.getElementById('loanStartDate').value = today;
        }

        // Authentication Functions
        function checkAuthState() {
            const savedUser = localStorage.getItem(STORAGE_KEYS.USER_DATA);
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                loadUserData();
                initializeDashboard();
            } else {
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        currentUser = {
                            uid: user.uid,
                            email: user.email,
                            displayName: user.displayName
                        };
                        localStorage.setItem(STORAGE_KEYS.USER_DATA, JSON.stringify(currentUser));
                        document.getElementById('authContainer').style.display = 'none';
                        document.getElementById('appContainer').style.display = 'block';
                        loadUserData();
                        initializeDashboard();
                    } else {
                        document.getElementById('authContainer').style.display = 'flex';
                        document.getElementById('appContainer').style.display = 'none';
                    }
                });
            }
        }

        async function handleEmailLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                showNotification('Signing in...', 'info');
                await auth.signInWithEmailAndPassword(email, password);
                showNotification('Welcome back! ', 'success');
            } catch (error) {
                console.error('Login error:', error);
                showNotification(getErrorMessage(error.code), 'error');
            }
        }

        async function handleEmailRegister(e) {
            e.preventDefault();
            const formData = {
                firstName: document.getElementById('regFirstName').value,
                lastName: document.getElementById('regLastName').value,
                email: document.getElementById('regEmail').value,
                password: document.getElementById('regPassword').value,
                location: document.getElementById('regLocation').value,
                farmSize: parseFloat(document.getElementById('regFarmSize').value)
            };

            try {
                showNotification('Creating your farm account...', 'info');
                const userCredential = await auth.createUserWithEmailAndPassword(formData.email, formData.password);
                
                await userCredential.user.updateProfile({
                    displayName: `${formData.firstName} ${formData.lastName}`
                });
                
                await db.collection('users').doc(userCredential.user.uid).set({
                    ...formData,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Set user location
                userLocation.name = formData.location;
                localStorage.setItem(STORAGE_KEYS.USER_LOCATION, JSON.stringify(userLocation));

                showNotification('Account created successfully! Welcome to JamaApp! ', 'success');
            } catch (error) {
                console.error('Registration error:', error);
                showNotification(getErrorMessage(error.code), 'error');
            }
        }

        async function handleGoogleSignIn() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                showNotification('Signing in with Google...', 'info');
                await auth.signInWithPopup(provider);
                showNotification('Google sign-in successful! ', 'success');
            } catch (error) {
                console.error('Google sign-in error:', error);
                showNotification(getErrorMessage(error.code), 'error');
            }
        }

        function toggleAuthForm(formType) {
            document.getElementById('loginForm').style.display = formType === 'login' ? 'block' : 'none';
            document.getElementById('registerForm').style.display = formType === 'register' ? 'block' : 'none';
        }

        async function signOut() {
            try {
                await auth.signOut();
                localStorage.clear();
                currentUser = null;
                showNotification('Successfully signed out! ', 'success');
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } catch (error) {
                console.error('Sign out error:', error);
                showNotification('Error signing out', 'error');
            }
        }

        // Enhanced Weather Functions with Tomorrow.io API
        async function getCurrentLocationWeather() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        try {
                            userLocation.lat = position.coords.latitude;
                            userLocation.lon = position.coords.longitude;
                            await getWeatherByCoordinates(userLocation.lat, userLocation.lon);
                        } catch (error) {
                            console.error('Weather error:', error);
                            await getWeatherByLocationName(userLocation.name);
                        }
                    },
                    async () => {
                        console.log('Location access denied, using saved location');
                        await getWeatherByLocationName(userLocation.name);
                    }
                );
            } else {
                await getWeatherByLocationName(userLocation.name);
            }
        }

        async function getWeatherByCoordinates(lat, lon) {
            try {
                // Using mock weather data since Tomorrow.io requires API key
                const mockWeatherData = generateMockWeatherData();
                updateWeatherDisplay(mockWeatherData);
                updateForecastDisplay(generateMockForecastData());
            } catch (error) {
                console.error('Weather API error:', error);
                showNotification('Could not fetch weather data', 'error');
            }
        }

        async function getWeatherByLocationName(locationName) {
            try {
                // Using mock weather data
                const mockWeatherData = generateMockWeatherData();
                mockWeatherData.location = locationName;
                updateWeatherDisplay(mockWeatherData);
                updateForecastDisplay(generateMockForecastData());
                
                userLocation.name = locationName;
                localStorage.setItem(STORAGE_KEYS.USER_LOCATION, JSON.stringify(userLocation));
                
            } catch (error) {
                console.error('Weather by name error:', error);
                showNotification('Could not fetch weather data', 'error');
            }
        }

        function generateMockWeatherData() {
            const conditions = ['clear', 'cloudy', 'partly_cloudy', 'rain', 'sunny'];
            const condition = conditions[Math.floor(Math.random() * conditions.length)];
            
            return {
                temperature: Math.round(Math.random() * 25 + 15), // 15-40C
                feelsLike: Math.round(Math.random() * 25 + 15),
                humidity: Math.round(Math.random() * 40 + 40), // 40-80%
                windSpeed: Math.round(Math.random() * 20 + 5), // 5-25 km/h
                condition: condition,
                description: getWeatherDescription(condition),
                precipitationProbability: Math.round(Math.random() * 100),
                location: userLocation.name || 'Unknown'
            };
        }

        function generateMockForecastData() {
            const forecast = [];
            const conditions = ['clear', 'cloudy', 'partly_cloudy', 'rain', 'sunny'];
            
            for (let i = 1; i <= 5; i++) {
                const date = new Date();
                date.setDate(date.getDate() + i);
                
                forecast.push({
                    date: date,
                    temperature: Math.round(Math.random() * 25 + 15),
                    condition: conditions[Math.floor(Math.random() * conditions.length)],
                    precipitationProbability: Math.round(Math.random() * 100)
                });
            }
            
            return forecast;
        }

        function getWeatherDescription(condition) {
            const descriptions = {
                clear: 'Clear sky',
                sunny: 'Sunny',
                cloudy: 'Cloudy',
                partly_cloudy: 'Partly cloudy',
                rain: 'Rainy',
                drizzle: 'Light drizzle',
                thunderstorm: 'Thunderstorm'
            };
            return descriptions[condition] || 'Weather conditions';
        }

        function updateWeatherDisplay(data) {
            const temp = data.temperature || 25;
            const feelsLike = data.feelsLike || temp;
            const description = data.description || 'Clear weather';
            const condition = data.condition || 'clear';
            const humidity = data.humidity || 65;
            const windSpeed = data.windSpeed || 10;
            const rainChance = data.precipitationProbability || 20;
            
            // Store weather data for crop suggestions
            weatherData = {
                temperature: temp,
                humidity: humidity,
                condition: condition,
                description: description,
                windSpeed: windSpeed,
                precipitationProbability: rainChance
            };
            
            // Update dashboard weather widget
            document.getElementById('weatherTemp').textContent = `${temp}C`;
            document.getElementById('weatherDesc').textContent = description.charAt(0).toUpperCase() + description.slice(1);
            document.getElementById('rainPercentage').textContent = `${rainChance}%`;
            document.getElementById('weatherLocation').textContent = data.location || userLocation.name || 'Unknown';
            document.getElementById('humidity').textContent = `${humidity}%`;
            document.getElementById('windSpeed').textContent = `${windSpeed} km/h`;
            document.getElementById('feelsLike').textContent = `${feelsLike}C`;
            
            // Update header weather
            document.getElementById('headerTemp').textContent = `${temp}C`;
            document.getElementById('headerLocation').textContent = data.location || userLocation.name || 'Loading...';
            
            // Update weather icon
            updateWeatherIcon(condition);
            
            // Generate weather alerts
            generateWeatherAlerts(data);
        }

        function updateForecastDisplay(forecastData) {
            const forecastGrid = document.getElementById('forecastGrid');
            
            if (!forecastData || forecastData.length === 0) {
                forecastGrid.innerHTML = '<p style="text-align: center; opacity: 0.7;">Forecast data unavailable</p>';
                return;
            }
            
            forecastGrid.innerHTML = forecastData.map(forecast => {
                const dayName = forecast.date.toLocaleDateString('en', { weekday: 'short' });
                const temp = forecast.temperature;
                const condition = forecast.condition;
                const rainChance = forecast.precipitationProbability;
                
                return `
                    <div class="forecast-card">
                        <div class="forecast-day">${dayName}</div>
                        <div class="forecast-icon">${getWeatherEmoji(condition)}</div>
                        <div class="forecast-temp">${temp}C</div>
                        <div class="forecast-rain">${rainChance}% rain</div>
                    </div>
                `;
            }).join('');
        }

        function updateWeatherIcon(condition) {
            const iconClass = getWeatherIconClass(condition);
            
            const weatherIcon = document.getElementById('weatherIcon');
            const headerWeatherIcon = document.getElementById('headerWeatherIcon');
            
            if (weatherIcon) weatherIcon.innerHTML = `<i class="${iconClass}"></i>`;
            if (headerWeatherIcon) headerWeatherIcon.className = iconClass;
        }

        function getWeatherIconClass(condition) {
            const icons = {
                clear: 'fas fa-sun',
                sunny: 'fas fa-sun',
                cloudy: 'fas fa-cloud',
                partly_cloudy: 'fas fa-cloud-sun',
                rain: 'fas fa-cloud-rain',
                drizzle: 'fas fa-cloud-rain',
                thunderstorm: 'fas fa-bolt',
                snow: 'fas fa-snowflake',
                mist: 'fas fa-smog',
                fog: 'fas fa-smog'
            };
            
            return icons[condition] || 'fas fa-sun';
        }

        function getWeatherEmoji(condition) {
            const emojis = {
                clear: '',
                sunny: '',
                cloudy: '',
                partly_cloudy: '',
                rain: '',
                drizzle: '',
                thunderstorm: '',
                snow: '',
                mist: '',
                fog: ''
            };
            
            return emojis[condition] || '';
        }

        function generateWeatherAlerts(weatherData) {
            const alertsContainer = document.getElementById('weatherAlerts');
            let alerts = [];

            const rainChance = weatherData.precipitationProbability || 0;
            const temp = weatherData.temperature || 25;
            const windSpeed = weatherData.windSpeed || 0;

            // High rain alert
            if (rainChance > 80) {
                alerts.push({
                    type: 'error',
                    title: ' Heavy Rain Alert',
                    message: `${rainChance}% chance of heavy rain. Ensure proper drainage and protect crops from waterlogging.`
                });
            } else if (rainChance > 60) {
                alerts.push({
                    type: 'warning',
                    title: ' Rain Expected',
                    message: `${rainChance}% chance of rain. Good time for planting but monitor field conditions.`
                });
            }

            // Temperature alerts
            if (temp > 35) {
                alerts.push({
                    type: 'warning',
                    title: ' High Temperature Alert',
                    message: `Temperature is ${temp}C. Increase irrigation frequency and provide shade for sensitive crops.`
                });
            } else if (temp < 5) {
                alerts.push({
                    type: 'error',
                    title: ' Cold Weather Alert',
                    message: `Temperature is ${temp}C. Protect crops from frost damage.`
                });
            }

            // Wind alerts
            if (windSpeed > 25) {
                alerts.push({
                    type: 'warning',
                    title: ' High Wind Alert',
                    message: `Wind speed is ${windSpeed} km/h. Secure loose structures and support tall crops.`
                });
            }

            // Clear previous alerts
            alertsContainer.innerHTML = '';

            // Display alerts
            alerts.forEach(alert => {
                const alertElement = document.createElement('div');
                alertElement.className = `weather-alert ${alert.type}`;
                alertElement.innerHTML = `
                    <h4>${alert.title}</h4>
                    <p>${alert.message}</p>
                `;
                alertsContainer.appendChild(alertElement);
            });
        }

        async function searchWeather() {
            const searchInput = document.getElementById('weatherSearch');
            const location = searchInput.value.trim();
            
            if (location) {
                await getWeatherByLocationName(location);
                searchInput.value = '';
                showNotification(`Weather updated for ${location}`, 'success');
            }
        }

        async function refreshWeather() {
            showNotification('Refreshing weather data...', 'info');
            await getCurrentLocationWeather();
        }

        // Data Management Functions
        async function loadUserData() {
            try {
                if (currentUser && currentUser.uid) {
                    const userDoc = await db.collection('users').doc(currentUser.uid).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        populateProfileForm(userData);
                        
                        const displayName = userData.displayName || `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || 'Farmer';
                        document.getElementById('userNameDisplay').textContent = displayName;
                        
                        if (userData.location) {
                            userLocation.name = userData.location;
                            localStorage.setItem(STORAGE_KEYS.USER_LOCATION, JSON.stringify(userLocation));
                            await getWeatherByLocationName(userData.location);
                        }
                    }
                }

                loadCrops();
                loadAssets();
                loadLoans();
                updateDashboardStats();
                getCurrentLocationWeather();
            } catch (error) {
                console.error('Error loading user data:', error);
                loadCrops();
                loadAssets();
                loadLoans();
                updateDashboardStats();
                getCurrentLocationWeather();
            }
        }

        function populateProfileForm(userData) {
            document.getElementById('profileName').value = userData.displayName || `${userData.firstName || ''} ${userData.lastName || ''}`.trim();
            document.getElementById('profileEmail').value = userData.email || (currentUser ? currentUser.email : '');
            document.getElementById('profileLocation').value = userData.location || '';
            document.getElementById('profileFarmSize').value = userData.farmSize || '';
        }

        function loadUserLocation() {
            const savedLocation = localStorage.getItem(STORAGE_KEYS.USER_LOCATION);
            if (savedLocation) {
                userLocation = JSON.parse(savedLocation);
            }
        }

        // Navigation Functions
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });

            document.getElementById(sectionName).classList.remove('hidden');

            document.querySelectorAll('.sidebar-nav a, .mobile-nav-item').forEach(nav => {
                nav.classList.remove('active');
            });
            
            const sidebarNavs = document.querySelectorAll('.sidebar-nav a');
            sidebarNavs.forEach(nav => {
                if (nav.getAttribute('onclick') && nav.getAttribute('onclick').includes(sectionName)) {
                    nav.classList.add('active');
                }
            });
            
            const mobileNavs = document.querySelectorAll('.mobile-nav-item');
            mobileNavs.forEach(nav => {
                if (nav.getAttribute('onclick') && nav.getAttribute('onclick').includes(sectionName)) {
                    nav.classList.add('active');
                }
            });

            currentSection = sectionName;

            switch(sectionName) {
                case 'dashboard':
                    initializeDashboard();
                    break;
                case 'crops':
                    loadCrops();
                    break;
                case 'assets':
                    loadAssets();
                    break;
                case 'suggestions':
                    loadSuggestions();
                    break;
            }
        }

        // Dashboard Functions
        function initializeDashboard() {
            updateDashboardStats();
            getCurrentLocationWeather();
        }

        function updateDashboardStats() {
            const crops = JSON.parse(localStorage.getItem(STORAGE_KEYS.CROPS) || '[]');
            const assetTransactions = JSON.parse(localStorage.getItem(STORAGE_KEYS.ASSET_TRANSACTIONS) || '[]');
            
            let totalIncome = 0;
            let totalExpenses = 0;

            crops.forEach(crop => {
                if (crop.status === 'harvested' && crop.totalSaleAmount) {
                    totalIncome += crop.totalSaleAmount;
                }
                if (crop.totalExpenses) {
                    totalExpenses += crop.totalExpenses;
                }
            });

            assetTransactions.forEach(transaction => {
                if (transaction.type === 'income') {
                    totalIncome += transaction.amount;
                } else {
                    totalExpenses += transaction.amount;
                }
            });

            const activeCropsCount = crops.filter(crop => crop.status === 'active').length;
            const totalCropsCount = crops.length;
            const netProfit = totalIncome - totalExpenses;

            animateCounter('totalIncome', 0, totalIncome, '');
            animateCounter('totalExpenses', 0, totalExpenses, '');
            animateCounter('netProfit', 0, netProfit, '');
            animateCounter('activeCrops', 0, activeCropsCount, '');

            const incomeChange = (Math.random() * 20 - 10).toFixed(1);
            const expenseChange = (Math.random() * 20 - 10).toFixed(1);
            const profitChange = (Math.random() * 30 - 15).toFixed(1);

            document.getElementById('incomeChange').textContent = `${incomeChange > 0 ? '+' : ''}${incomeChange}% this month`;
            document.getElementById('expenseChange').textContent = `${expenseChange > 0 ? '+' : ''}${expenseChange}% this month`;
            document.getElementById('profitChange').textContent = `${profitChange > 0 ? '+' : ''}${profitChange}% this month`;
            document.getElementById('cropsChange').textContent = `${totalCropsCount} Total Crops`;

            document.getElementById('incomeChange').className = `stat-change ${incomeChange > 0 ? 'positive' : 'negative'}`;
            document.getElementById('expenseChange').className = `stat-change ${expenseChange < 0 ? 'positive' : 'negative'}`;
            document.getElementById('profitChange').className = `stat-change ${profitChange > 0 ? 'positive' : 'negative'}`;
        }

        function animateCounter(elementId, start, end, prefix = '') {
            const element = document.getElementById(elementId);
            const duration = 2000;
            const startTime = Date.now();
            
            function animate() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                const current = Math.floor(start + (end - start) * progress);
                element.textContent = prefix + current.toLocaleString('en-IN');
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                }
            }
            
            animate();
        }

        // Enhanced Crop Management Functions
        function initializeCropImageGrid() {
            const cropImageGrid = document.getElementById('cropImageGrid');
            
            cropImageGrid.innerHTML = Object.keys(cropData).map(cropKey => {
                const crop = cropData[cropKey];
                return `
                    <div class="crop-image-option" onclick="selectCropType('${cropKey}')">
                        <img src="${crop.image}" alt="${crop.name}" onerror="this.src='https://images.unsplash.com/photo-1625246333195-78d9c38ad449?w=400&h=300&fit=crop&auto=format&q=60'">
                        <span>${crop.emoji} ${crop.name}</span>
                    </div>
                `;
            }).join('');
        }

        function selectCropType(cropKey) {
            document.querySelectorAll('.crop-image-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            event.target.closest('.crop-image-option').classList.add('selected');
            
            document.getElementById('selectedCropType').value = cropKey;
            
            updateVarietyDropdown(cropKey);
            updateDurationSuggestion(cropKey);
        }

        function updateVarietyDropdown(cropKey) {
            const varietySelect = document.getElementById('cropVariety');
            const crop = cropData[cropKey];
            
            if (crop && crop.varieties) {
                varietySelect.innerHTML = '<option value="">Select Variety</option>' +
                    crop.varieties.map(variety => `<option value="${variety}">${variety}</option>`).join('');
            }
        }

        function updateDurationSuggestion(cropKey) {
            const crop = cropData[cropKey];
            if (crop && crop.duration) {
                const avgDuration = Math.floor((crop.duration[0] + crop.duration[1]) / 2);
                document.getElementById('cropDuration').value = avgDuration;
                updateExpectedHarvest();
            }
        }

        function updateExpectedHarvest() {
            const sowingDate = document.getElementById('sowingDate').value;
            const duration = parseInt(document.getElementById('cropDuration').value) || 3;
            
            if (sowingDate && duration) {
                const sowing = new Date(sowingDate);
                const harvest = new Date(sowing.getTime() + (duration * 30 * 24 * 60 * 60 * 1000));
                document.getElementById('expectedHarvest').value = harvest.toISOString().split('T')[0];
            }
        }

        function loadCrops() {
            const crops = JSON.parse(localStorage.getItem(STORAGE_KEYS.CROPS) || '[]');
            displayCrops(crops);
        }

        function displayCrops(crops) {
            const cropGrid = document.getElementById('cropGrid');
            
            if (crops.length === 0) {
                cropGrid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <i class="fas fa-seedling"></i>
                        <h3>No crops added yet</h3>
                        <p>Start your farming journey by adding your first crop. Track growth, manage expenses, and maximize your harvest yield with smart recommendations.</p>
                        <button class="btn btn-primary" onclick="showAddCropModal()">
                            <i class="fas fa-plus"></i> Add Your First Crop
                        </button>
                    </div>
                `;
                return;
            }
            
            cropGrid.innerHTML = crops.map(crop => {
                const progress = calculateCropProgress(crop);
                const daysRemaining = getDaysRemaining(crop.expectedHarvest);
                const cropInfo = cropData[crop.type] || { emoji: '', image: 'https://images.unsplash.com/photo-1625246333195-78d9c38ad449?w=400&h=300&fit=crop&auto=format&q=60' };
                const suggestions = getCropSpecificSuggestions(crop);
                
                return `
                    <div class="crop-card">
                        <div class="crop-header" onclick="toggleCropCollapse('${crop.id}')">
                            <img src="${cropInfo.image}" alt="${crop.type}" class="crop-image" onerror="this.src='https://images.unsplash.com/photo-1625246333195-78d9c38ad449?w=400&h=300&fit=crop&auto=format&q=60'">
                            <div class="crop-info">
                                <div class="crop-name">${cropInfo.emoji} ${crop.type.charAt(0).toUpperCase() + crop.type.slice(1)}</div>
                                <div class="crop-details">
                                    <i class="fas fa-map-marker-alt"></i> ${crop.location}  <i class="fas fa-expand-arrows-alt"></i> ${crop.area} acres
                                    ${crop.variety ? `  <i class="fas fa-leaf"></i> ${crop.variety}` : ''}
                                </div>
                                <div class="crop-details">
                                    <span class="crop-status ${crop.status}">
                                        ${crop.status === 'active' ? ' Active' : crop.status === 'harvested' ? ' Harvested' : ' Planned'}
                                    </span>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <i class="fas fa-chevron-down" style="color: var(--text-secondary); font-size: 1.5rem; transition: transform 0.3s ease;"></i>
                            </div>
                        </div>
                        
                        <div class="crop-collapse" id="crop-${crop.id}">
                            <div class="crop-content">
                                ${crop.status === 'active' ? `
                                    <div style="margin-bottom: 2rem;">
                                        <div class="flex-between mb-2">
                                            <span style="font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                                <i class="fas fa-chart-line"></i> Crop Progress
                                            </span>
                                            <span style="font-size: 1.2rem; font-weight: bold; color: var(--primary-color);">${progress}%</span>
                                        </div>
                                        <div class="progress">
                                            <div class="progress-bar" style="width: ${progress}%"></div>
                                        </div>
                                        <div style="font-size: 0.9rem; color: var(--text-secondary); text-align: center; margin-top: 1rem; font-weight: 500;">
                                            ${daysRemaining > 0 ? ` ${daysRemaining} days remaining` : ' Ready for harvest!'}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <!-- Enhanced Weather for Crop Location -->
                                <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05)); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid rgba(59, 130, 246, 0.2);">
                                    <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="fas fa-cloud-sun"></i> Weather Conditions
                                    </h4>
                                    <div style="font-size: 1rem; line-height: 1.8;">
                                        <div style="margin-bottom: 0.5rem;">
                                            <strong>Current:</strong> ${weatherData ? `${weatherData.temperature}C, ${weatherData.description}` : 'Loading...'}
                                        </div>
                                        <div style="margin-bottom: 0.5rem;">
                                            <strong>Humidity:</strong> ${weatherData ? `${weatherData.humidity}%` : 'Loading...'}
                                        </div>
                                        <div>
                                            <strong>Suitability:</strong> 
                                            <span style="color: var(--success-color); font-weight: 600;">${getWeatherSuitability(crop.type, weatherData)}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Enhanced Smart Suggestions -->
                                <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05)); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; border: 1px solid rgba(16, 185, 129, 0.2);">
                                    <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="fas fa-lightbulb"></i> Smart Recommendations
                                    </h4>
                                    <div style="font-size: 1rem; line-height: 1.8;">
                                        ${suggestions.map(suggestion => `
                                            <div style="margin-bottom: 0.75rem; padding: 0.5rem 0; border-bottom: 1px solid rgba(16, 185, 129, 0.1);">
                                                ${suggestion}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <!-- Enhanced Action Buttons -->
                                <div class="flex gap-2" style="flex-wrap: wrap;">
                                    <button class="btn btn-warning btn-sm" onclick="addCropExpense('${crop.id}')">
                                        <i class="fas fa-minus-circle"></i> Add Expense
                                    </button>
                                    <button class="btn btn-info btn-sm" onclick="viewCropDetails('${crop.id}')">
                                        <i class="fas fa-eye"></i> View Details
                                    </button>
                                    ${crop.status === 'active' ? `
                                        <button class="btn btn-success btn-sm" onclick="harvestCrop('${crop.id}')">
                                            <i class="fas fa-cut"></i> Harvest Crop
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-secondary btn-sm" onclick="deleteCrop('${crop.id}')">
                                        <i class="fas fa-trash"></i> Remove
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleCropCollapse(cropId) {
            const collapse = document.getElementById(`crop-${cropId}`);
            const chevron = collapse.previousElementSibling.querySelector('.fa-chevron-down');
            
            collapse.classList.toggle('active');
            
            if (collapse.classList.contains('active')) {
                chevron.style.transform = 'rotate(180deg)';
            } else {
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        function calculateCropProgress(crop) {
            if (crop.status !== 'active') return 100;
            
            const sowingDate = new Date(crop.sowingDate);
            const harvestDate = new Date(crop.expectedHarvest);
            const today = new Date();
            
            const totalDays = (harvestDate - sowingDate) / (1000 * 60 * 60 * 24);
            const daysPassed = (today - sowingDate) / (1000 * 60 * 60 * 24);
            
            const progress = Math.min(Math.max((daysPassed / totalDays) * 100, 0), 100);
            return Math.round(progress);
        }

        function getDaysRemaining(harvestDate) {
            const today = new Date();
            const harvest = new Date(harvestDate);
            const daysRemaining = Math.ceil((harvest - today) / (1000 * 60 * 60 * 24));
            return Math.max(daysRemaining, 0);
        }

        function getWeatherSuitability(cropType, weather) {
            if (!weather || !cropData[cropType]) return 'Checking weather...';
            
            const crop = cropData[cropType];
            const temp = weather.temperature;
            const humidity = weather.humidity;
            
            let suitability = 'Excellent';
            let issues = [];
            
            // Check temperature
            if (temp < crop.optimalTemp[0] || temp > crop.optimalTemp[1]) {
                suitability = 'Suboptimal';
                if (temp < crop.optimalTemp[0]) {
                    issues.push('Temperature too low');
                } else {
                    issues.push('Temperature too high');
                }
            }
            
            // Check humidity
            if (humidity < crop.optimalHumidity[0] || humidity > crop.optimalHumidity[1]) {
                if (suitability === 'Excellent') suitability = 'Good';
                if (humidity < crop.optimalHumidity[0]) {
                    issues.push('Low humidity');
                } else {
                    issues.push('High humidity');
                }
            }
            
            return issues.length > 0 ? `${suitability} (${issues.join(', ')})` : suitability;
        }

        function getCropSpecificSuggestions(crop) {
            const suggestions = [];
            const progress = calculateCropProgress(crop);
            const cropInfo = cropData[crop.type];
            
            // Weather-based suggestions
            if (weatherData && cropInfo) {
                const temp = weatherData.temperature;
                const humidity = weatherData.humidity;
                
                // Temperature suggestions
                if (temp > cropInfo.optimalTemp[1]) {
                    suggestions.push(` <strong>High Temperature Alert:</strong> Temperature (${temp}C) is above optimal range. Increase irrigation frequency and consider shade protection.`);
                } else if (temp < cropInfo.optimalTemp[0]) {
                    suggestions.push(` <strong>Low Temperature Alert:</strong> Temperature (${temp}C) is below optimal range. Consider frost protection measures.`);
                }
                
                // Humidity suggestions
                if (humidity > cropInfo.optimalHumidity[1]) {
                    suggestions.push(` <strong>High Humidity Warning:</strong> Humidity (${humidity}%) is high. Monitor for fungal diseases and improve ventilation.`);
                } else if (humidity < cropInfo.optimalHumidity[0]) {
                    suggestions.push(` <strong>Low Humidity Alert:</strong> Humidity (${humidity}%) is low. Increase irrigation and consider mulching.`);
                }
                
                // Rain-based suggestions
                if (weatherData.condition && weatherData.condition.includes('rain')) {
                    if (cropInfo.waterRequirement === 'low') {
                        suggestions.push(` <strong>Rain Alert:</strong> Reduce irrigation as natural rainfall is sufficient for ${crop.type}.`);
                    } else {
                        suggestions.push(` <strong>Rain Benefit:</strong> Good natural irrigation for ${crop.type}. Monitor for excess water accumulation.`);
                    }
                }
            }
            
            // Growth stage suggestions
            if (crop.status === 'active') {
                if (progress < 25) {
                    suggestions.push(` <strong>Seedling Stage:</strong> Focus on root development with balanced fertilizer (NPK 10:10:10). Ensure consistent moisture.`);
                } else if (progress < 50) {
                    suggestions.push(` <strong>Vegetative Growth:</strong> Apply nitrogen-rich fertilizer for leaf development. Monitor for pests and diseases.`);
                } else if (progress < 75) {
                    suggestions.push(` <strong>Flowering/Fruiting Stage:</strong> Switch to phosphorus and potassium-rich fertilizer. Reduce nitrogen application.`);
                } else if (progress < 95) {
                    suggestions.push(` <strong>Maturation Stage:</strong> Reduce watering frequency. Prepare harvesting equipment and check market prices.`);
                } else {
                    suggestions.push(` <strong>Harvest Ready:</strong> Crop is ready for harvest. Check grain moisture content and weather forecast before harvesting.`);
                }
            }
            
            // Crop-specific suggestions
            switch (crop.type) {
                case 'rice':
                    suggestions.push(' <strong>Water Management:</strong> Maintain 2-5cm water depth during growing season. Drain fields 2 weeks before harvest.');
                    break;
                case 'wheat':
                    suggestions.push(' <strong>Pest Monitoring:</strong> Watch for aphids, rust diseases, and wheat borer during cool weather periods.');
                    break;
                case 'corn':
                    suggestions.push(' <strong>Fertilization:</strong> Side-dress with nitrogen when plants reach 6-8 inches height for optimal yield.');
                    break;
                case 'cotton':
                    suggestions.push(' <strong>Pest Control:</strong> Monitor for bollworm activity. Use integrated pest management strategies.');
                    break;
                case 'sugarcane':
                    suggestions.push(' <strong>Irrigation:</strong> Ensure deep watering every 7-10 days. Monitor for red rot disease.');
                    break;
            }
            
            // Seasonal suggestions
            const currentMonth = new Date().getMonth();
            if (currentMonth >= 5 && currentMonth <= 8) { // Monsoon months
                suggestions.push(' <strong>Monsoon Care:</strong> Ensure proper drainage to prevent waterlogging. Monitor for fungal infections.');
            } else if (currentMonth >= 11 || currentMonth <= 2) { // Winter months
                suggestions.push(' <strong>Winter Care:</strong> Protect sensitive crops from cold. Adjust irrigation schedules for lower evaporation.');
            }
            
            // Default suggestion if none generated
            if (suggestions.length === 0) {
                suggestions.push(' <strong>General Care:</strong> Continue monitoring crop health regularly and maintain optimal growing conditions.');
            }
            
            return suggestions.slice(0, 4); // Limit to 4 suggestions for better UI
        }

        function filterCrops() {
            const typeFilter = document.getElementById('cropTypeFilter').value;
            const statusFilter = document.getElementById('cropStatusFilter').value;
            const yearFilter = document.getElementById('cropYearFilter').value;
            
            const crops = JSON.parse(localStorage.getItem(STORAGE_KEYS.CROPS) || '[]');
            
            const filteredCrops = crops.filter(crop => {
                const matchesType = !typeFilter || crop.type === typeFilter;
                const matchesStatus = !statusFilter || crop.status === statusFilter;
                const matchesYear = !yearFilter || new Date(crop.sowingDate).getFullYear().toString() === yearFilter;
                
                return matchesType && matchesStatus && matchesYear;
            });
            
            displayCrops(filteredCrops);
        }

        function showAddCropModal() {
            document.getElementById('addCropModal').classList.add('active');
            
            // Set default location from profile
            const userData = JSON.parse(localStorage.getItem(STORAGE_KEYS.USER_DATA) || '{}');
            if (userData.location) {
                document.getElementById('cropLocation').value = userData.location;
            } else if (userLocation.name) {
                document.getElementById('cropLocation').value = userLocation.name;
            }
        }

        function handleAddCrop(e) {
            e.preventDefault();
            
            const selectedCropType = document.getElementById('selectedCropType').value;
            if (!selectedCropType) {
                showNotification('Please select a crop type', 'error');
                return;
            }
            
            const area = parseFloat(document.getElementById('cropArea').value);
            const duration = parseInt(document.getElementById('cropDuration').value);
            
            if (!area || area <= 0) {
                showNotification('Please enter a valid area', 'error');
                return;
            }
            
            if (!duration || duration <= 0) {
                showNotification('Please enter a valid duration', 'error');
                return;
            }
            
            const newCrop = {
                id: Date.now().toString(),
                type: selectedCropType,
                variety: document.getElementById('cropVariety').value,
                area: area,
                duration: duration,
                location: document.getElementById('cropLocation').value,
                sowingDate: document.getElementById('sowingDate').value,
                expectedHarvest: document.getElementById('expectedHarvest').value,
                status: 'active',
                totalExpenses: 0,
                createdAt: new Date().toISOString()
            };
            
            let crops = JSON.parse(localStorage.getItem(STORAGE_KEYS.CROPS) || '[]');
            crops.push(newCrop);
            localStorage.setItem(STORAGE_KEYS.CROPS, JSON.stringify(crops));
            
            autoSaveToFirebase();
            
            loadCrops();
            updateDashboardStats();
            closeModal('addCropModal');
            document.getElementById('addCropForm').reset();
            
            document.querySelectorAll('.crop-image-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            showNotification(` ${cropData[selectedCropType].emoji} ${cropData[selectedCropType].name} crop added successfully! `, 'success');
        }

        function addCropExpense(cropId) {
            const amount = prompt('Enter expense amount ():');
            const description = prompt('Enter expense description:');
            
            if (amount && description && parseFloat(amount) > 0) {
                const expenseAmount = parseFloat(amount);
                
                let crops = JSON.parse(localStorage.getItem(STORAGE_KEYS.CROPS) || '[]');
                const cropIndex = crops.findIndex(c => c.id === cropId);
                
                if (cropIndex !== -1) {
                    crops[cropIndex].totalExpenses = (crops[cropIndex].totalExpenses || 0) + expenseAmount;
                    localStorage.setItem(STORAGE_KEYS.CROPS, JSON.stringify(crops));
                    
                    // Add to asset transactions for tracking
                    const transaction = {
                        id: Date.now().toString(),
                        assetId: `crop-${cropId}`,
                        type: 'expense',
                        description: description,
                        amount: expenseAmount,
                        date: new Date().toISOString().split('T')[0],
                        createdAt: new Date().toISOString()
                    };
                    
                    let assetTransactions = JSON.parse(localStorage.getItem(STORAGE_KEYS.ASSET_TRANSACTIONS) || '[]');
                    assetTransactions.push(transaction);
                    localStorage.setItem(STORAGE_KEYS.ASSET_TRANSACTIONS, JSON.stringify(assetTransactions));
                    
                    autoSaveToFirebase();
                    loadCrops();
                    updateDashboardStats();
                    showNotification(` Expense added: ${expenseAmount.toLocaleString('en-IN')} for ${description}`, 'success');
                }
            } else {
                showNotification('Please enter valid expense details', 'error');
            }
        }

        function viewCropDetails(cropId) {
            const crops = JSON.parse(localStorage.getItem(STORAGE_KEYS.CROPS) || '[]');
            const crop = crops.find(c => c.id === cropId);
            
            if (crop) {
                const progress = calculateCropProgress(crop);
                const daysRemaining = getDaysRemaining(crop.expectedHarvest);
                const cropInfo = cropData[crop.type] || {};
                
                const details = `
Crop Details:

 Type: ${crop.type.charAt(0).toUpperCase() + crop.type.slice(1)}
 Variety: ${crop.variety || 'Not specified'}
 Location: ${crop.location}
 Area: ${crop.area} acres
 Duration: ${crop.duration} months
 Sowing Date: ${new Date(crop.sowingDate).toLocaleDateString('en-IN')}
 Expected Harvest: ${new Date(crop.expectedHarvest).toLocaleDateString('en-IN')}
 Progress: ${progress}%
 Days Remaining: ${daysRemaining}
 Status: ${crop.status.toUpperCase()}
 Total Expenses: ${(crop.totalExpenses || 0).toLocaleString('en-IN')}
${crop.totalSaleAmount ? ` Sale Amount: ${crop.totalSaleAmount.toLocaleString('en-IN')}` : ''}
${crop.totalSaleAmount && crop.totalExpenses ? ` Profit: ${(crop.totalSaleAmount - crop.totalExpenses).toLocaleString('en-IN')}` : ''}
                `;
                
                alert(details);
            }
        }

        function harvestCrop(cropId) {
            const harvestAmount = prompt('Enter harvest amount (in quintals):');
            const salePrice = prompt('Enter sale price per quintal ():');
            
            if (harvestAmount && salePrice && parseFloat(harvestAmount) > 0 && parseFloat(salePrice) > 0) {
                const totalSale = parseFloat(harvestAmount) * parseFloat(salePrice);
                
                let crops = JSON.parse(localStorage.getItem(STORAGE_KEYS.CROPS) || '[]');
                const cropIndex = crops.findIndex(c => c.id === cropId);
                
                if (cropIndex !== -1) {
                    crops[cropIndex].status = 'harvested';
                    crops[cropIndex].harvestDate = new Date().toISOString().split('T')[0];
                    crops[cropIndex].harvestAmount = parseFloat(harvestAmount);
                    crops[cropIndex].salePrice = parseFloat(salePrice);
                    crops[cropIndex].totalSaleAmount = totalSale;
                    
                    localStorage.setItem(STORAGE_KEYS.CROPS, JSON.stringify(crops));
                    
                    // Add income transaction
                    const transaction = {
                        id: Date.now().toString(),
                        assetId: `crop-${cropId}`,
                        type: 'income',
                        description: `Harvest sale - ${crops[cropIndex].type}`,
                        amount: totalSale,
                        date: new Date().toISOString().split('T')[0],
                        createdAt: new Date().toISOString()
                    };
                    
                    let assetTransactions = JSON.parse(localStorage.getItem(STORAGE_KEYS.ASSET_TRANSACTIONS) || '[]');
                    assetTransactions.push(transaction);
                    localStorage.setItem(STORAGE_KEYS.ASSET_TRANSACTIONS, JSON.stringify(assetTransactions));
                    
                    autoSaveToFirebase();
                    loadCrops();
                    updateDashboardStats();
                    
                    const profit = totalSale - (crops[cropIndex].totalExpenses || 0);
                    showNotification(` Crop harvested successfully! 
                    Sale: ${totalSale.toLocaleString('en-IN')}
                    Profit: ${profit.toLocaleString('en-IN')}`, 'success');
                }
            } else {
                showNotification('Please enter valid harvest amount and sale price', 'error');
            }
        }

        function deleteCrop(cropId) {
            if (confirm('Are you sure you want to delete this crop? This action cannot be undone.')) {
                let crops = JSON.parse(localStorage.getItem(STORAGE_KEYS.CROPS) || '[]');
                crops = crops.filter(c => c.id !== cropId);
                localStorage.setItem(STORAGE_KEYS.CROPS, JSON.stringify(crops));
                
                autoSaveToFirebase();
                loadCrops();
                updateDashboardStats();
                showNotification(' Crop removed successfully', 'info');
            }
        }

        // Asset Management Functions
        function loadAssets() {
            const assets = JSON.parse(localStorage.getItem(STORAGE_KEYS.ASSETS) || '[]');
            displayAssets(assets);
        }

        function displayAssets(assets) {
            const assetsList = document.getElementById('assetsList');
            
            if (assets.length === 0) {
                assetsList.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <i class="fas fa-tractor"></i>
                        <h3>No assets registered</h3>
                        <p>Start tracking your farm equipment, livestock, land, and inventory to manage your agricultural assets effectively and optimize your farm operations.</p>
                        <button class="btn btn-primary" onclick="showAddAssetModal()">
                            <i class="fas fa-plus"></i> Add Your First Asset
                        </button>
                    </div>
                `;
                return;
            }
            
            assetsList.innerHTML = assets.map(asset => {
                const currentValue = calculateCurrentValue(asset);
                const transactions = getAssetTransactions(asset.id);
                const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                const netProfit = totalIncome - totalExpenses;
                
                return `
                    <div class="card" style="transition: all 0.4s ease;">
                        <div style="display: flex; align-items: center; gap: 1.5rem; margin-bottom: 2rem;">
                            <div style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); padding: 1.5rem; border-radius: 16px; color: white; box-shadow: var(--shadow);">
                                <i class="${getAssetIcon(asset.type)}" style="font-size: 2.5rem;"></i>
                            </div>
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 0.5rem 0; color: var(--primary-color); font-size: 1.4rem;">${asset.name}</h3>
                                <p style="margin: 0; color: var(--text-secondary); text-transform: capitalize; font-size: 1rem; font-weight: 500;">${getAssetTypeName(asset.type)}</p>
                                ${asset.purchaseDate ? `
                                    <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: var(--text-secondary);">
                                        <i class="fas fa-calendar"></i> Purchased: ${new Date(asset.purchaseDate).toLocaleDateString('en-IN')}
                                    </p>
                                ` : ''}
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.8rem; font-weight: bold; color: var(--primary-color); margin-bottom: 0.25rem;">
                                    ${currentValue.toLocaleString('en-IN')}
                                </div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary); font-weight: 500;">Current Value</div>
                            </div>
                        </div>
                        
                        <!-- Enhanced Financial Summary -->
                        <div style="background: linear-gradient(135deg, rgba(46, 125, 50, 0.05), rgba(46, 125, 50, 0.02)); padding: 2rem; border-radius: 16px; margin-bottom: 2rem; border: 1px solid rgba(46, 125, 50, 0.1);">
                            <h4 style="margin-bottom: 1.5rem; color: var(--primary-color); display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-chart-bar"></i> Financial Overview
                            </h4>
                            <div class="grid grid-3 gap-3" style="text-align: center;">
                                <div style="background: rgba(16, 185, 129, 0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(16, 185, 129, 0.2);">
                                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--success-color); margin-bottom: 0.5rem;">${totalIncome.toLocaleString('en-IN')}</div>
                                    <div style="color: var(--success-color); font-size: 0.9rem; font-weight: 600;">
                                        <i class="fas fa-arrow-up"></i> Income
                                    </div>
                                </div>
                                <div style="background: rgba(239, 68, 68, 0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(239, 68, 68, 0.2);">
                                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--error-color); margin-bottom: 0.5rem;">${totalExpenses.toLocaleString('en-IN')}</div>
                                    <div style="color: var(--error-color); font-size: 0.9rem; font-weight: 600;">
                                        <i class="fas fa-arrow-down"></i> Expenses
                                    </div>
                                </div>
                                <div style="background: rgba(${netProfit >= 0 ? '16, 185, 129' : '239, 68, 68'}, 0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(${netProfit >= 0 ? '16, 185, 129' : '239, 68, 68'}, 0.2);">
                                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--${netProfit >= 0 ? 'success' : 'error'}-color); margin-bottom: 0.5rem;">${netProfit.toLocaleString('en-IN')}</div>
                                    <div style="color: var(--${netProfit >= 0 ? 'success' : 'error'}-color); font-size: 0.9rem; font-weight: 600;">
                                        <i class="fas fa-chart-line"></i> Net P&L
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Enhanced Asset Actions -->
                        <div class="flex gap-2" style="flex-wrap: wrap;">
                            <button class="btn btn-success btn-sm" onclick="addAssetTransaction('${asset.id}', 'income')">
                                <i class="fas fa-plus-circle"></i> Add Income
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="addAssetTransaction('${asset.id}', 'expense')">
                                <i class="fas fa-minus-circle"></i> Add Expense
                            </button>
                            <button class="btn btn-info btn-sm" onclick="viewAssetTransactions('${asset.id}')">
                                <i class="fas fa-history"></i> View History
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="editAsset('${asset.id}')">
                                <i class="fas fa-edit"></i> Edit Asset
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getAssetIcon(type) {
            const icons = {
                equipment: 'fas fa-tractor',
                livestock: 'fas fa-horse',
                land: 'fas fa-map',
                inventory: 'fas fa-boxes'
            };
            return icons[type] || 'fas fa-box';
        }

        function getAssetTypeName(type) {
            const types = {
                equipment: 'Farm Equipment',
                livestock: 'Livestock',
                land: 'Agricultural Land',
                inventory: 'Farm Inventory'
            };
            return types[type] || type;
        }

        function calculateCurrentValue(asset) {
            if (!asset.purchasePrice) return 0;
            
            if (asset.type === 'equipment' && asset.purchaseDate) {
                const years = (new Date().getFullYear() - new Date(asset.purchaseDate).getFullYear());
                const depreciationRate = 0.10;
                return Math.max(asset.purchasePrice * Math.pow(1 - depreciationRate, years), asset.purchasePrice * 0.1);
            }
            
            return asset.purchasePrice;
        }

        function getAssetTransactions(assetId) {
            const transactions = JSON.parse(localStorage.getItem(STORAGE_KEYS.ASSET_TRANSACTIONS) || '[]');
            return transactions.filter(t => t.assetId === assetId);
        }

        function showAddAssetModal() {
            document.getElementById('addAssetModal').classList.add('active');
        }

        function handleAddAsset(e) {
            e.preventDefault();
            
            const assetData = {
                id: Date.now().toString(),
                type: document.getElementById('assetType').value,
                name: document.getElementById('assetName').value,
                purchaseDate: document.getElementById('assetPurchaseDate').value,
                purchasePrice: parseFloat(document.getElementById('assetPurchasePrice').value) || 0,
                createdAt: new Date().toISOString()
            };
            
            let assets = JSON.parse(localStorage.getItem(STORAGE_KEYS.ASSETS) || '[]');
            assets.push(assetData);
            localStorage.setItem(STORAGE_KEYS.ASSETS, JSON.stringify(assets));
            
            autoSaveToFirebase();
            
            loadAssets();
            closeModal('addAssetModal');
            document.getElementById('addAssetForm').reset();
            
            showNotification(` ${assetData.name} added to your ${getAssetTypeName(assetData.type).toLowerCase()} successfully!`, 'success');
        }

        function addAssetTransaction(assetId, type) {
            const amount = prompt(`Enter ${type} amount ():`);
            const description = prompt(`Enter ${type} description:`);
            
            if (amount && description && parseFloat(amount) > 0) {
                const transactionData = {
                    id: Date.now().toString(),
                    assetId: assetId,
                    type: type,
                    description: description,
                    amount: parseFloat(amount),
                    date: new Date().toISOString().split('T')[0],
                    createdAt: new Date().toISOString()
                };
                
                let transactions = JSON.parse(localStorage.getItem(STORAGE_KEYS.ASSET_TRANSACTIONS) || '[]');
                transactions.push(transactionData);
                localStorage.setItem(STORAGE_KEYS.ASSET_TRANSACTIONS, JSON.stringify(transactions));
                
                autoSaveToFirebase();
                loadAssets();
                updateDashboardStats();
                
                showNotification(` ${type === 'income' ? 'Income' : 'Expense'} of ${parseFloat(amount).toLocaleString('en-IN')} added for ${description}`, 'success');
            } else {
                showNotification('Please enter valid amount and description', 'error');
            }
        }

        function viewAssetTransactions(assetId) {
            const transactions = getAssetTransactions(assetId);
            const asset = JSON.parse(localStorage.getItem(STORAGE_KEYS.ASSETS) || '[]').find(a => a.id === assetId);
            
            if (transactions.length === 0) {
                alert('No transactions found for this asset.');
                return;
            }
            
            let report = `Transaction History for ${asset ? asset.name : 'Asset'}:\n\n`;
            
            transactions.forEach(transaction => {
                report += `${new Date(transaction.date).toLocaleDateString('en-IN')}: ${transaction.description} - ${transaction.type === 'income' ? '+' : '-'}${transaction.amount.toLocaleString('en-IN')}\n`;
            });
            
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            
            report += `\n--- SUMMARY ---\nTotal Income: ${totalIncome.toLocaleString('en-IN')}\nTotal Expenses: ${totalExpenses.toLocaleString('en-IN')}\nNet Profit: ${(totalIncome - totalExpenses).toLocaleString('en-IN')}\nTotal Transactions: ${transactions.length}`;
            
            alert(report);
        }

        function editAsset(assetId) {
            const assets = JSON.parse(localStorage.getItem(STORAGE_KEYS.ASSETS) || '[]');
            const asset = assets.find(a => a.id === assetId);
            
            if (asset) {
                document.getElementById('assetType').value = asset.type;
                document.getElementById('assetName').value = asset.name;
                document.getElementById('assetPurchaseDate').value = asset.purchaseDate;
                document.getElementById('assetPurchasePrice').value = asset.purchasePrice;
                
                showAddAssetModal();
            }
        }

        // Loan Management Functions
        function loadLoans() {
            const loans = JSON.parse(localStorage.getItem(STORAGE_KEYS.LOANS) || '[]');
            // For this demo, we'll just update the stats as loans aren't displayed on dashboard
        }

        function showAddLoanModal() {
            document.getElementById('addLoanModal').classList.add('active');
        }

        function calculateLoanDetails() {
            const amount = parseFloat(document.getElementById('loanAmount').value) || 0;
            const interestRate = parseFloat(document.getElementById('loanInterestRate').value) || 0;
            const duration = parseFloat(document.getElementById('loanDuration').value) || 12;
            
            // Calculate compound interest
            const totalAmount = amount * (1 + (interestRate / 100) * (duration / 12));
            
            document.getElementById('totalLoanAmount').value = totalAmount.toFixed(2);
        }

        function handleAddLoan(e) {
            e.preventDefault();
            
            const loanData = {
                id: Date.now().toString(),
                type: document.getElementById('loanType').value,
                source: document.getElementById('loanSource').value,
                amount: parseFloat(document.getElementById('loanAmount').value),
                interestRate: parseFloat(document.getElementById('loanInterestRate').value),
                startDate: document.getElementById('loanStartDate').value,
                duration: parseInt(document.getElementById('loanDuration').value),
                totalAmount: parseFloat(document.getElementById('totalLoanAmount').value),
                paidAmount: 0,
                status: 'active',
                createdAt: new Date().toISOString()
            };
            
            let loans = JSON.parse(localStorage.getItem(STORAGE_KEYS.LOANS) || '[]');
            loans.push(loanData);
            localStorage.setItem(STORAGE_KEYS.LOANS, JSON.stringify(loans));
            
            autoSaveToFirebase();
            
            closeModal('addLoanModal');
            document.getElementById('addLoanForm').reset();
            
            showNotification(` ${loanData.type === 'taken' ? 'Loan taken' : 'Loan given'} of ${loanData.amount.toLocaleString('en-IN')} from/to ${loanData.source} added successfully!`, 'success');
        }

        // Smart Suggestions Functions
        function loadSuggestions() {
            const crops = JSON.parse(localStorage.getItem(STORAGE_KEYS.CROPS) || '[]');
            const assets = JSON.parse(localStorage.getItem(STORAGE_KEYS.ASSETS) || '[]');
            const assetTransactions = JSON.parse(localStorage.getItem(STORAGE_KEYS.ASSET_TRANSACTIONS) || '[]');
            
            const suggestions = generateSmartSuggestions(crops, assets, assetTransactions);
            displaySuggestions(suggestions);
        }

        function generateSmartSuggestions(crops, assets, transactions) {
            const suggestions = [];
            
            // Weather-based suggestions for each crop
            crops.forEach(crop => {
                if (crop.status === 'active' && weatherData) {
                    const cropInfo = cropData[crop.type];
                    if (cropInfo) {
                        const temp = weatherData.temperature;
                        const humidity = weatherData.humidity;
                        
                        // Temperature-based suggestions
                        if (temp > cropInfo.optimalTemp[1]) {
                            suggestions.push({
                                id: `temp-high-${crop.id}`,
                                category: 'Weather Alert',
                                title: ` High Temperature Alert for ${crop.type.charAt(0).toUpperCase() + crop.type.slice(1)}`,
                                description: `Temperature (${temp}C) is above optimal range for ${crop.type} in ${crop.location}. Consider increasing irrigation frequency, providing temporary shade, and applying mulch to reduce soil temperature.`,
                                icon: 'fas fa-thermometer-full',
                                urgency: 'high',
                                type: 'weather-alert',
                                location: crop.location
                            });
                        } else if (temp < cropInfo.optimalTemp[0]) {
                            suggestions.push({
                                id: `temp-low-${crop.id}`,
                                category: 'Weather Alert',
                                title: ` Low Temperature Alert for ${crop.type.charAt(0).toUpperCase() + crop.type.slice(1)}`,
                                description: `Temperature (${temp}C) is below optimal range for ${crop.type} in ${crop.location}. Implement frost protection measures, reduce watering frequency, and consider using row covers or greenhouse protection.`,
                                icon: 'fas fa-snowflake',
                                urgency: 'high',
                                type: 'weather-alert',
                                location: crop.location
                            });
                        }
                        
                        // Humidity-based suggestions
                        if (humidity > cropInfo.optimalHumidity[1]) {
                            suggestions.push({
                                id: `humidity-high-${crop.id}`,
                                category: 'Crop Care',
                                title: ` High Humidity Warning for ${crop.type.charAt(0).toUpperCase() + crop.type.slice(1)}`,
                                description: `Humidity (${humidity}%) is high for ${crop.type} in ${crop.location}. Improve air circulation around plants, monitor for fungal diseases like powdery mildew, and consider organic fungicides as prevention.`,
                                icon: 'fas fa-tint',
                                urgency: 'medium',
                                type: 'crop-care',
                                location: crop.location
                            });
                        }
                    }
                    
                    // Growth stage suggestions
                    const progress = calculateCropProgress(crop);
                    const daysRemaining = getDaysRemaining(crop.expectedHarvest);
                    
                    if (daysRemaining < 7 && progress > 90) {
                        suggestions.push({
                            id: `harvest-ready-${crop.id}`,
                            category: 'Harvest Alert',
                            title: ` ${crop.type.charAt(0).toUpperCase() + crop.type.slice(1)} Ready for Harvest`,
                            description: `Your ${crop.type} crop in ${crop.location} will be ready for harvest in ${daysRemaining} days. Check current market prices, prepare harvesting equipment, and ensure proper storage facilities are ready.`,
                            icon: 'fas fa-cut',
                            urgency: 'high',
                            type: 'harvest-alert',
                            location: crop.location
                        });
                    }
                }
            });
            
            // Admin-hosted general suggestions with seasonal relevance
            const currentMonth = new Date().getMonth();
            const adminSuggestions = [
                {
                    id: 'soil-testing',
                    category: 'Soil Health',
                    title: ' Comprehensive Soil Analysis',
                    description: 'Conduct detailed soil testing every 6 months to optimize fertilizer usage and monitor pH, NPK levels, organic matter content, and micronutrients. This helps in precision farming and reduces input costs by 15-20%.',
                    icon: 'fas fa-vial',
                    urgency: 'low',
                    type: 'soil-testing'
                },
                {
                    id: 'crop-rotation',
                    category: 'Sustainable Farming',
                    title: ' Strategic Crop Rotation Planning',
                    description: 'Plan crop rotation to naturally improve soil fertility, reduce pest and disease pressure, and increase long-term productivity. Rotate between nitrogen-fixing legumes and nutrient-demanding crops for optimal soil health.',
                    icon: 'fas fa-sync-alt',
                    urgency: 'low',
                    type: 'crop-rotation'
                },
                {
                    id: 'integrated-pest-management',
                    category: 'Pest Control',
                    title: ' Integrated Pest Management Strategy',
                    description: 'Implement IPM combining biological control (beneficial insects), cultural practices (crop rotation), and targeted chemical applications. This approach reduces pesticide use by 40% while maintaining crop protection.',
                    icon: 'fas fa-bug',
                    urgency: 'medium',
                    type: 'pest-management'
                },
                {
                    id: 'water-conservation',
                    category: 'Water Management',
                    title: ' Smart Water Conservation Systems',
                    description: 'Install drip irrigation systems, implement mulching techniques, and set up rainwater harvesting. Monitor soil moisture with sensors to optimize irrigation scheduling and reduce water usage by 30%.',
                    icon: 'fas fa-tint',
                    urgency: 'medium',
                    type: 'water-conservation'
                },
                {
                    id: 'organic-farming',
                    category: 'Sustainable Practices',
                    title: ' Organic Farming Transition',
                    description: 'Consider transitioning to certified organic farming practices. Use compost, bio-fertilizers, natural pest control methods for healthier crops and access to premium organic markets with 20-30% higher prices.',
                    icon: 'fas fa-leaf',
                    urgency: 'low',
                    type: 'organic-farming'
                }
            ];
            
            // Add seasonal suggestions
            if (currentMonth >= 5 && currentMonth <= 8) { // Monsoon season
                adminSuggestions.push({
                    id: 'monsoon-preparation',
                    category: 'Seasonal Care',
                    title: ' Monsoon Farming Preparation',
                    description: 'Prepare for monsoon season by ensuring proper drainage systems, selecting appropriate monsoon crops, and implementing water management strategies to prevent waterlogging and soil erosion.',
                    icon: 'fas fa-cloud-rain',
                    urgency: 'high',
                    type: 'seasonal'
                });
            } else if (currentMonth >= 11 || currentMonth <= 2) { // Winter season
                adminSuggestions.push({
                    id: 'winter-farming',
                    category: 'Seasonal Care',
                    title: ' Winter Crop Management',
                    description: 'Optimize winter farming with frost protection measures, appropriate crop selection for rabi season, and adjusted irrigation schedules. Consider greenhouse cultivation for high-value crops.',
                    icon: 'fas fa-snowflake',
                    urgency: 'medium',
                    type: 'seasonal'
                });
            }
            
            // Add 3-4 random admin suggestions
            const shuffledAdmin = adminSuggestions.sort(() => Math.random() - 0.5);
            suggestions.push(...shuffledAdmin.slice(0, 4));
            
            // Financial suggestions
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            
            if (totalExpenses > totalIncome * 0.8 && totalIncome > 0) {
                suggestions.push({
                    id: 'financial-optimization',
                    category: 'Financial Planning',
                    title: ' Farm Financial Optimization',
                    description: `Your expenses are ${((totalExpenses/totalIncome)*100).toFixed(1)}% of income. Consider cost-reduction strategies like bulk purchasing of inputs, energy-efficient equipment, group buying with other farmers, or exploring organic alternatives to reduce chemical costs.`,
                    icon: 'fas fa-chart-line',
                    urgency: 'medium',
                    type: 'financial-optimization'
                });
            }
            
            // Technology adoption suggestions
            if (crops.length > 3) {
                suggestions.push({
                    id: 'technology-adoption',
                    category: 'Farm Technology',
                    title: ' Smart Farming Technology',
                    description: 'With multiple crops, consider adopting precision farming technologies like GPS-guided tractors, drone monitoring for crop health assessment, and automated irrigation systems to increase efficiency and yields.',
                    icon: 'fas fa-robot',
                    urgency: 'low',
                    type: 'technology'
                });
            }
            
            return suggestions;
        }

        function displaySuggestions(suggestions) {
            const suggestionsGrid = document.getElementById('suggestionsGrid');
            
            if (suggestions.length === 0) {
                suggestionsGrid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <i class="fas fa-lightbulb"></i>
                        <h3>Loading smart suggestions...</h3>
                        <p>Add crops and update your weather location to get personalized farming suggestions and recommendations.</p>
                        <button class="btn btn-primary" onclick="showAddCropModal()">
                            <i class="fas fa-plus"></i> Add Your First Crop
                        </button>
                    </div>
                `;
                return;
            }
            
            suggestionsGrid.innerHTML = suggestions.map(suggestion => `
                <div class="card" style="border-left: 6px solid var(--${getUrgencyColor(suggestion.urgency)}-color); position: relative; overflow: hidden;">
                    <div style="position: absolute; top: 0; right: 0; width: 100px; height: 100px; background: radial-gradient(circle, rgba(${getUrgencyColor(suggestion.urgency) === 'error' ? '239, 68, 68' : getUrgencyColor(suggestion.urgency) === 'warning' ? '245, 158, 11' : '16, 185, 129'}, 0.05), transparent); pointer-events: none;"></div>
                    
                    <div style="background: linear-gradient(135deg, rgba(46, 125, 50, 0.1), rgba(46, 125, 50, 0.05)); padding: 0.75rem 1.5rem; border-radius: 25px; display: inline-block; margin-bottom: 1.5rem; font-size: 0.9rem; font-weight: 600; color: var(--primary-color);">
                        ${suggestion.category}
                        ${suggestion.location ? `  <i class="fas fa-map-marker-alt"></i> ${suggestion.location}` : ''}
                    </div>
                    
                    <div style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); padding: 1.5rem; border-radius: 16px; color: white; margin-bottom: 1.5rem; display: inline-block;">
                        <i class="${suggestion.icon}" style="font-size: 2.5rem;"></i>
                    </div>
                    
                    <h3 style="color: var(--primary-color); margin-bottom: 1.5rem; font-size: 1.3rem; line-height: 1.4;">${suggestion.title}</h3>
                    
                    <p style="margin-bottom: 2rem; line-height: 1.7; font-size: 1rem; color: var(--text-primary);">${suggestion.description}</p>
                    
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem;">
                        <div style="padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; ${getUrgencyStyle(suggestion.urgency)} display: inline-flex; align-items: center; gap: 0.5rem;">
                            ${getUrgencyText(suggestion.urgency)}
                        </div>
                        ${suggestion.type === 'weather-alert' ? `
                            <div style="font-size: 0.8rem; color: var(--text-secondary); display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-clock"></i> Updated now
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="flex gap-2">
                        <button class="btn btn-primary btn-sm" onclick="implementSuggestion('${suggestion.id}', '${suggestion.title}')">
                            <i class="fas fa-check"></i> Mark as Done
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="dismissSuggestion('${suggestion.id}')">
                            <i class="fas fa-times"></i> Dismiss
                        </button>
                        ${suggestion.type === 'weather-alert' ? `
                            <button class="btn btn-info btn-sm" onclick="refreshWeather()">
                                <i class="fas fa-sync-alt"></i> Refresh Weather
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function getUrgencyColor(urgency) {
            const colors = {
                high: 'error',
                medium: 'warning',
                low: 'success'
            };
            return colors[urgency] || 'success';
        }

        function getUrgencyStyle(urgency) {
            const styles = {
                high: 'background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05)); color: var(--error-color); border: 1px solid rgba(239, 68, 68, 0.2);',
                medium: 'background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05)); color: var(--warning-color); border: 1px solid rgba(245, 158, 11, 0.2);',
                low: 'background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05)); color: var(--success-color); border: 1px solid rgba(16, 185, 129, 0.2);'
            };
            return styles[urgency] || styles.low;
        }

        function getUrgencyText(urgency) {
            const texts = {
                high: ' Urgent Action Needed',
                medium: ' Important',
                low: ' General Advice'
            };
            return texts[urgency] || texts.low;
        }

        function implementSuggestion(suggestionId, title) {
            showNotification(` "${title}" marked as implemented! Great job on improving your farm management! `, 'success');
        }

        function dismissSuggestion(suggestionId) {
            showNotification('Suggestion dismissed ', 'info');
        }

        // Settings and Profile Functions
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem(STORAGE_KEYS.SETTINGS) || '{}');
            
            if (settings.theme) {
                setTheme(settings.theme);
            }
        }

        function saveSettings() {
            const settings = {
                theme: currentTheme,
                lastSaved: new Date().toISOString()
            };
            
            localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(settings));
            autoSaveToFirebase();
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(currentTheme);
        }

        function setTheme(theme) {
            currentTheme = theme;
            document.documentElement.setAttribute('data-theme', theme);
            updateThemeIcon();
            updateThemeButtons();
            saveSettings();
        }

        function updateThemeIcon() {
            const icon = document.querySelector('#themeToggle i');
            if (icon) {
                icon.className = currentTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
            }
        }

        function updateThemeButtons() {
            const lightBtn = document.getElementById('lightThemeBtn');
            const darkBtn = document.getElementById('darkThemeBtn');
            
            if (lightBtn && darkBtn) {
                lightBtn.classList.toggle('btn-primary', currentTheme === 'light');
                lightBtn.classList.toggle('btn-secondary', currentTheme !== 'light');
                darkBtn.classList.toggle('btn-primary', currentTheme === 'dark');
                darkBtn.classList.toggle('btn-secondary', currentTheme !== 'dark');
            }
        }

        async function handleUpdateProfile(e) {
            e.preventDefault();
            
            const profileData = {
                name: document.getElementById('profileName').value,
                email: document.getElementById('profileEmail').value,
                location: document.getElementById('profileLocation').value,
                farmSize: parseFloat(document.getElementById('profileFarmSize').value) || 0,
                updatedAt: new Date().toISOString()
            };
            
            try {
                if (currentUser && currentUser.uid) {
                    await db.collection('users').doc(currentUser.uid).update(profileData);
                }
                
                const userData = JSON.parse(localStorage.getItem(STORAGE_KEYS.USER_DATA) || '{}');
                localStorage.setItem(STORAGE_KEYS.USER_DATA, JSON.stringify({...userData, ...profileData}));
                
                document.getElementById('userNameDisplay').textContent = profileData.name || 'Farmer';
                
                // Update weather location if location changed
                if (profileData.location && profileData.location !== userLocation.name) {
                    userLocation.name = profileData.location;
                    localStorage.setItem(STORAGE_KEYS.USER_LOCATION, JSON.stringify(userLocation));
                    await getWeatherByLocationName(profileData.location);
                }
                
                showNotification(' Profile updated successfully! Your farm information has been saved.', 'success');
                autoSaveToFirebase();
            } catch (error) {
                console.error('Profile update error:', error);
                showNotification('Error updating profile. Please try again.', 'error');
            }
        }

        // Data Management Functions
        async function autoSaveToFirebase() {
            if (!currentUser || !currentUser.uid) return;
            
            try {
                const crops = JSON.parse(localStorage.getItem(STORAGE_KEYS.CROPS) || '[]');
                const assets = JSON.parse(localStorage.getItem(STORAGE_KEYS.ASSETS) || '[]');
                const assetTransactions = JSON.parse(localStorage.getItem(STORAGE_KEYS.ASSET_TRANSACTIONS) || '[]');
                const loans = JSON.parse(localStorage.getItem(STORAGE_KEYS.LOANS) || '[]');
                const settings = JSON.parse(localStorage.getItem(STORAGE_KEYS.SETTINGS) || '{}');

                const userRef = db.collection('userData').doc(currentUser.uid);
                await userRef.set({
                    crops,
                    assets,
                    assetTransactions,
                    loans,
                    settings,
                    lastSaved: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
            } catch (error) {
                console.error('Auto-save error:', error);
            }
        }

        async function exportAllData() {
            try {
                showNotification(' Generating comprehensive farm report with enhanced analytics...', 'info');
                
                const userData = JSON.parse(localStorage.getItem(STORAGE_KEYS.USER_DATA) || '{}');
                const crops = JSON.parse(localStorage.getItem(STORAGE_KEYS.CROPS) || '[]');
                const assets = JSON.parse(localStorage.getItem(STORAGE_KEYS.ASSETS) || '[]');
                const assetTransactions = JSON.parse(localStorage.getItem(STORAGE_KEYS.ASSET_TRANSACTIONS) || '[]');
                const loans = JSON.parse(localStorage.getItem(STORAGE_KEYS.LOANS) || '[]');
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let yPos = 20;
                
                // Header with enhanced styling
                doc.setFontSize(28);
                doc.setTextColor(46, 125, 50);
                doc.text(' JamaApp Farm Report', 20, yPos);
                yPos += 15;
                doc.setFontSize(12);
                doc.setTextColor(100, 116, 139);
                doc.text(`Generated: ${new Date().toLocaleDateString('en-IN')} at ${new Date().toLocaleTimeString('en-IN')}`, 20, yPos);
                yPos += 25;
                
                // Farm Overview
                doc.setFontSize(18);
                doc.setTextColor(46, 125, 50);
                doc.text(' Farm Overview', 20, yPos);
                yPos += 15;
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(` Farmer: ${userData.name || 'Not specified'}`, 20, yPos);
                yPos += 8;
                doc.text(` Location: ${userData.location || userLocation.name || 'Not specified'}`, 20, yPos);
                yPos += 8;
                doc.text(` Farm Size: ${userData.farmSize || 0} acres`, 20, yPos);
                yPos += 8;
                doc.text(` Report Period: ${new Date().getFullYear()}`, 20, yPos);
                yPos += 20;
                
                // Weather Information
                if (weatherData) {
                    doc.setFontSize(16);
                    doc.setTextColor(59, 130, 246);
                    doc.text(' Current Weather Conditions', 20, yPos);
                    yPos += 12;
                    doc.setFontSize(11);
                    doc.setTextColor(0, 0, 0);
                    doc.text(` Location: ${userLocation.name}`, 20, yPos);
                    yPos += 7;
                    doc.text(` Temperature: ${weatherData.temperature}C (${weatherData.description})`, 20, yPos);
                    yPos += 7;
                    doc.text(` Humidity: ${weatherData.humidity}%`, 20, yPos);
                    yPos += 7;
                    doc.text(` Wind Speed: ${weatherData.windSpeed || 'N/A'} km/h`, 20, yPos);
                    yPos += 7;
                    doc.text(` Rain Probability: ${weatherData.precipitationProbability || 'N/A'}%`, 20, yPos);
                    yPos += 18;
                }
                
                // Enhanced Financial Summary
                const totalIncome = assetTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0) +
                                   crops.filter(c => c.status === 'harvested' && c.totalSaleAmount).reduce((sum, c) => sum + c.totalSaleAmount, 0);
                const totalExpenses = assetTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0) +
                                     crops.reduce((sum, c) => sum + (c.totalExpenses || 0), 0);
                const netProfit = totalIncome - totalExpenses;
                const profitMargin = totalIncome > 0 ? ((netProfit / totalIncome) * 100).toFixed(1) : 0;
                
                doc.setFontSize(16);
                doc.setTextColor(16, 185, 129);
                doc.text(' Financial Performance Analysis', 20, yPos);
                yPos += 12;
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                doc.text(` Total Income: ${totalIncome.toLocaleString('en-IN')}`, 20, yPos);
                yPos += 7;
                doc.text(` Total Expenses: ${totalExpenses.toLocaleString('en-IN')}`, 20, yPos);
                yPos += 7;
                doc.text(` Net Profit: ${netProfit.toLocaleString('en-IN')}`, 20, yPos);
                yPos += 7;
                doc.text(` Profit Margin: ${profitMargin}%`, 20, yPos);
                yPos += 7;
                doc.text(` Total Transactions: ${assetTransactions.length}`, 20, yPos);
                yPos += 18;
                
                // Enhanced Crop Analysis
                doc.setFontSize(16);
                doc.setTextColor(46, 125, 50);
                doc.text(' Crop Portfolio Analysis', 20, yPos);
                yPos += 12;
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                doc.text(` Total Crops: ${crops.length}`, 20, yPos);
                yPos += 7;
                doc.text(` Active Crops: ${crops.filter(c => c.status === 'active').length}`, 20, yPos);
                yPos += 7;
                doc.text(` Harvested Crops: ${crops.filter(c => c.status === 'harvested').length}`, 20, yPos);
                yPos += 7;
                doc.text(` Planned Crops: ${crops.filter(c => c.status === 'planned').length}`, 20, yPos);
                yPos += 7;
                
                // Crop types diversity
                const cropTypes = [...new Set(crops.map(c => c.type))];
                doc.text(` Crop Diversity: ${cropTypes.length} different types`, 20, yPos);
                yPos += 7;
                doc.text(` Total Cultivated Area: ${crops.reduce((sum, c) => sum + c.area, 0).toFixed(1)} acres`, 20, yPos);
                yPos += 18;
                
                // Asset Portfolio
                if (assets.length > 0) {
                    const totalAssetValue = assets.reduce((sum, a) => sum + (a.purchasePrice || 0), 0);
                    const currentAssetValue = assets.reduce((sum, a) => sum + calculateCurrentValue(a), 0);
                    
                    doc.setFontSize(16);
                    doc.setTextColor(239, 68, 68);
                    doc.text(' Asset Portfolio Overview', 20, yPos);
                    yPos += 12;
                    doc.setFontSize(11);
                    doc.setTextColor(0, 0, 0);
                    doc.text(` Total Assets: ${assets.length}`, 20, yPos);
                    yPos += 7;
                    doc.text(` Original Value: ${totalAssetValue.toLocaleString('en-IN')}`, 20, yPos);
                    yPos += 7;
                    doc.text(` Current Value: ${currentAssetValue.toLocaleString('en-IN')}`, 20, yPos);
                    yPos += 7;
                    
                    // Asset breakdown by type
                    const equipmentCount = assets.filter(a => a.type === 'equipment').length;
                    const livestockCount = assets.filter(a => a.type === 'livestock').length;
                    const landCount = assets.filter(a => a.type === 'land').length;
                    const inventoryCount = assets.filter(a => a.type === 'inventory').length;
                    
                    doc.text(` Equipment: ${equipmentCount} items`, 20, yPos);
                    yPos += 7;
                    doc.text(` Livestock: ${livestockCount} items`, 20, yPos);
                    yPos += 7;
                    doc.text(` Land: ${landCount} parcels`, 20, yPos);
                    yPos += 7;
                    doc.text(` Inventory: ${inventoryCount} items`, 20, yPos);
                    yPos += 18;
                }
                
                // Loan Summary with enhanced details
                if (loans.length > 0) {
                    const totalLoanAmount = loans.reduce((sum, l) => sum + l.amount, 0);
                    const totalOwed = loans.reduce((sum, l) => sum + l.totalAmount, 0);
                    const totalPaidAmount = loans.reduce((sum, l) => sum + (l.paidAmount || 0), 0);
                    const outstanding = totalOwed - totalPaidAmount;
                    
                    doc.setFontSize(16);
                    doc.setTextColor(245, 158, 11);
                    doc.text(' Loan & Credit Management', 20, yPos);
                    yPos += 12;
                    doc.setFontSize(11);
                    doc.setTextColor(0, 0, 0);
                    doc.text(` Total Loans: ${loans.length}`, 20, yPos);
                    yPos += 7;
                    doc.text(` Principal Amount: ${totalLoanAmount.toLocaleString('en-IN')}`, 20, yPos);
                    yPos += 7;
                    doc.text(` Total Repayment: ${totalOwed.toLocaleString('en-IN')}`, 20, yPos);
                    yPos += 7;
                    doc.text(` Amount Paid: ${totalPaidAmount.toLocaleString('en-IN')}`, 20, yPos);
                    yPos += 7;
                    doc.text(` Outstanding: ${outstanding.toLocaleString('en-IN')}`, 20, yPos);
                    yPos += 7;
                    
                    const avgInterestRate = loans.reduce((sum, l) => sum + l.interestRate, 0) / loans.length;
                    doc.text(` Average Interest Rate: ${avgInterestRate.toFixed(2)}%`, 20, yPos);
                    yPos += 18;
                }
                
                // Productivity Metrics
                if (crops.length > 0) {
                    const harvestedCrops = crops.filter(c => c.status === 'harvested');
                    if (harvestedCrops.length > 0) {
                        const avgYieldPerAcre = harvestedCrops.reduce((sum, c) => {
                            return sum + (c.harvestAmount || 0) / c.area;
                        }, 0) / harvestedCrops.length;
                        
                        const avgProfitPerAcre = harvestedCrops.reduce((sum, c) => {
                            const profit = (c.totalSaleAmount || 0) - (c.totalExpenses || 0);
                            return sum + profit / c.area;
                        }, 0) / harvestedCrops.length;
                        
                        doc.setFontSize(16);
                        doc.setTextColor(139, 69, 19);
                        doc.text(' Productivity Metrics', 20, yPos);
                        yPos += 12;
                        doc.setFontSize(11);
                        doc.setTextColor(0, 0, 0);
                        doc.text(` Average Yield: ${avgYieldPerAcre.toFixed(2)} quintals/acre`, 20, yPos);
                        yPos += 7;
                        doc.text(` Average Profit: ${avgProfitPerAcre.toLocaleString('en-IN')}/acre`, 20, yPos);
                        yPos += 7;
                        doc.text(` Success Rate: ${((harvestedCrops.length/crops.length)*100).toFixed(1)}% crops harvested`, 20, yPos);
                        yPos += 18;
                    }
                }
                
                // Recommendations & Future Planning
                doc.setFontSize(16);
                doc.setTextColor(75, 0, 130);
                doc.text(' AI-Powered Recommendations', 20, yPos);
                yPos += 12;
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                
                const recommendations = [
                    ' Diversify crop portfolio to reduce risk and increase profitability',
                    ' Implement precision farming techniques for better yield management',
                    ' Consider organic certification for premium market access',
                    ' Optimize irrigation schedule based on weather predictions',
                    ' Regular soil testing every 6 months for nutrient management',
                    ' Explore value-added processing for higher profit margins'
                ];
                
                recommendations.forEach(rec => {
                    doc.text(rec, 20, yPos);
                    yPos += 6;
                });
                
                yPos += 10;
                
                // Footer
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text('Generated by JamaApp - Smart Farm Management System', 20, yPos);
                doc.text(`Report ID: JA-${Date.now()}`, 20, yPos + 5);
                doc.text('For support: support@jamaapp.com', 20, yPos + 10);
                
                // Save the PDF
                doc.save(`JamaApp-Comprehensive-Farm-Report-${new Date().toISOString().split('T')[0]}.pdf`);
                showNotification(' Comprehensive farm report with analytics exported successfully! ', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showNotification('Error generating report. Please try again.', 'error');
            }
        }

        async function backupData() {
            if (currentUser && currentUser.uid) {
                showNotification(' Backing up your farm data to secure cloud storage...', 'info');
                await autoSaveToFirebase();
                showNotification(' Data successfully backed up to cloud! Your farm information is safe and secure.', 'success');
            } else {
                showNotification('Please sign in to use cloud backup feature', 'warning');
            }
        }

        function clearAllData() {
            const confirmation = prompt(' WARNING: This will permanently delete ALL your farm data!\n\nThis includes:\n- All crop records\n- Asset information  \n- Financial transactions\n- Loan records\n- Settings\n\nType "DELETE ALL DATA" to confirm this irreversible action:');
            if (confirmation === 'DELETE ALL DATA') {
                Object.values(STORAGE_KEYS).forEach(key => {
                    localStorage.removeItem(key);
                });
                showNotification(' All farm data has been permanently deleted! Reloading application...', 'warning');
                setTimeout(() => {
                    location.reload();
                }, 3000);
            } else {
                showNotification(' Data deletion cancelled. Your farm data is safe!', 'info');
            }
        }

        // Enhanced Utility Functions
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            
            const form = document.querySelector(`#${modalId} form`);
            if (form) {
                form.reset();
            }
            
            if (modalId === 'addCropModal') {
                document.querySelectorAll('.crop-image-option').forEach(option => {
                    option.classList.remove('selected');
                });
                document.getElementById('selectedCropType').value = '';
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            let icon = 'fas fa-info-circle';
            switch(type) {
                case 'success': icon = 'fas fa-check-circle'; break;
                case 'error': icon = 'fas fa-exclamation-circle'; break;
                case 'warning': icon = 'fas fa-exclamation-triangle'; break;
            }
            
            notification.innerHTML = `<i class="${icon}" style="margin-right: 1rem; font-size: 1.2rem;"></i><div>${message}</div>`;
            notification.style.display = 'flex';
            notification.style.alignItems = 'flex-start';
            notification.style.gap = '0.5rem';
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 400);
            }, type === 'error' ? 7000 : 5000);
        }

        function getErrorMessage(errorCode) {
            const errorMessages = {
                'auth/invalid-email': 'Please enter a valid email address',
                'auth/user-disabled': 'This account has been disabled. Contact support for assistance.',
                'auth/user-not-found': 'No account found with this email address. Please register first.',
                'auth/wrong-password': 'Incorrect password. Please try again.',
                'auth/email-already-in-use': 'Email address is already registered. Please sign in instead.',
                'auth/weak-password': 'Password should be at least 6 characters long',
                'auth/network-request-failed': 'Network error. Please check your internet connection and try again.',
                'auth/too-many-requests': 'Too many failed attempts. Please wait a few minutes before trying again.',
                'auth/operation-not-allowed': 'This operation is not allowed. Please contact support.',
                'auth/invalid-credential': 'Invalid login credentials. Please check your email and password.'
            };
            
            return errorMessages[errorCode] || 'An unexpected error occurred. Please try again or contact support.';
        }

        // Auto-update crop duration when changed
        document.addEventListener('change', (e) => {
            if (e.target.id === 'cropDuration') {
                updateExpectedHarvest();
            }
        });

        // Enhanced page load initialization
        window.addEventListener('load', () => {
            const savedTheme = JSON.parse(localStorage.getItem(STORAGE_KEYS.SETTINGS) || '{}').theme;
            if (savedTheme) {
                setTheme(savedTheme);
            }
            
            // Add smooth scrolling
            document.documentElement.style.scrollBehavior = 'smooth';
        });

        // Enhanced keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl + N for new crop (when not in input field)
            if (e.ctrlKey && e.key === 'n' && !e.target.matches('input, textarea, select')) {
                e.preventDefault();
                showAddCropModal();
            }
            
            // Escape to close modals
            if (e.key === 'Escape') {
                const activeModal = document.querySelector('.modal.active');
                if (activeModal) {
                    closeModal(activeModal.id);
                }
            }
        });

        // Enhanced window resize handler for responsive adjustments
        window.addEventListener('resize', () => {
            // Adjust mobile navigation if needed
            const isMobile = window.innerWidth <= 768;
            const sidebar = document.querySelector('.sidebar');
            const mobileNav = document.querySelector('.mobile-nav');
            
            if (sidebar && mobileNav) {
                sidebar.style.display = isMobile ? 'none' : 'block';
                mobileNav.style.display = isMobile ? 'block' : 'none';
            }
        });
    </script>
</body>
</html>
